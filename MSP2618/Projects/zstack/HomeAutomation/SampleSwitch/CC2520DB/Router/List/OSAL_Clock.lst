###############################################################################
#                                                                             #
# IAR C/C++ Compiler V5.52.1.50724/W32 for MSP430       10/Jun/2013  16:30:13 #
# Copyright 1996-2013 IAR Systems AB.                                         #
#                                                                             #
#    __rt_version  =  3                                                       #
#    __double_size =  32                                                      #
#    __reg_r4      =  free                                                    #
#    __reg_r5      =  free                                                    #
#    __pic         =  no                                                      #
#    __core        =  430X                                                    #
#    __data_model  =  small                                                   #
#    Source file   =  C:\Texas Instruments\ZStack-MSP2618-2.5.1\Components\os #
#                     al\common\OSAL_Clock.c                                  #
#    Command line  =  -f "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\ #
#                     zstack\HomeAutomation\SampleSwitch\CC2520DB\..\..\..\To #
#                     ols\MSP2618\f8wConfig.cfg" (-DZIGBEEPRO -DSECURE=0      #
#                     -DZG_SECURE_DYNAMIC=0 -DREFLECTOR                       #
#                     -DDEFAULT_CHANLIST=0x00000800                           #
#                     -DZDAPP_CONFIG_PAN_ID=0xFFFF -DNWK_START_DELAY=100      #
#                     -DEXTENDED_JOINING_RANDOM_MASK=0x007F                   #
#                     -DBEACON_REQUEST_DELAY=100                              #
#                     -DBEACON_REQ_DELAY_MASK=0x00FF                          #
#                     -DLINK_STATUS_JITTER_MASK=0x007F                        #
#                     -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_POLLED= #
#                     3000 -DNWK_INDIRECT_MSG_TIMEOUT=7 -DMAX_RREQ_ENTRIES=8  #
#                     -DAPSC_MAX_FRAME_RETRIES=3 -DNWK_MAX_DATA_RETRIES=2     #
#                     -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9              #
#                     -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40                #
#                     -DNWK_MAX_BINDING_ENTRIES=4                             #
#                     -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,       #
#                     0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00, 0x02,   #
#                     0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"                    #
#                     -DMAC_MAX_FRAME_SIZE=116 -DZDNWKMGR_MIN_TRANSMISSIONS=2 #
#                     0 -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=1000           #
#                     -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100         #
#                     -DREJOIN_POLL_RATE=440) -f "C:\Texas                    #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\Tools\MSP2618\f #
#                     8wRouter.cfg" (-DCPU6MHZ -DMAC_CFG_APP_PENDING_QUEUE=TR #
#                     UE -DMAC_CFG_TX_DATA_MAX=5 -DMAC_CFG_TX_MAX=8           #
#                     -DMAC_CFG_RX_MAX=5 -DRTR_NWK) -f "C:\Texas              #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\Tools\MSP2618\f #
#                     8wZCL.cfg" (-DZCL_READ -DZCL_WRITE -DZCL_BASIC          #
#                     -DZCL_IDENTIFY -DZCL_ON_OFF -DZCL_KEY_ESTABLISH         #
#                     -DZCL_KEY_ESTABLISHMENT_KEY_GENERATE_TIMEOUT=4          #
#                     -DZCL_KEY_ESTABLISHMENT_MAC_GENERATE_TIMEOUT=10         #
#                     -DZCL_KEY_ESTABLISHMENT_EKEY_GENERATE_TIMEOUT=10        #
#                     -DZCL_LOAD_CONTROL -DZCL_SIMPLE_METERING -DZCL_PRICING  #
#                     -DZCL_MESSAGE -DZCL_TUNNELING -DZCL_TOU)                #
#                     -DZCL_DEVICE_MGMT "C:\Texas                             #
#                     Instruments\ZStack-MSP2618-2.5.1\Components\osal\common #
#                     \OSAL_Clock.c" -D MSP430F2618 -D ZTOOL_P1 -D MT_TASK    #
#                     -D MT_SYS_FUNC -D MT_ZDO_FUNC -D LCD_SUPPORTED -lC      #
#                     "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zst #
#                     ack\HomeAutomation\SampleSwitch\CC2520DB\Router\List\"  #
#                     -lA "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects #
#                     \zstack\HomeAutomation\SampleSwitch\CC2520DB\Router\Lis #
#                     t\" --remarks --diag_suppress Pe001,Pe193,Pe236,Pe826   #
#                     -o "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\ #
#                     zstack\HomeAutomation\SampleSwitch\CC2520DB\Router\Obj\ #
#                     " --debug -D__MSP430F2618__ -e --double=32 --clib -I    #
#                     "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zst #
#                     ack\HomeAutomation\SampleSwitch\CC2520DB\" -I           #
#                     "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zst #
#                     ack\HomeAutomation\SampleSwitch\CC2520DB\..\Source\"    #
#                     -I "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\ #
#                     zstack\HomeAutomation\SampleSwitch\CC2520DB\..\..\Sourc #
#                     e\" -I "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Proje #
#                     cts\zstack\HomeAutomation\SampleSwitch\CC2520DB\..\..\. #
#                     .\ZMain\MSP2618\" -I "C:\Texas                          #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\hal\include\" -I "C:\Texas                            #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\hal\target\MSP2618CC2520\" -I "C:\Texas               #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\mac\include\" -I "C:\Texas                            #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\mac\high_level\" -I "C:\Texas                         #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\mac\low_level\srf04\" -I "C:\Texas                    #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\mac\low_level\srf04\dual_chip\" -I "C:\Texas          #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\mt\" -I "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Pr #
#                     ojects\zstack\HomeAutomation\SampleSwitch\CC2520DB\..\. #
#                     .\..\..\..\Components\osal\include\" -I "C:\Texas       #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\osal\mcu\msp430\" -I "C:\Texas                        #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\services\saddr\" -I "C:\Texas                         #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\services\sdata\" -I "C:\Texas                         #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\stack\af\" -I "C:\Texas Instruments\ZStack-MSP2618-2. #
#                     5.1\Projects\zstack\HomeAutomation\SampleSwitch\CC2520D #
#                     B\..\..\..\..\..\Components\stack\nwk\" -I "C:\Texas    #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\stack\sec\" -I "C:\Texas                              #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\stack\sapi\" -I "C:\Texas                             #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\stack\sys\" -I "C:\Texas                              #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\stack\zcl\" -I "C:\Texas                              #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\stack\zdo\" -I "C:\Texas                              #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\zmac\" -I "C:\Texas Instruments\ZStack-MSP2618-2.5.1\ #
#                     Projects\zstack\HomeAutomation\SampleSwitch\CC2520DB\.. #
#                     \..\..\..\..\Components\zmac\f8w\" --core=430X          #
#                     --data_model=small -Ohz --multiplier=16s                #
#                     --require_prototypes                                    #
#    List file     =  C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zsta #
#                     ck\HomeAutomation\SampleSwitch\CC2520DB\Router\List\OSA #
#                     L_Clock.lst                                             #
#    Object file   =  C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zsta #
#                     ck\HomeAutomation\SampleSwitch\CC2520DB\Router\Obj\OSAL #
#                     _Clock.r43                                              #
#                                                                             #
#                                                                             #
###############################################################################

C:\Texas Instruments\ZStack-MSP2618-2.5.1\Components\osal\common\OSAL_Clock.c
      1          /******************************************************************************
      2            Filename:       OSAL_Clock.c
      3            Revised:        $Date: 2012-03-02 15:52:01 -0800 (Fri, 02 Mar 2012) $
      4            Revision:       $Revision: 29608 $
      5          
      6            Description:    OSAL Clock definition and manipulation functions.
      7          
      8            Copyright 2008-2012 Texas Instruments Incorporated. All rights reserved.
      9          
     10            IMPORTANT: Your use of this Software is limited to those specific rights
     11            granted under the terms of a software license agreement between the user
     12            who downloaded the software, his/her employer (which must be your employer)
     13            and Texas Instruments Incorporated (the "License"). You may not use this
     14            Software unless you agree to abide by the terms of the License. The License
     15            limits your use, and you acknowledge, that the Software may not be modified,
     16            copied or distributed unless embedded on a Texas Instruments microcontroller
     17            or used solely and exclusively in conjunction with a Texas Instruments radio
     18            frequency transceiver, which is integrated into your product. Other than for
     19            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     20            works of, modify, distribute, perform, display or sell this Software and/or
     21            its documentation for any purpose.
     22          
     23            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     24            PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     25            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     26            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     27            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     28            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     29            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     30            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     31            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     32            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     33            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     34          
     35            Should you have any questions regarding your right to use this Software,
     36            contact Texas Instruments Incorporated at www.TI.com.
     37          ******************************************************************************/
     38          
     39          /*********************************************************************
     40           * INCLUDES
     41           */
     42          
     43          #include "comdef.h"
     44          #include "OnBoard.h"
     45          #include "OSAL.h"
     46          #include "OSAL_Clock.h"
     47          
     48          /*********************************************************************
     49           * MACROS
     50           */
     51          
     52          #define	YearLength(yr)	((uint16)(IsLeapYear(yr) ? 366 : 365))
     53          
     54          /*********************************************************************
     55           * CONSTANTS
     56           */
     57          
     58          #define	BEGYEAR  2000     //  UTC started at 00:00:00 January 1, 2000
     59          
     60          #define	DAY      86400UL  // 24 hours * 60 minutes * 60 seconds
     61          
     62          /*********************************************************************
     63           * TYPEDEFS
     64           */
     65          
     66          /*********************************************************************
     67           * GLOBAL VARIABLES
     68           */
     69          
     70          /*********************************************************************
     71           * EXTERNAL VARIABLES
     72           */
     73          
     74          /*********************************************************************
     75           * EXTERNAL FUNCTIONS
     76           */
     77          extern uint32 macMcuPrecisionCount(void);
     78          
     79          #if (defined HAL_MCU_CC2430) || (defined HAL_MCU_CC2530) || (defined HAL_MCU_CC2533)
     80          
     81            /*  This function is used to divide a 31 bit dividend by a 16 bit
     82             *  divisor and return a packed 16 bit quotient and 16 bit
     83             *  remainder.
     84             *
     85             *  Note: This routine takes ~25.6us @32MHz. With C overhead, the
     86             *        time is ~32us.
     87             *
     88             *  dividend - 31 bit dividend.
     89             *  divisor - 16 bit divisor.
     90             *
     91             *  return - MSW divisor; LSW quotient
     92             */
     93            extern __near_func uint32 osalMcuDivide31By16To16( uint32 dividend, uint16 divisor );
     94          
     95            #define CONVERT_320US_TO_MS_ELAPSED_REMAINDER( x, y, z ) st( \
     96                                                                         \
     97              /* The 16 bit quotient is in MSW and */                    \
     98              /* the 16 bit remainder is in LSW. */                      \
     99              x = osalMcuDivide31By16To16( x, 25 );                      \
    100                                                                         \
    101              /* Add quotient to y */                                    \
    102              y += (x >> 16);                                            \
    103                                                                         \
    104              /* Copy remainder to z */                                  \
    105              z = (uint16)(x & 0x0FFFF);                                 \
    106            )
    107          
    108          #else /* (defined HAL_MCU_CC2430) || (defined HAL_MCU_CC2530) || (defined HAL_MCU_CC2533) */
    109          
    110            #define CONVERT_320US_TO_MS_ELAPSED_REMAINDER( x, y, z ) st( \
    111              y += x / 25;                                               \
    112              z = x % 25;                                                \
    113            )
    114          
    115          #endif /* (defined HAL_MCU_CC2430) || (defined HAL_MCU_CC2530) || (defined HAL_MCU_CC2533) */
    116          
    117          /*********************************************************************
    118           * LOCAL VARIABLES
    119           */

   \                                 In  segment DATA16_Z, align 2, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
    120          static uint32 previousMacTimerTick = 0;
   \                     previousMacTimerTick:
   \   000000                DS8 4

   \                                 In  segment DATA16_Z, align 2, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
    121          static uint16 remUsTicks = 0;
   \                     remUsTicks:
   \   000000                DS8 2

   \                                 In  segment DATA16_Z, align 2, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
    122          static uint16 timeMSec = 0;
   \                     timeMSec:
   \   000000                DS8 2
    123          
    124          // number of seconds since 0 hrs, 0 minutes, 0 seconds, on the
    125          // 1st of January 2000 UTC

   \                                 In  segment DATA16_Z, align 2, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
    126          UTCTime OSAL_timeSeconds = 0;
   \                     OSAL_timeSeconds:
   \   000000                DS8 4
    127          
    128          /*********************************************************************
    129           * LOCAL FUNCTION PROTOTYPES
    130           */
    131          static uint8 monthLength( uint8 lpyr, uint8 mon );
    132          
    133          static void osalClockUpdate( uint16 elapsedMSec );
    134          
    135          /*********************************************************************
    136           * FUNCTIONS
    137           *********************************************************************/
    138          
    139          /*********************************************************************
    140           * @fn      osalTimeUpdate
    141           *
    142           * @brief   Uses the free running rollover count of the MAC backoff timer;
    143           *          this timer runs freely with a constant 320 usec interval.  The
    144           *          count of 320-usec ticks is converted to msecs and used to update
    145           *          the OSAL clock and Timers by invoking osalClockUpdate() and
    146           *          osalTimerUpdate().  This function is intended to be invoked
    147           *          from the background, not interrupt level.
    148           *
    149           * @param   None.
    150           *
    151           * @return  None.
    152           */

   \                                 In  segment CODE, align 2
    153          void osalTimeUpdate( void )
   \                     osalTimeUpdate:
    154          {
   \   000000   2A15         PUSHM.W #0x3, R10
    155            halIntState_t intState;
    156            uint32 tmp;
    157            uint32 ticks320us;
    158            uint16 elapsedMSec = 0;
    159          
    160            HAL_ENTER_CRITICAL_SECTION(intState);
   \   000002   0A42         MOV.W   SR, R10
   \   000004   32C2         dint
   \   000006   0343         nop
    161            // Get the free-running count of 320us timer ticks
    162            tmp = macMcuPrecisionCount();
   \   000008   ........     CALLA   #macMcuPrecisionCount
   \   00000C   084C         MOV.W   R12, R8
   \   00000E   094D         MOV.W   R13, R9
    163            HAL_EXIT_CRITICAL_SECTION(intState);
   \   000010   024A         MOV.W   R10, SR
    164            
    165            if ( tmp != previousMacTimerTick )
   \   000012   1C92....     CMP.W   &previousMacTimerTick, R12
   \   000016   0320         JNE     ??osalTimeUpdate_0
   \   000018   1D92....     CMP.W   &previousMacTimerTick + 2, R13
   \   00001C   3624         JEQ     ??osalTimeUpdate_1
    166            {
    167              // Calculate the elapsed ticks of the free-running timer.
    168              ticks320us = (tmp - previousMacTimerTick) & 0xffffffffu;
   \                     ??osalTimeUpdate_0:
   \   00001E   1C82....     SUB.W   &previousMacTimerTick, R12
   \   000022   1D72....     SUBC.W  &previousMacTimerTick + 2, R13
    169          
    170              // Store the MAC Timer tick count for the next time through this function.
    171              previousMacTimerTick = tmp;
   \   000026   8248....     MOV.W   R8, &previousMacTimerTick
   \   00002A   8249....     MOV.W   R9, &previousMacTimerTick + 2
    172              
    173              // update converted number with remaining ticks from loop and the
    174              // accumulated remainder from loop
    175              tmp = (ticks320us * 8) + remUsTicks;
   \   00002E   ........     CALLA   #?ShiftLeft32_3
   \   000032   084C         MOV.W   R12, R8
   \   000034   094D         MOV.W   R13, R9
   \   000036   1E42....     MOV.W   &remUsTicks, R14
   \   00003A   0F43         MOV.W   #0x0, R15
   \   00003C   085E         ADD.W   R14, R8
   \   00003E   0963         ADDC.W  #0x0, R9
    176          
    177              // Convert the 320 us ticks into milliseconds and a remainder
    178              CONVERT_320US_TO_MS_ELAPSED_REMAINDER( tmp, elapsedMSec, remUsTicks );
   \   000040   0C48         MOV.W   R8, R12
   \   000042   0D49         MOV.W   R9, R13
   \   000044   3E401900     MOV.W   #0x19, R14
   \   000048   ........     CALLA   #?DivMod32u
   \   00004C   0A4C         MOV.W   R12, R10
   \   00004E   0C48         MOV.W   R8, R12
   \   000050   0D49         MOV.W   R9, R13
   \   000052   3E401900     MOV.W   #0x19, R14
   \   000056   ........     CALLA   #??Subroutine2_0
   \                     ??CrossCallReturnLabel_18:
   \   00005A   824E....     MOV.W   R14, &remUsTicks
    179          
    180              // Update OSAL Clock and Timers
    181              if ( elapsedMSec )
   \   00005E   0A93         CMP.W   #0x0, R10
   \   000060   1424         JEQ     ??osalTimeUpdate_1
    182              {
    183                osalClockUpdate( elapsedMSec );
   \   000062   084A         MOV.W   R10, R8
   \   000064   1852....     ADD.W   &timeMSec, R8
   \   000068   3890E803     CMP.W   #0x3e8, R8
   \   00006C   0928         JNC     ??osalTimeUpdate_2
   \   00006E   ........     CALLA   #?Subroutine4
   \                     ??CrossCallReturnLabel_0:
   \   000072   825C....     ADD.W   R12, &OSAL_timeSeconds
   \   000076   8263....     ADDC.W  #0x0, &OSAL_timeSeconds + 2
   \   00007A   ........     CALLA   #?Subroutine4
   \                     ??CrossCallReturnLabel_1:
   \   00007E   084E         MOV.W   R14, R8
   \                     ??osalTimeUpdate_2:
   \   000080   8248....     MOV.W   R8, &timeMSec
    184                osalTimerUpdate( elapsedMSec );
   \   000084   0C4A         MOV.W   R10, R12
   \   000086   ........     CALLA   #osalTimerUpdate
    185              }
    186            }
    187          }
   \                     ??osalTimeUpdate_1:
   \   00008A   2817         POPM.W  #0x3, R10
   \   00008C   1001         RETA

   \                                 In  segment CODE, align 2
   \                     ??Subroutine2_0:
   \   000000   0F43         MOV.W   #0x0, R15
   \   000002   ........     BRA     #?DivMod32u
    188          
    189          /*********************************************************************
    190           * @fn      osalClockUpdate
    191           *
    192           * @brief   Updates the OSAL Clock time with elapsed milliseconds.
    193           *
    194           * @param   elapsedMSec - elapsed milliseconds
    195           *
    196           * @return  none
    197           */
    198          static void osalClockUpdate( uint16 elapsedMSec )
    199          {
    200            // Add elapsed milliseconds to the saved millisecond portion of time
    201            timeMSec += elapsedMSec;
    202          
    203            // Roll up milliseconds to the number of seconds
    204            if ( timeMSec >= 1000 )
    205            {
    206              OSAL_timeSeconds += timeMSec / 1000;
    207              timeMSec = timeMSec % 1000;
    208            }
    209          }
    210          
    211          /*********************************************************************
    212           * @fn      osal_setClock
    213           *
    214           * @brief   Set the new time.  This will only set the seconds portion
    215           *          of time and doesn't change the factional second counter.
    216           *
    217           * @param   newTime - number of seconds since 0 hrs, 0 minutes,
    218           *                    0 seconds, on the 1st of January 2000 UTC
    219           *
    220           * @return  none
    221           */

   \                                 In  segment CODE, align 2
    222          void osal_setClock( UTCTime newTime )
   \                     osal_setClock:
    223          {
    224            OSAL_timeSeconds = newTime;
   \   000000   824C....     MOV.W   R12, &OSAL_timeSeconds
   \   000004   824D....     MOV.W   R13, &OSAL_timeSeconds + 2
    225          }
   \   000008   1001         RETA
    226          
    227          /*********************************************************************
    228           * @fn      osal_getClock
    229           *
    230           * @brief   Gets the current time.  This will only return the seconds
    231           *          portion of time and doesn't include the factional second
    232           *          counter.
    233           *
    234           * @param   none
    235           *
    236           * @return  number of seconds since 0 hrs, 0 minutes, 0 seconds,
    237           *          on the 1st of January 2000 UTC
    238           */

   \                                 In  segment CODE, align 2
    239          UTCTime osal_getClock( void )
   \                     osal_getClock:
    240          {
    241            return ( OSAL_timeSeconds );
   \   000000   1C42....     MOV.W   &OSAL_timeSeconds, R12
   \   000004   1D42....     MOV.W   &OSAL_timeSeconds + 2, R13
   \   000008   1001         RETA
    242          }
    243          
    244          /*********************************************************************
    245           * @fn      osal_ConvertUTCTime
    246           *
    247           * @brief   Converts UTCTime to UTCTimeStruct
    248           *
    249           * @param   tm - pointer to breakdown struct
    250           *
    251           * @param   secTime - number of seconds since 0 hrs, 0 minutes,
    252           *          0 seconds, on the 1st of January 2000 UTC
    253           *
    254           * @return  none
    255           */

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine2:
   \   000000   0C4E         MOV.W   R14, R12
   \   000002   0D4F         MOV.W   R15, R13
   \   000004   3E403C00     MOV.W   #0x3c, R14
   \   000008                REQUIRE ??Subroutine2_0
   \   000008                // Fall through to label ??Subroutine2_0

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine7:
   \   000000   ........     CALLA   #?DivMod16u
   \   000004   0E93         CMP.W   #0x0, R14
   \   000006   1001         RETA

   \                                 In  segment CODE, align 2, keep-with-next
    256          void osal_ConvertUTCTime( UTCTimeStruct *tm, UTCTime secTime )
   \                     osal_ConvertUTCTime:
    257          {
   \   000000   5B15         PUSHM.W #0x6, R11
   \   000002   0A4C         MOV.W   R12, R10
   \   000004   084E         MOV.W   R14, R8
   \   000006   094F         MOV.W   R15, R9
    258            // calculate the time less than a day - hours, minutes, seconds
    259            {
    260              uint32 day = secTime % DAY;
   \   000008   0C4E         MOV.W   R14, R12
   \   00000A   0D4F         MOV.W   R15, R13
   \   00000C   ........     CALLA   #?Subroutine5
   \                     ??CrossCallReturnLabel_2:
   \   000010   064E         MOV.W   R14, R6
   \   000012   074F         MOV.W   R15, R7
    261              tm->seconds = day % 60UL;
   \   000014   ........     CALLA   #?Subroutine2
   \                     ??CrossCallReturnLabel_19:
   \   000018   CA4E0000     MOV.B   R14, 0(R10)
    262              tm->minutes = (day % 3600UL) / 60UL;
   \   00001C   0C46         MOV.W   R6, R12
   \   00001E   0D47         MOV.W   R7, R13
   \   000020   3E40100E     MOV.W   #0xe10, R14
   \   000024   ........     CALLA   #??Subroutine2_0
   \                     ??CrossCallReturnLabel_16:
   \   000028   ........     CALLA   #?Subroutine2
   \                     ??CrossCallReturnLabel_20:
   \   00002C   CA4C0100     MOV.B   R12, 0x1(R10)
    263              tm->hour = day / 3600UL;
   \   000030   0C46         MOV.W   R6, R12
   \   000032   0D47         MOV.W   R7, R13
   \   000034   3E40100E     MOV.W   #0xe10, R14
   \   000038   ........     CALLA   #??Subroutine2_0
    264            }
   \                     ??CrossCallReturnLabel_17:
   \   00003C   CA4C0200     MOV.B   R12, 0x2(R10)
    265          
    266            // Fill in the calendar - day, month, year
    267            {
    268              uint16 numDays = secTime / DAY;
   \   000040   0C48         MOV.W   R8, R12
   \   000042   0D49         MOV.W   R9, R13
   \   000044   ........     CALLA   #?Subroutine5
   \                     ??CrossCallReturnLabel_3:
   \   000048   0B4C         MOV.W   R12, R11
    269              tm->year = BEGYEAR;
   \   00004A   3740D007     MOV.W   #0x7d0, R7
   \   00004E   38406400     MOV.W   #0x64, R8
   \   000052   043C         JMP     ??osal_ConvertUTCTime_22
    270              while ( numDays >= YearLength( tm->year ) )
    271              {
    272                numDays -= YearLength( tm->year );
   \                     ??osal_ConvertUTCTime_0:
   \   000054   3F406D01     MOV.W   #0x16d, R15
   \                     ??osal_ConvertUTCTime_1:
   \   000058   0B8F         SUB.W   R15, R11
    273                tm->year++;
   \   00005A   1753         ADD.W   #0x1, R7
   \                     ??osal_ConvertUTCTime_22:
   \   00005C   4947         MOV.B   R7, R9
   \   00005E   79F00300     AND.B   #0x3, R9
   \   000062   ........     CALLA   #?Subroutine6
   \                     ??CrossCallReturnLabel_14:
   \   000066   064E         MOV.W   R14, R6
   \   000068   0E93         CMP.W   #0x0, R14
   \   00006A   0524         JEQ     ??osal_ConvertUTCTime_10
   \   00006C   ........     CALLA   #?Subroutine1
   \                     ??CrossCallReturnLabel_4:
   \   000070   0524         JEQ     ??osal_ConvertUTCTime_11
   \   000072   4993         CMP.B   #0x0, R9
   \   000074   0320         JNE     ??osal_ConvertUTCTime_11
   \                     ??osal_ConvertUTCTime_10:
   \   000076   3F406E01     MOV.W   #0x16e, R15
   \   00007A   023C         JMP     ??osal_ConvertUTCTime_5
   \                     ??osal_ConvertUTCTime_11:
   \   00007C   3F406D01     MOV.W   #0x16d, R15
   \                     ??osal_ConvertUTCTime_5:
   \   000080   0B9F         CMP.W   R15, R11
   \   000082   0A28         JNC     ??osal_ConvertUTCTime_23
   \   000084   0693         CMP.W   #0x0, R6
   \   000086   0524         JEQ     ??osal_ConvertUTCTime_16
   \   000088   ........     CALLA   #?Subroutine1
    274              }
   \                     ??CrossCallReturnLabel_5:
   \   00008C   E327         JEQ     ??osal_ConvertUTCTime_0
   \   00008E   4993         CMP.B   #0x0, R9
   \   000090   E123         JNE     ??osal_ConvertUTCTime_0
   \                     ??osal_ConvertUTCTime_16:
   \   000092   3F406E01     MOV.W   #0x16e, R15
   \   000096   E03F         JMP     ??osal_ConvertUTCTime_1
   \                     ??osal_ConvertUTCTime_23:
   \   000098   8A470600     MOV.W   R7, 0x6(R10)
    275          
    276              tm->month = 0;
   \   00009C   CA430400     MOV.B   #0x0, 0x4(R10)
   \   0000A0   093C         JMP     ??osal_ConvertUTCTime_24
    277              while ( numDays >= monthLength( IsLeapYear( tm->year ), tm->month ) )
    278              {
    279                numDays -= monthLength( IsLeapYear( tm->year ), tm->month );
   \                     ??osal_ConvertUTCTime_2:
   \   0000A2   4C43         MOV.B   #0x0, R12
   \                     ??osal_ConvertUTCTime_3:
   \   0000A4   5D4A0400     MOV.B   0x4(R10), R13
   \   0000A8   ........     CALLA   #monthLength
   \   0000AC   4C4C         MOV.B   R12, R12
   \   0000AE   0B8C         SUB.W   R12, R11
    280                tm->month++;
   \   0000B0   DA530400     ADD.B   #0x1, 0x4(R10)
   \                     ??osal_ConvertUTCTime_24:
   \   0000B4   ........     CALLA   #?Subroutine0
   \                     ??CrossCallReturnLabel_12:
   \   0000B8   0624         JEQ     ??osal_ConvertUTCTime_12
   \   0000BA   ........     CALLA   #?Subroutine1
   \                     ??CrossCallReturnLabel_6:
   \   0000BE   0524         JEQ     ??osal_ConvertUTCTime_13
   \   0000C0   77B00300     BIT.B   #0x3, R7
   \   0000C4   0220         JNE     ??osal_ConvertUTCTime_13
   \                     ??osal_ConvertUTCTime_12:
   \   0000C6   5C43         MOV.B   #0x1, R12
   \   0000C8   013C         JMP     ??osal_ConvertUTCTime_8
   \                     ??osal_ConvertUTCTime_13:
   \   0000CA   4C43         MOV.B   #0x0, R12
   \                     ??osal_ConvertUTCTime_8:
   \   0000CC   5D4A0400     MOV.B   0x4(R10), R13
   \   0000D0   ........     CALLA   #monthLength
   \   0000D4   4C4C         MOV.B   R12, R12
   \   0000D6   0B9C         CMP.W   R12, R11
   \   0000D8   0B28         JNC     ??osal_ConvertUTCTime_25
   \   0000DA   ........     CALLA   #?Subroutine0
    281              }
   \                     ??CrossCallReturnLabel_13:
   \   0000DE   0624         JEQ     ??osal_ConvertUTCTime_20
   \   0000E0   ........     CALLA   #?Subroutine1
   \                     ??CrossCallReturnLabel_7:
   \   0000E4   DE27         JEQ     ??osal_ConvertUTCTime_2
   \   0000E6   77B00300     BIT.B   #0x3, R7
   \   0000EA   DB23         JNE     ??osal_ConvertUTCTime_2
   \                     ??osal_ConvertUTCTime_20:
   \   0000EC   5C43         MOV.B   #0x1, R12
   \   0000EE   DA3F         JMP     ??osal_ConvertUTCTime_3
    282          
    283              tm->day = numDays;
   \                     ??osal_ConvertUTCTime_25:
   \   0000F0   CA4B0300     MOV.B   R11, 0x3(R10)
    284            }
    285          }
   \   0000F4   5617         POPM.W  #0x6, R11
   \   0000F6   1001         RETA

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine5:
   \   000000   3E408051     MOV.W   #0x5180, R14
   \   000004   1F43         MOV.W   #0x1, R15
   \   000006   ........     BRA     #?DivMod32u

   \                                 In  segment CODE, align 2
   \                     ?Subroutine1:
   \   000000   0C47         MOV.W   R7, R12
   \   000002   0E48         MOV.W   R8, R14
   \   000004   ....         JMP     ?Subroutine7

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine0:
   \   000000   174A0600     MOV.W   0x6(R10), R7
   \   000004                REQUIRE ??Subroutine0_0
   \   000004                // Fall through to label ??Subroutine0_0

   \                                 In  segment CODE, align 2
   \                     ??Subroutine0_0:
   \   000000   ........     CALLA   #?Subroutine6
   \                     ??CrossCallReturnLabel_15:
   \   000004   0E93         CMP.W   #0x0, R14
   \   000006   1001         RETA

   \                                 In  segment CODE, align 2
   \                     ?Subroutine6:
   \   000000   0C47         MOV.W   R7, R12
   \   000002   3E409001     MOV.W   #0x190, R14
   \   000006   ........     BRA     #?DivMod16u
    286          
    287          /*********************************************************************
    288           * @fn      monthLength
    289           *
    290           * @param   lpyr - 1 for leap year, 0 if not
    291           *
    292           * @param   mon - 0 - 11 (jan - dec)
    293           *
    294           * @return  number of days in specified month
    295           */

   \                                 In  segment CODE, align 2, keep-with-next
    296          static uint8 monthLength( uint8 lpyr, uint8 mon )
   \                     monthLength:
    297          {
    298            uint8 days = 31;
   \   000000   7E401F00     MOV.B   #0x1f, R14
    299          
    300          	if ( mon == 1 ) // feb
   \   000004   5D93         CMP.B   #0x1, R13
   \   000006   0420         JNE     ??monthLength_0
    301            {
    302          		days = ( 28 + lpyr );
   \   000008   7C501C00     ADD.B   #0x1c, R12
   \   00000C   4E4C         MOV.B   R12, R14
   \   00000E   083C         JMP     ??monthLength_1
    303            }
    304            else
    305            {
    306              if ( mon > 6 ) // aug-dec
   \                     ??monthLength_0:
   \   000010   7D900700     CMP.B   #0x7, R13
   \   000014   0128         JNC     ??monthLength_2
    307              {
    308                mon--;
   \   000016   7D53         ADD.B   #0xff, R13
    309              }
    310          
    311              if ( mon & 1 )
   \                     ??monthLength_2:
   \   000018   5DB3         BIT.B   #0x1, R13
   \   00001A   0228         JNC     ??monthLength_1
    312              {
    313                days = 30;
   \   00001C   7E401E00     MOV.B   #0x1e, R14
    314              }
    315            }
    316          
    317          	return ( days );
   \                     ??monthLength_1:
   \   000020   4C4E         MOV.B   R14, R12
   \   000022   1001         RETA
    318          }
    319          
    320          /*********************************************************************
    321           * @fn      osal_ConvertUTCSecs
    322           *
    323           * @brief   Converts a UTCTimeStruct to UTCTime
    324           *
    325           * @param   tm - pointer to provided struct
    326           *
    327           * @return  number of seconds since 00:00:00 on 01/01/2000 (UTC)
    328           */

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine3:
   \   000000   0C47         MOV.W   R7, R12
   \   000002   3E406400     MOV.W   #0x64, R14
   \   000006                REQUIRE ?Subroutine7
   \   000006                // Fall through to label ?Subroutine7

   \                                 In  segment CODE, align 2
    329          UTCTime osal_ConvertUTCSecs( UTCTimeStruct *tm )
   \                     osal_ConvertUTCSecs:
    330          {
   \   000000   5B15         PUSHM.W #0x6, R11
   \   000002   0A4C         MOV.W   R12, R10
    331            uint32 seconds;
    332          
    333            /* Seconds for the partial day */
    334            seconds = (((tm->hour * 60UL) + tm->minutes) * 60UL) + tm->seconds;
   \   000004   5C4A0200     MOV.B   0x2(R10), R12
   \   000008   0D43         MOV.W   #0x0, R13
   \   00000A   3E403C00     MOV.W   #0x3c, R14
   \   00000E   0F43         MOV.W   #0x0, R15
   \   000010   ........     CALLA   #?Mul32
   \   000014   5E4A0100     MOV.B   0x1(R10), R14
   \   000018   0F43         MOV.W   #0x0, R15
   \   00001A   0C5E         ADD.W   R14, R12
   \   00001C   0D63         ADDC.W  #0x0, R13
   \   00001E   3E403C00     MOV.W   #0x3c, R14
   \   000022   ........     CALLA   #?Mul32
   \   000026   084C         MOV.W   R12, R8
   \   000028   094D         MOV.W   R13, R9
   \   00002A   6E4A         MOV.B   @R10, R14
   \   00002C   085E         ADD.W   R14, R8
   \   00002E   0963         ADDC.W  #0x0, R9
    335          
    336            /* Account for previous complete days */
    337            {
    338              /* Start with complete days in current month */
    339              uint16 days = tm->day;
   \   000030   5B4A0300     MOV.B   0x3(R10), R11
    340          
    341              /* Next, complete months in current year */
    342              {
    343                int8 month = tm->month;
   \   000034   564A0400     MOV.B   0x4(R10), R6
   \   000038   063C         JMP     ??osal_ConvertUTCSecs_14
    344                while ( --month >= 0 )
    345                {
    346                  days += monthLength( IsLeapYear( tm->year ), month );
   \                     ??osal_ConvertUTCSecs_0:
   \   00003A   4C43         MOV.B   #0x0, R12
   \                     ??osal_ConvertUTCSecs_1:
   \   00003C   4D46         MOV.B   R6, R13
   \   00003E   ........     CALLA   #monthLength
   \   000042   4C4C         MOV.B   R12, R12
   \   000044   0B5C         ADD.W   R12, R11
   \                     ??osal_ConvertUTCSecs_14:
   \   000046   7653         ADD.B   #0xff, R6
   \   000048   174A0600     MOV.W   0x6(R10), R7
   \   00004C   4693         CMP.B   #0x0, R6
   \   00004E   0E38         JL      ??osal_ConvertUTCSecs_5
   \   000050   ........     CALLA   #??Subroutine0_0
    347                }
    348              }
   \                     ??CrossCallReturnLabel_10:
   \   000054   0624         JEQ     ??osal_ConvertUTCSecs_9
   \   000056   ........     CALLA   #?Subroutine3
   \                     ??CrossCallReturnLabel_8:
   \   00005A   EF27         JEQ     ??osal_ConvertUTCSecs_0
   \   00005C   77B00300     BIT.B   #0x3, R7
   \   000060   EC23         JNE     ??osal_ConvertUTCSecs_0
   \                     ??osal_ConvertUTCSecs_9:
   \   000062   5C43         MOV.B   #0x1, R12
   \   000064   EB3F         JMP     ??osal_ConvertUTCSecs_1
    349          
    350              /* Next, complete years before current year */
    351              {
    352                uint16 year = tm->year;
    353                while ( --year >= BEGYEAR )
    354                {
    355                  days += YearLength( year );
   \                     ??osal_ConvertUTCSecs_2:
   \   000066   3F406D01     MOV.W   #0x16d, R15
   \                     ??osal_ConvertUTCSecs_3:
   \   00006A   0B5F         ADD.W   R15, R11
   \                     ??osal_ConvertUTCSecs_5:
   \   00006C   3753         ADD.W   #0xffff, R7
   \   00006E   3790D007     CMP.W   #0x7d0, R7
   \   000072   0C28         JNC     ??osal_ConvertUTCSecs_15
   \   000074   ........     CALLA   #??Subroutine0_0
    356                }
    357              }
   \                     ??CrossCallReturnLabel_11:
   \   000078   0624         JEQ     ??osal_ConvertUTCSecs_12
   \   00007A   ........     CALLA   #?Subroutine3
   \                     ??CrossCallReturnLabel_9:
   \   00007E   F327         JEQ     ??osal_ConvertUTCSecs_2
   \   000080   77B00300     BIT.B   #0x3, R7
   \   000084   F023         JNE     ??osal_ConvertUTCSecs_2
   \                     ??osal_ConvertUTCSecs_12:
   \   000086   3F406E01     MOV.W   #0x16e, R15
   \   00008A   EF3F         JMP     ??osal_ConvertUTCSecs_3
    358          
    359              /* Add total seconds before partial day */
    360              seconds += (days * DAY);
    361            }
    362          
    363            return ( seconds );
   \                     ??osal_ConvertUTCSecs_15:
   \   00008C   0C4B         MOV.W   R11, R12
   \   00008E   0D43         MOV.W   #0x0, R13
   \   000090   3E408051     MOV.W   #0x5180, R14
   \   000094   1F43         MOV.W   #0x1, R15
   \   000096   ........     CALLA   #?Mul32
   \   00009A   085C         ADD.W   R12, R8
   \   00009C   096D         ADDC.W  R13, R9
   \   00009E   0C48         MOV.W   R8, R12
   \   0000A0   0D49         MOV.W   R9, R13
   \   0000A2   5617         POPM.W  #0x6, R11
   \   0000A4   1001         RETA
    364          }

   \                                 In  segment CODE, align 2
   \                     ?Subroutine4:
   \   000000   0C48         MOV.W   R8, R12
   \   000002   3E40E803     MOV.W   #0x3e8, R14
   \   000006   ........     BRA     #?DivMod16u

   Maximum stack usage in bytes:

   CSTACK Function
   ------ --------
      4   monthLength
     10   osalTimeUpdate
       10   -> macMcuPrecisionCount
       10   -> osalTimerUpdate
     16   osal_ConvertUTCSecs
       16   -> monthLength
     16   osal_ConvertUTCTime
       16   -> monthLength
      4   osal_getClock
      4   osal_setClock


   Segment part sizes:

   Bytes  Function/Label
   -----  --------------
       8  ??Subroutine0_0
       6  ??Subroutine2_0
       4  ?Subroutine0
       6  ?Subroutine1
       8  ?Subroutine2
       6  ?Subroutine3
      10  ?Subroutine4
      10  ?Subroutine5
      10  ?Subroutine6
       8  ?Subroutine7
       4  OSAL_timeSeconds
      36  monthLength
     142  osalTimeUpdate
     166  osal_ConvertUTCSecs
     248  osal_ConvertUTCTime
      10  osal_getClock
      10  osal_setClock
       4  previousMacTimerTick
       2  remUsTicks
       2  timeMSec

 
 688 bytes in segment CODE
  12 bytes in segment DATA16_Z
 
 688 bytes of CODE memory
  12 bytes of DATA memory

Errors: none
Warnings: none
