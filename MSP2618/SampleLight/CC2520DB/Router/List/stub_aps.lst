###############################################################################
#                                                                             #
# IAR C/C++ Compiler V5.52.1.50724/W32 for MSP430       10/Jun/2013  16:27:34 #
# Copyright 1996-2013 IAR Systems AB.                                         #
#                                                                             #
#    __rt_version  =  3                                                       #
#    __double_size =  32                                                      #
#    __reg_r4      =  free                                                    #
#    __reg_r5      =  free                                                    #
#    __pic         =  no                                                      #
#    __core        =  430X                                                    #
#    __data_model  =  small                                                   #
#    Source file   =  C:\Texas Instruments\ZStack-MSP2618-2.5.1\Components\st #
#                     ack\nwk\stub_aps.c                                      #
#    Command line  =  -f "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\ #
#                     zstack\HomeAutomation\SampleLight\CC2520DB\..\..\..\Too #
#                     ls\MSP2618\f8wConfig.cfg" (-DZIGBEEPRO -DSECURE=0       #
#                     -DZG_SECURE_DYNAMIC=0 -DREFLECTOR                       #
#                     -DDEFAULT_CHANLIST=0x00000800                           #
#                     -DZDAPP_CONFIG_PAN_ID=0xFFFF -DNWK_START_DELAY=100      #
#                     -DEXTENDED_JOINING_RANDOM_MASK=0x007F                   #
#                     -DBEACON_REQUEST_DELAY=100                              #
#                     -DBEACON_REQ_DELAY_MASK=0x00FF                          #
#                     -DLINK_STATUS_JITTER_MASK=0x007F                        #
#                     -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_POLLED= #
#                     3000 -DNWK_INDIRECT_MSG_TIMEOUT=7 -DMAX_RREQ_ENTRIES=8  #
#                     -DAPSC_MAX_FRAME_RETRIES=3 -DNWK_MAX_DATA_RETRIES=2     #
#                     -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9              #
#                     -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40                #
#                     -DNWK_MAX_BINDING_ENTRIES=4                             #
#                     -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,       #
#                     0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00, 0x02,   #
#                     0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"                    #
#                     -DMAC_MAX_FRAME_SIZE=116 -DZDNWKMGR_MIN_TRANSMISSIONS=2 #
#                     0 -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=1000           #
#                     -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100         #
#                     -DREJOIN_POLL_RATE=440) -f "C:\Texas                    #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\Tools\MSP2618\f8 #
#                     wRouter.cfg" (-DCPU6MHZ -DMAC_CFG_APP_PENDING_QUEUE=TRU #
#                     E -DMAC_CFG_TX_DATA_MAX=5 -DMAC_CFG_TX_MAX=8            #
#                     -DMAC_CFG_RX_MAX=5 -DRTR_NWK) -f "C:\Texas              #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\Tools\MSP2618\f8 #
#                     wZCL.cfg" (-DZCL_READ -DZCL_WRITE -DZCL_BASIC           #
#                     -DZCL_IDENTIFY -DZCL_ON_OFF -DZCL_KEY_ESTABLISH         #
#                     -DZCL_KEY_ESTABLISHMENT_KEY_GENERATE_TIMEOUT=4          #
#                     -DZCL_KEY_ESTABLISHMENT_MAC_GENERATE_TIMEOUT=10         #
#                     -DZCL_KEY_ESTABLISHMENT_EKEY_GENERATE_TIMEOUT=10        #
#                     -DZCL_LOAD_CONTROL -DZCL_SIMPLE_METERING -DZCL_PRICING  #
#                     -DZCL_MESSAGE -DZCL_TUNNELING -DZCL_TOU)                #
#                     -DZCL_DEVICE_MGMT "C:\Texas                             #
#                     Instruments\ZStack-MSP2618-2.5.1\Components\stack\nwk\s #
#                     tub_aps.c" -D MSP430F2618 -D ZTOOL_P1 -D MT_TASK -D     #
#                     MT_SYS_FUNC -D MT_ZDO_FUNC -D LCD_SUPPORTED -lC         #
#                     "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zst #
#                     ack\HomeAutomation\SampleLight\CC2520DB\Router\List\"   #
#                     -lA "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects #
#                     \zstack\HomeAutomation\SampleLight\CC2520DB\Router\List #
#                     \" --remarks --diag_suppress Pe001,Pe193,Pe236,Pe826    #
#                     -o "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\ #
#                     zstack\HomeAutomation\SampleLight\CC2520DB\Router\Obj\" #
#                      --debug -D__MSP430F2618__ -e --double=32 --clib -I     #
#                     "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zst #
#                     ack\HomeAutomation\SampleLight\CC2520DB\" -I "C:\Texas  #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\Source\" -I "C:\Texas  #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\Source\" -I         #
#                     "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zst #
#                     ack\HomeAutomation\SampleLight\CC2520DB\..\..\..\ZMain\ #
#                     MSP2618\" -I "C:\Texas Instruments\ZStack-MSP2618-2.5.1 #
#                     \Projects\zstack\HomeAutomation\SampleLight\CC2520DB\.. #
#                     \..\..\..\..\Components\hal\include\" -I "C:\Texas      #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \hal\target\MSP2618CC2520\" -I "C:\Texas                #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \mac\include\" -I "C:\Texas                             #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \mac\high_level\" -I "C:\Texas                          #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \mac\low_level\srf04\" -I "C:\Texas                     #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \mac\low_level\srf04\dual_chip\" -I "C:\Texas           #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \mt\" -I "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Pro #
#                     jects\zstack\HomeAutomation\SampleLight\CC2520DB\..\..\ #
#                     ..\..\..\Components\osal\include\" -I "C:\Texas         #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \osal\mcu\msp430\" -I "C:\Texas                         #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \services\saddr\" -I "C:\Texas                          #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \services\sdata\" -I "C:\Texas                          #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \stack\af\" -I "C:\Texas Instruments\ZStack-MSP2618-2.5 #
#                     .1\Projects\zstack\HomeAutomation\SampleLight\CC2520DB\ #
#                     ..\..\..\..\..\Components\stack\nwk\" -I "C:\Texas      #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \stack\sec\" -I "C:\Texas Instruments\ZStack-MSP2618-2. #
#                     5.1\Projects\zstack\HomeAutomation\SampleLight\CC2520DB #
#                     \..\..\..\..\..\Components\stack\sapi\" -I "C:\Texas    #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \stack\sys\" -I "C:\Texas Instruments\ZStack-MSP2618-2. #
#                     5.1\Projects\zstack\HomeAutomation\SampleLight\CC2520DB #
#                     \..\..\..\..\..\Components\stack\zcl\" -I "C:\Texas     #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \stack\zdo\" -I "C:\Texas Instruments\ZStack-MSP2618-2. #
#                     5.1\Projects\zstack\HomeAutomation\SampleLight\CC2520DB #
#                     \..\..\..\..\..\Components\zmac\" -I "C:\Texas          #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \zmac\f8w\" --core=430X --data_model=small -Ohz         #
#                     --multiplier=16s --require_prototypes                   #
#    List file     =  C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zsta #
#                     ck\HomeAutomation\SampleLight\CC2520DB\Router\List\stub #
#                     _aps.lst                                                #
#    Object file   =  C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zsta #
#                     ck\HomeAutomation\SampleLight\CC2520DB\Router\Obj\stub_ #
#                     aps.r43                                                 #
#                                                                             #
#                                                                             #
###############################################################################

C:\Texas Instruments\ZStack-MSP2618-2.5.1\Components\stack\nwk\stub_aps.c
      1          /**************************************************************************************************
      2            Filename:       stub_aps.c
      3            Revised:        $Date: 2011-04-20 10:16:44 -0700 (Wed, 20 Apr 2011) $
      4            Revision:       $Revision: 25771 $
      5          
      6            Description:    Stub APS processing functions
      7          
      8          
      9            Copyright 2008 - 2011 Texas Instruments Incorporated. All rights reserved.
     10          
     11            IMPORTANT: Your use of this Software is limited to those specific rights
     12            granted under the terms of a software license agreement between the user
     13            who downloaded the software, his/her employer (which must be your employer)
     14            and Texas Instruments Incorporated (the "License").  You may not use this
     15            Software unless you agree to abide by the terms of the License. The License
     16            limits your use, and you acknowledge, that the Software may not be modified,
     17            copied or distributed unless embedded on a Texas Instruments microcontroller
     18            or used solely and exclusively in conjunction with a Texas Instruments radio
     19            frequency transceiver, which is integrated into your product.  Other than for
     20            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     21            works of, modify, distribute, perform, display or sell this Software and/or
     22            its documentation for any purpose.
     23          
     24            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     25            PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     26            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     27            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     28            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     29            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     30            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     31            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     32            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     33            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     34            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     35          
     36            Should you have any questions regarding your right to use this Software,
     37            contact Texas Instruments Incorporated at www.TI.com.
     38          **************************************************************************************************/
     39          
     40          /*********************************************************************
     41           * INCLUDES
     42           */
     43          #include "osal.h"
     44          #include "mac_spec.h"
     45          #include "nwk_util.h"
     46          #include "AF.h"
     47          
     48          #include "stub_aps.h"
     49          
     50          /*********************************************************************
     51           * MACROS
     52           */
     53          
     54          /*********************************************************************
     55           * CONSTANTS
     56           */
     57          
     58          // Stub NWK header length
     59          #define STUB_NWK_HDR_LEN                2
     60          
     61          // Start of the Stub APS header in the Inter-PAN frame
     62          #define STUB_APS_HDR_FRAME_CTRL         STUB_NWK_HDR_LEN
     63          
     64          // Stub APS event identifiers
     65          #define CHANNEL_CHANGE_EVT              0x0001
     66          
     67          #define CHANNEL_CHANGE_RETRY_TIMEOUT    100
     68          
     69          /*********************************************************************
     70           * TYPEDEFS
     71           */
     72          typedef struct
     73          {
     74            zAddrType_t addr;
     75            uint16 panId;
     76          } pan_t;
     77          
     78          /*********************************************************************
     79           * GLOBAL VARIABLES
     80           */
     81          

   \                                 In  segment DATA16_I, align 1, align-sorted
   \   000000                REQUIRE ?cstart_init_copy
     82          uint8 StubAPS_TaskID = 0xFF;    // Task ID for internal task/event processing
   \                     StubAPS_TaskID:
   \   000000                DS8 1
   \   000001                REQUIRE `?<Initializer for StubAPS_TaskID>`
     83          
     84          /*********************************************************************
     85           * EXTERNAL VARIABLES
     86           */
     87          
     88          
     89          /*********************************************************************
     90           * EXTERNAL FUNCTIONS
     91           */
     92          
     93          
     94          /*********************************************************************
     95           * LOCAL VARIABLES
     96           */
     97          

   \                                 In  segment DATA16_Z, align 1, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
     98          static uint8 newChannel;
   \                     newChannel:
   \   000000                DS8 1

   \                                 In  segment DATA16_Z, align 1, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
     99          static uint8 channelChangeInProgress = FALSE;
   \                     channelChangeInProgress:
   \   000000                DS8 1
    100          
    101          // Application info

   \                                 In  segment DATA16_I, align 1, align-sorted
   \   000000                REQUIRE ?cstart_init_copy
    102          static uint8 appTaskID = 0xFF;  // Application task id
   \                     appTaskID:
   \   000000                DS8 1
   \   000001                REQUIRE `?<Initializer for appTaskID>`

   \                                 In  segment DATA16_Z, align 1, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
    103          static uint8 appEndPoint = 0;   // Application endpoint
   \                     appEndPoint:
   \   000000                DS8 1
    104          
    105          
    106          /*********************************************************************
    107           * LOCAL FUNCTIONS
    108           */
    109          
    110          static void StubNWK_ParseMsg( uint8 *buf, uint8 bufLength, NLDE_FrameFormat_t *snff );
    111          static void StubAPS_ParseMsg( NLDE_FrameFormat_t *snff, aps_FrameFormat_t *saff );
    112          static void StubNWK_BuildMsg( uint8 *nwkHdr );
    113          static void StubAPS_BuildMsg( uint8 *apsHdr, uint8 frmCtrl, uint16 groupID, APSDE_DataReq_t *req );
    114          static ZStatus_t StubAPS_BuildFrameControl( uint8 *frmCtrl, zAddrType_t *dstAddr, 
    115                                                      uint16 *groupID, APSDE_DataReq_t *req );
    116          static ZStatus_t StubAPS_SetNewChannel( uint8 channel );
    117          static void StubAPS_NotifyApp( uint8 status );
    118          
    119          uint8 StubAPS_ZMacCallback( uint8 *msgPtr );
    120          
    121          /*********************************************************************
    122           * @fn      StubAPS_Init()
    123           *
    124           * @brief   Initialize stub APS layer
    125           *
    126           * @param   task_id - Task identifier for the desired task
    127           *
    128           * @return  none
    129           */

   \                                 In  segment CODE, align 2
    130          void StubAPS_Init( uint8 task_id )
   \                     StubAPS_Init:
    131          {
    132            StubAPS_TaskID = task_id;
   \   000000   C24C....     MOV.B   R12, &StubAPS_TaskID
    133              
    134            // register with ZMAC
    135            pZMac_AppCallback = StubAPS_ZMacCallback;
   \   000004   B240........ MOV.W   #LWRD(StubAPS_ZMacCallback), &pZMac_AppCallback
   \   00000A   B240........ MOV.W   #HWRD(StubAPS_ZMacCallback), &pZMac_AppCallback + 2
    136            
    137          } /* StubAPS_Init() */
   \   000010   1001         RETA
    138          
    139          /*********************************************************************
    140           * @fn      StubAPS_ProcessEvent()
    141           *
    142           * @brief   Main event loop for Stub APS task. This function should be called
    143           *          at periodic intervals when event occur.
    144           *
    145           * @param   task_id - Task ID
    146           * @param   events  - Bitmap of events
    147           *
    148           * @return  none
    149           */

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine5:
   \   000000   ........     CALLA   #?Subroutine4
   \                     ??CrossCallReturnLabel_10:
   \   000004   1001         RETA

   \                                 In  segment CODE, align 2
   \                     ?Subroutine4:
   \   000000   0D41         MOV.W   SP, R13
   \   000002   3D52         ADD.W   #0x8, R13
   \   000004   7C405200     MOV.B   #0x52, R12
   \   000008   ........     BRA     #ZMacSetReq

   \                                 In  segment CODE, align 2
    150          UINT16 StubAPS_ProcessEvent( uint8 task_id, uint16 events )
   \                     StubAPS_ProcessEvent:
    151          {
   \   000000   1B15         PUSHM.W #0x2, R11
   \   000002   2183         SUB.W   #0x2, SP
   \   000004   0A4D         MOV.W   R13, R10
    152            (void)task_id; // Intentionally unreferenced parameter
    153            
    154            if ( events & SYS_EVENT_MSG )
   \   000006   0D93         CMP.W   #0x0, R13
   \   000008   2B38         JL      ??StubAPS_ProcessEvent_2
    155            {
    156              osal_event_hdr_t *msg_ptr;
    157          
    158              while ( (msg_ptr = (osal_event_hdr_t *)osal_msg_receive( StubAPS_TaskID )) != NULL )
    159              {
    160                if ( msg_ptr->event == MAC_MCPS_DATA_CNF )
    161                {
    162                  INTERP_DataConfirm( (ZMacDataCnf_t *)msg_ptr );
    163                }
    164                else if ( msg_ptr->event == MAC_MCPS_DATA_IND )
    165                {
    166                  INTERP_DataIndication( (macMcpsDataInd_t *)msg_ptr );
    167                }
    168                
    169                osal_msg_deallocate( (uint8 *)msg_ptr );
    170              }
    171              
    172              // Return unproccessed events
    173              return ( events ^ SYS_EVENT_MSG );
    174            }
    175          
    176            if ( events & CHANNEL_CHANGE_EVT )
   \   00000A   1DB3         BIT.W   #0x1, R13
   \   00000C   3B28         JNC     ??StubAPS_ProcessEvent_3
    177            {
    178              // try to change to the new channel
    179              ZStatus_t status = StubAPS_SetNewChannel( newChannel );
   \   00000E   5C42....     MOV.B   &newChannel, R12
   \   000012   ........     CALLA   #StubAPS_SetNewChannel
   \   000016   4B4C         MOV.B   R12, R11
    180              if ( status != ZSuccess )
   \   000018   4C93         CMP.B   #0x0, R12
   \   00001A   0924         JEQ     ??StubAPS_ProcessEvent_4
    181              {
    182                // turn MAC receiver back on
    183                uint8 rxOnIdle = true;
   \   00001C   D1430000     MOV.B   #0x1, 0(SP)
    184                ZMacSetReq( ZMacRxOnIdle, &rxOnIdle );
   \   000020   ........     CALLA   #?Subroutine5
    185             
    186                // set NWK task to run
    187                nwk_setStateIdle( FALSE );
   \                     ??CrossCallReturnLabel_9:
   \   000024   4C43         MOV.B   #0x0, R12
   \   000026   ........     CALLA   #nwk_setStateIdle
    188                
    189                channelChangeInProgress = FALSE;
   \   00002A   C243....     MOV.B   #0x0, &channelChangeInProgress
    190              }
    191              
    192              // notify the application
    193              StubAPS_NotifyApp( status );
   \                     ??StubAPS_ProcessEvent_4:
   \   00002E   2C43         MOV.W   #0x2, R12
   \   000030   ........     CALLA   #osal_msg_allocate
   \   000034   0D4C         MOV.W   R12, R13
   \   000036   0C93         CMP.W   #0x0, R12
   \   000038   0924         JEQ     ??StubAPS_ProcessEvent_5
   \   00003A   FC4033000000 MOV.B   #0x33, 0(R12)
   \   000040   CC4B0100     MOV.B   R11, 0x1(R12)
   \   000044   5C42....     MOV.B   &appTaskID, R12
   \   000048   ........     CALLA   #osal_msg_send
    194              
    195              return ( events ^ CHANNEL_CHANGE_EVT );
   \                     ??StubAPS_ProcessEvent_5:
   \   00004C   1AE3         XOR.W   #0x1, R10
   \   00004E   183C         JMP     ??StubAPS_ProcessEvent_6
    196            }
   \                     ??StubAPS_ProcessEvent_0:
   \   000050   7E900D00     CMP.B   #0xd, R14
   \   000054   0220         JNE     ??StubAPS_ProcessEvent_1
   \   000056   ........     CALLA   #INTERP_DataIndication
   \                     ??StubAPS_ProcessEvent_1:
   \   00005A   0C4B         MOV.W   R11, R12
   \   00005C   ........     CALLA   #osal_msg_deallocate
   \                     ??StubAPS_ProcessEvent_2:
   \   000060   5C42....     MOV.B   &StubAPS_TaskID, R12
   \   000064   ........     CALLA   #osal_msg_receive
   \   000068   0B4C         MOV.W   R12, R11
   \   00006A   0C93         CMP.W   #0x0, R12
   \   00006C   0724         JEQ     ??StubAPS_ProcessEvent_7
   \   00006E   6E4C         MOV.B   @R12, R14
   \   000070   7E900C00     CMP.B   #0xc, R14
   \   000074   ED23         JNE     ??StubAPS_ProcessEvent_0
   \   000076   ........     CALLA   #INTERP_DataConfirm
   \   00007A   EF3F         JMP     ??StubAPS_ProcessEvent_1
   \                     ??StubAPS_ProcessEvent_7:
   \   00007C   3AE00080     XOR.W   #0x8000, R10
   \                     ??StubAPS_ProcessEvent_6:
   \   000080   0C4A         MOV.W   R10, R12
   \   000082   013C         JMP     ??StubAPS_ProcessEvent_8
    197            
    198            // If reach here, the events are unknown
    199            // Discard or make more handlers
    200            return 0;
   \                     ??StubAPS_ProcessEvent_3:
   \   000084   0C43         MOV.W   #0x0, R12
   \                     ??StubAPS_ProcessEvent_8:
   \   000086   2153         ADD.W   #0x2, SP
   \   000088   1A17         POPM.W  #0x2, R11
   \   00008A   1001         RETA
    201          
    202          } /* StubAPS_ProcessEvent() */
    203          
    204          
    205          /*********************************************************************
    206           * @fn          StubNWK_ParseMsg
    207           *
    208           * @brief       Call this function to parse an incoming Stub NWK frame.
    209           *
    210           * @param       buf - pointer incoming message buffer
    211           * @param       bufLength - length of incoming message
    212           * @param       snff  - pointer Frame Format Parameters
    213           *
    214           * @return      pointer to network packet, NULL if error
    215           */

   \                                 In  segment CODE, align 2
    216          static void StubNWK_ParseMsg( uint8 *buf, uint8 bufLength, NLDE_FrameFormat_t *snff )
   \                     StubNWK_ParseMsg:
    217          {
   \   000000   3B15         PUSHM.W #0x4, R11
   \   000002   0B4C         MOV.W   R12, R11
   \   000004   484D         MOV.B   R13, R8
   \   000006   0A4E         MOV.W   R14, R10
    218            uint16 fc;
    219          
    220            osal_memset( snff, 0, sizeof(NLDE_FrameFormat_t) );
   \   000008   3E402000     MOV.W   #0x20, R14
   \   00000C   4D43         MOV.B   #0x0, R13
   \   00000E   0C4A         MOV.W   R10, R12
   \   000010   ........     CALLA   #osal_memset
    221            
    222            snff->bufLength = bufLength;
   \   000014   CA480000     MOV.B   R8, 0(R10)
    223          
    224            // get the frame control
    225            fc = BUILD_UINT16( buf[NWK_HDR_FRAME_CTRL_LSB], buf[NWK_HDR_FRAME_CTRL_MSB] );
    226            
    227            // parse the frame control
    228            NLDE_ParseFrameControl( fc, snff );
   \   000018   0D4A         MOV.W   R10, R13
   \   00001A   6C4B         MOV.B   @R11, R12
   \   00001C   5F4B0100     MOV.B   0x1(R11), R15
   \   000020                RPT     #0x8
   \   000020   47180F5F     RLAX.W  R15
   \   000024   0C5F         ADD.W   R15, R12
   \   000026   ........     CALLA   #NLDE_ParseFrameControl
    229            
    230            snff->hdrLen = STUB_NWK_HDR_LEN;
   \   00002A   EA430100     MOV.B   #0x2, 0x1(R10)
    231            
    232            // Stub NWK payload
    233            snff->nsdu = buf + snff->hdrLen;
   \   00002E   2B53         ADD.W   #0x2, R11
   \   000030   8A4B1E00     MOV.W   R11, 0x1e(R10)
    234            snff->nsduLength = snff->bufLength - snff->hdrLen;
   \   000034   6E4A         MOV.B   @R10, R14
   \   000036   5E8A0100     SUB.B   0x1(R10), R14
   \   00003A   CA4E1800     MOV.B   R14, 0x18(R10)
    235          
    236          } /* StubNWK_ParseMsg */
   \   00003E   3817         POPM.W  #0x4, R11
   \   000040   1001         RETA
    237          
    238          /*********************************************************************
    239           * @fn          StubAPS_ParseMsg
    240           *
    241           * @brief       Call this function to parse an incoming Stub APS frame.
    242           *
    243           * @param       naff  - pointer Stub NWK Frame Format Parameters
    244           * @param       saff  - pointer Stub APS Format Parameters
    245           *
    246           * @return      none
    247           */

   \                                 In  segment CODE, align 2
    248          static void StubAPS_ParseMsg( NLDE_FrameFormat_t *snff, aps_FrameFormat_t *saff )
   \                     StubAPS_ParseMsg:
    249          {
   \   000000   1B15         PUSHM.W #0x2, R11
   \   000002   0A4C         MOV.W   R12, R10
   \   000004   0B4D         MOV.W   R13, R11
    250            uint8 fcb;
    251            uint8 *asdu;
    252            
    253            osal_memset( saff, 0, sizeof(aps_FrameFormat_t) );
   \   000006   3E401600     MOV.W   #0x16, R14
   \   00000A   4D43         MOV.B   #0x0, R13
   \   00000C   0C4B         MOV.W   R11, R12
   \   00000E   ........     CALLA   #osal_memset
    254            
    255            saff->asduLength = snff->nsduLength;
   \   000012   DB4A18001000 MOV.B   0x18(R10), 0x10(R11)
    256            asdu = snff->nsdu;
   \   000018   1D4A1E00     MOV.W   0x1e(R10), R13
    257            saff->macDestAddr = snff->macDstAddr;
   \   00001C   9B4A0E000A00 MOV.W   0xe(R10), 0xa(R11)
    258            
    259            // First byte is Frame Control.
    260            saff->FrmCtrl = *asdu++;
   \   000022   6E4D         MOV.B   @R13, R14
   \   000024   CB4E0000     MOV.B   R14, 0(R11)
   \   000028   1D53         ADD.W   #0x1, R13
    261          
    262            fcb = saff->FrmCtrl & APS_FRAME_TYPE_MASK;
    263            if ( fcb == STUB_APS_FRAME )
   \   00002A   4F4E         MOV.B   R14, R15
   \   00002C   7FF00300     AND.B   #0x3, R15
   \   000030   7F900300     CMP.B   #0x3, R15
   \   000034   1B20         JNE     ??StubAPS_ParseMsg_0
    264            {
    265              fcb = saff->FrmCtrl & APS_DELIVERYMODE_MASK;
   \   000036   7EF00C00     AND.B   #0xc, R14
    266              if ( fcb == APS_FC_DM_BROADCAST )
   \   00003A   7E92         CMP.B   #0x8, R14
   \   00003C   0224         JEQ     ??StubAPS_ParseMsg_1
   \   00003E   4F43         MOV.B   #0x0, R15
   \   000040   013C         JMP     ??StubAPS_ParseMsg_2
   \                     ??StubAPS_ParseMsg_1:
   \   000042   5F43         MOV.B   #0x1, R15
   \                     ??StubAPS_ParseMsg_2:
   \   000044   CB4F0C00     MOV.B   R15, 0xc(R11)
    267                saff->wasBroadcast = true;
    268              else
    269                saff->wasBroadcast = false;
    270              
    271              if ( fcb == APS_FC_DM_GROUP )
   \   000048   7E900C00     CMP.B   #0xc, R14
   \   00004C   0520         JNE     ??StubAPS_ParseMsg_3
    272              {
    273                saff->GroupID = BUILD_UINT16( asdu[0], asdu[1] );
   \   00004E   ........     CALLA   #?Subroutine2
   \                     ??CrossCallReturnLabel_0:
   \   000052   8B4E0400     MOV.W   R14, 0x4(R11)
    274                asdu += sizeof( uint16 );
   \   000056   2D53         ADD.W   #0x2, R13
    275              }
    276              
    277              // Pull out the Cluster ID
    278              saff->ClusterID = BUILD_UINT16( asdu[0], asdu[1] );
   \                     ??StubAPS_ParseMsg_3:
   \   000058   ........     CALLA   #?Subroutine2
   \                     ??CrossCallReturnLabel_1:
   \   00005C   8B4E0600     MOV.W   R14, 0x6(R11)
    279              asdu += sizeof( uint16 );
   \   000060   2D53         ADD.W   #0x2, R13
    280          
    281              // Pull out the profile ID
    282              saff->ProfileID = BUILD_UINT16( asdu[0], asdu[1] );
   \   000062   ........     CALLA   #?Subroutine2
   \                     ??CrossCallReturnLabel_2:
   \   000066   8B4E0800     MOV.W   R14, 0x8(R11)
    283              asdu += 2;
   \   00006A   2D53         ADD.W   #0x2, R13
    284            }
    285            
    286            saff->asdu = asdu;
   \                     ??StubAPS_ParseMsg_0:
   \   00006C   8B4D0E00     MOV.W   R13, 0xe(R11)
    287            saff->asduLength -= (uint8) (asdu - snff->nsdu);
   \   000070   5E4B1000     MOV.B   0x10(R11), R14
   \   000074   4E8D         SUB.B   R13, R14
   \   000076   5E5A1E00     ADD.B   0x1e(R10), R14
   \   00007A   CB4E1000     MOV.B   R14, 0x10(R11)
    288            saff->apsHdrLen = snff->nsduLength - saff->asduLength;
   \   00007E   5F4A1800     MOV.B   0x18(R10), R15
   \   000082   4F8E         SUB.B   R14, R15
   \   000084   CB4F0D00     MOV.B   R15, 0xd(R11)
    289            
    290          } /* StubAPS_ParseMsg */
   \   000088   1A17         POPM.W  #0x2, R11
   \   00008A   1001         RETA

   \                                 In  segment CODE, align 2
   \                     ?Subroutine2:
   \   000000   6E4D         MOV.B   @R13, R14
   \   000002   5F4D0100     MOV.B   0x1(R13), R15
   \   000006                RPT     #0x8
   \   000006   47180F5F     RLAX.W  R15
   \   00000A   0E5F         ADD.W   R15, R14
   \   00000C   1001         RETA
    291          
    292          /******************************************************************************
    293           * @fn          StubAPS_BuildFrameControl
    294           *
    295           * @brief       This function builds Stub APS Frame Control and the destination
    296           *              address parameter for the MCPS-DATA Request.
    297           *
    298           * @param       frmCtrl - frame control
    299           * @param       dstAddr - destination address for MCPS-DATA Request
    300           * @param       groupID - group id
    301           * @param       req - APSDE_DataReq_t
    302           *
    303           * @return      ZStatus_t
    304           */

   \                                 In  segment CODE, align 2
    305          static ZStatus_t StubAPS_BuildFrameControl( uint8 *frmCtrl, zAddrType_t *dstAddr, 
   \                     StubAPS_BuildFrameControl:
    306                                                      uint16 *groupID, APSDE_DataReq_t *req )
    307          { 
   \   000000   0A12         PUSH.W  R10
   \   000002   0A4D         MOV.W   R13, R10
   \   000004   0D4F         MOV.W   R15, R13
    308            // Security
    309            if ( req->txOptions & APS_TX_OPTIONS_SECURITY_ENABLE )
   \   000006   FFB00D001600 BIT.B   #0xd, 0x16(R15)
   \   00000C   0320         JNE     ??StubAPS_BuildFrameControl_0
    310              return ( ZApsNotSupported );
    311              
    312            // Ack request
    313            if ( req->txOptions & APS_TX_OPTIONS_ACK )
    314              return ( ZApsNotSupported );
    315            
    316             // Fragmentation
    317            if ( req->txOptions & APS_TX_OPTIONS_PERMIT_FRAGMENT )
    318              return ( ZApsNotSupported );
    319            
    320            // set delivery mode
    321            if ( req->dstAddr.addrMode == AddrNotPresent )
   \   00000E   CF930800     CMP.B   #0x0, 0x8(R15)
   \   000012   0320         JNE     ??StubAPS_BuildFrameControl_1
    322              return ( ZApsNotSupported ); // No REFLECTOR
   \                     ??StubAPS_BuildFrameControl_0:
   \   000014   7C40B600     MOV.B   #0xb6, R12
   \   000018   283C         JMP     ??StubAPS_BuildFrameControl_2
    323          
    324            // set frame type
    325            *frmCtrl = STUB_APS_FRAME;
   \                     ??StubAPS_BuildFrameControl_1:
   \   00001A   FC4003000000 MOV.B   #0x3, 0(R12)
    326            
    327            // set DstAddrMode of MCPS-DATA Request to DstAddrMode of INTERP-Data Request
    328            dstAddr->addrMode = req->dstAddr.addrMode;
   \   000020   DA4F08000800 MOV.B   0x8(R15), 0x8(R10)
    329          
    330            // set DstAddr of MCPS-DATA Request to DstAddr of INTERP-Data Request
    331            if ( req->dstAddr.addrMode == AddrBroadcast )
   \   000026   5F4D0800     MOV.B   0x8(R13), R15
   \   00002A   7F900F00     CMP.B   #0xf, R15
   \   00002E   0520         JNE     ??StubAPS_BuildFrameControl_3
    332            {
    333              *frmCtrl |= APS_FC_DM_BROADCAST;
   \   000030   FCD20000     BIS.B   #0x8, 0(R12)
    334              
    335              // set DstAddrMode of MCPS-DATA Request to short address
    336              dstAddr->addrMode = Addr16Bit;
   \   000034   EA430800     MOV.B   #0x2, 0x8(R10)
    337              dstAddr->addr.shortAddr = req->dstAddr.addr.shortAddr;
   \   000038   023C         JMP     ??StubAPS_BuildFrameControl_4
    338            }
    339            else if ( req->dstAddr.addrMode == Addr16Bit )
   \                     ??StubAPS_BuildFrameControl_3:
   \   00003A   6F93         CMP.B   #0x2, R15
   \   00003C   0320         JNE     ??StubAPS_BuildFrameControl_5
    340            {
    341              *frmCtrl |= APS_FC_DM_UNICAST;
    342              dstAddr->addr.shortAddr = req->dstAddr.addr.shortAddr;
   \                     ??StubAPS_BuildFrameControl_4:
   \   00003E   AA4D0000     MOV.W   @R13, 0(R10)
   \   000042   123C         JMP     ??StubAPS_BuildFrameControl_6
    343            }
    344            else if ( req->dstAddr.addrMode == Addr64Bit )
   \                     ??StubAPS_BuildFrameControl_5:
   \   000044   7F900300     CMP.B   #0x3, R15
   \   000048   0420         JNE     ??StubAPS_BuildFrameControl_7
    345            {
    346              *frmCtrl |= APS_FC_DM_UNICAST;
    347              osal_cpyExtAddr( dstAddr->addr.extAddr, req->dstAddr.addr.extAddr );
   \   00004A   0C4A         MOV.W   R10, R12
   \   00004C   ........     CALLA   #sAddrExtCpy
   \   000050   0B3C         JMP     ??StubAPS_BuildFrameControl_6
    348            }
    349            else if ( req->dstAddr.addrMode == AddrGroup )
   \                     ??StubAPS_BuildFrameControl_7:
   \   000052   5F93         CMP.B   #0x1, R15
   \   000054   0920         JNE     ??StubAPS_BuildFrameControl_6
    350            {
    351              *frmCtrl |= APS_FC_DM_GROUP;
   \   000056   FCD00C000000 BIS.B   #0xc, 0(R12)
    352              
    353              // set DstAddrMode of MCPS-DATA Request to short address
    354              dstAddr->addrMode = Addr16Bit;
   \   00005C   EA430800     MOV.B   #0x2, 0x8(R10)
    355              
    356              // set DstAddr of MCPS-DATA Request to 0xFFFF
    357              dstAddr->addr.shortAddr = NWK_BROADCAST_SHORTADDR_DEVALL;
   \   000060   BA430000     MOV.W   #0xffff, 0(R10)
    358              
    359              // set Group ID to DstAddr of INTERP-Data Request
    360              *groupID = req->dstAddr.addr.shortAddr;
   \   000064   AE4D0000     MOV.W   @R13, 0(R14)
    361            }
    362            
    363            return ( ZSuccess );
   \                     ??StubAPS_BuildFrameControl_6:
   \   000068   4C43         MOV.B   #0x0, R12
   \                     ??StubAPS_BuildFrameControl_2:
   \   00006A   3A41         POP.W   R10
   \   00006C   1001         RETA
    364            
    365          } /* StubAPS_BuildFrameControl */
    366          
    367          /******************************************************************************
    368           * @fn          StubNWK_BuildMsg
    369           *
    370           * @brief       This function builds a Stub NWK frame.
    371           *
    372           * @param       nwkHdr - stub NWK header
    373           *
    374           * @return      none
    375           */
    376          static void StubNWK_BuildMsg( uint8 *nwkHdr )
    377          {
    378            uint16 frmCtrl = 0;
    379            uint8  protoVer = NLME_GetProtocolVersion();
    380          
    381            // frame type
    382            frmCtrl |= (STUB_NWK_FRAME_TYPE << NWK_FC_FRAME_TYPE);
    383          
    384            // protocol version
    385            frmCtrl |= (protoVer << NWK_FC_PROT_VERSION);
    386            
    387            // set Stub NWK header
    388            *nwkHdr++ = LO_UINT16( frmCtrl );
    389            *nwkHdr++ = HI_UINT16( frmCtrl );
    390            
    391          } /* StubNWK_BuildMsg */
    392          
    393          /******************************************************************************
    394           * @fn          StubAPS_BuildMsg
    395           *
    396           * @brief       This function builds a Stub APS frame.
    397           *
    398           * @param       apsHdr - stub APS header
    399           * @param       frmCtrl - stub APS frame control
    400           * @param       groupID - group id
    401           * @param       req - APSDE_DataReq_t
    402           *
    403           * @return      none
    404           */

   \                                 In  segment CODE, align 2
    405          static void StubAPS_BuildMsg( uint8 *apsHdr, uint8 frmCtrl, uint16 groupID, APSDE_DataReq_t *req )
   \                     StubAPS_BuildMsg:
    406          {
    407            // add frame type
    408            *apsHdr++ = frmCtrl;
   \   000000   CC4D0000     MOV.B   R13, 0(R12)
   \   000004   1C53         ADD.W   #0x1, R12
    409              
    410            // add Group ID
    411            if ( ( frmCtrl & APS_DELIVERYMODE_MASK ) == APS_FC_DM_GROUP )
   \   000006   7DF00C00     AND.B   #0xc, R13
   \   00000A   7D900C00     CMP.B   #0xc, R13
   \   00000E   0820         JNE     ??StubAPS_BuildMsg_0
    412            {
    413              *apsHdr++ = LO_UINT16( groupID );
   \   000010   CC4E0000     MOV.B   R14, 0(R12)
   \   000014   1C53         ADD.W   #0x1, R12
    414              *apsHdr++ = HI_UINT16( groupID );
   \   000016                RPT     #0x8
   \   000016   47190E10     RRUX.W  R14
   \   00001A   CC4E0000     MOV.B   R14, 0(R12)
   \   00001E   1C53         ADD.W   #0x1, R12
    415            }
    416          
    417            // add clusterID
    418            *apsHdr++ = LO_UINT16( req->clusterID );
   \                     ??StubAPS_BuildMsg_0:
   \   000020   DC4F0E000000 MOV.B   0xe(R15), 0(R12)
   \   000026   1C53         ADD.W   #0x1, R12
    419            *apsHdr++ = HI_UINT16( req->clusterID );
   \   000028   DC4F0F000000 MOV.B   0xf(R15), 0(R12)
   \   00002E   1C53         ADD.W   #0x1, R12
    420            
    421            // add profile ID
    422            *apsHdr++ = LO_UINT16( req->profileID );
   \   000030   DC4F10000000 MOV.B   0x10(R15), 0(R12)
   \   000036   1C53         ADD.W   #0x1, R12
    423            *apsHdr++ = HI_UINT16( req->profileID );
   \   000038   DC4F11000000 MOV.B   0x11(R15), 0(R12)
   \   00003E   1C53         ADD.W   #0x1, R12
    424              
    425            // copy ASDU data into frame
    426            osal_memcpy ( apsHdr, req->asdu, req->asduLen );
   \   000040   1E4F1200     MOV.W   0x12(R15), R14
   \   000044   1D4F1400     MOV.W   0x14(R15), R13
   \   000048   ........     BRA     #osal_memcpy
    427            
    428          } /* StubAPS_BuildMsg */
    429          
    430          /******************************************************************************
    431           * @fn          StubAPS_setNewChannel
    432           *
    433           * @brief       This function changes the device's channel.
    434           *
    435           * @param       none
    436           *
    437           * @return      ZStatus_t
    438           */ 

   \                                 In  segment CODE, align 2, keep-with-next
    439          static ZStatus_t StubAPS_SetNewChannel( uint8 channel )
   \                     StubAPS_SetNewChannel:
    440          {
   \   000000   4C12         PUSH.B  R12
   \   000002   2183         SUB.W   #0x2, SP
    441            uint8 rxOnIdle;
    442            
    443            // make sure MAC has nothing to transmit
    444            if ( ( nwkDB_CountTypes( NWK_DATABUF_SENT ) == 0 ) && ZMacStateIdle() )
   \   000004   6C43         MOV.B   #0x2, R12
   \   000006   ........     CALLA   #nwkDB_CountTypes
   \   00000A   4C93         CMP.B   #0x0, R12
   \   00000C   0C20         JNE     ??StubAPS_SetNewChannel_0
   \   00000E   ........     CALLA   #ZMacStateIdle
   \   000012   4C93         CMP.B   #0x0, R12
   \   000014   0824         JEQ     ??StubAPS_SetNewChannel_0
    445            {
    446              // set the new channel
    447              ZMacSetReq( ZMacChannel, &channel );
   \   000016   0D41         MOV.W   SP, R13
   \   000018   2D53         ADD.W   #0x2, R13
   \   00001A   ........     CALLA   #?Subroutine0
    448          
    449              // turn MAC receiver back on
    450              rxOnIdle = true;
    451              ZMacSetReq( ZMacRxOnIdle, &rxOnIdle );
    452            
    453              channelChangeInProgress = FALSE;
   \                     ??CrossCallReturnLabel_6:
   \   00001E   C243....     MOV.B   #0x0, &channelChangeInProgress
    454              
    455              return ( ZSuccess );
   \   000022   4C43         MOV.B   #0x0, R12
   \   000024   013C         JMP     ??StubAPS_SetNewChannel_1
    456            }
    457            
    458            return ( ZFailure );
   \                     ??StubAPS_SetNewChannel_0:
   \   000026   5C43         MOV.B   #0x1, R12
   \                     ??StubAPS_SetNewChannel_1:
   \   000028   2152         ADD.W   #0x4, SP
   \   00002A   1001         RETA
    459            
    460          } /* StubAPS_setNewChannel */

   \                                 In  segment CODE, align 2
   \                     ?Subroutine0:
   \   000000   7C40E100     MOV.B   #0xe1, R12
   \   000004   ........     CALLA   #ZMacSetReq
   \   000008   D1430400     MOV.B   #0x1, 0x4(SP)
   \   00000C   ....         JMP     ?Subroutine5
    461          
    462          
    463          /******************************************************************************
    464           * @fn          StubAPS_NotifyApp
    465           *
    466           * @brief       This function sends an OSAL message to the Application task.
    467           *
    468           * @param       status - command status
    469           *
    470           * @return      none
    471           */
    472          static void StubAPS_NotifyApp( uint8 status )
    473          {
    474            osal_event_hdr_t *msgPtr;
    475            
    476            // Notify the application task
    477            msgPtr = (osal_event_hdr_t *)osal_msg_allocate( sizeof(osal_event_hdr_t) );
    478            if ( msgPtr )
    479            {
    480              msgPtr->event = SAPS_CHANNEL_CHANGE;
    481              msgPtr->status = status;
    482              
    483              osal_msg_send( appTaskID, (uint8 *)msgPtr );
    484            }
    485            
    486          } /* StubAPS_NotifyApp */
    487          
    488          /******************************************************************************
    489           *
    490           *  External APIs provided to the Application.
    491           */
    492          
    493          /******************************************************************************
    494           * @fn          StubAPS_SetInterPanChannel
    495           *
    496           * @brief       This function changes the device's channel for inter-PAN communication.
    497           *
    498           * @param       channel - new channel
    499           *
    500           * @return      ZStatus_t
    501           */

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine1:
   \   000000   C1430400     MOV.B   #0x0, 0x4(SP)
   \   000004                REQUIRE ?Subroutine5
   \   000004                // Fall through to label ?Subroutine5

   \                                 In  segment CODE, align 2, keep-with-next
    502          ZStatus_t StubAPS_SetInterPanChannel( uint8 channel )
   \                     StubAPS_SetInterPanChannel:
    503          {
   \   000000   0A12         PUSH.W  R10
   \   000002   2183         SUB.W   #0x2, SP
   \   000004   4A4C         MOV.B   R12, R10
    504            uint8 currChannel;
    505            uint8 rxOnIdle;
    506            
    507            if ( channelChangeInProgress )
   \   000006   C293....     CMP.B   #0x0, &channelChangeInProgress
   \   00000A   0224         JEQ     ??StubAPS_SetInterPanChannel_0
    508              return ( ZFailure );
   \   00000C   5C43         MOV.B   #0x1, R12
   \   00000E   1E3C         JMP     ??StubAPS_SetInterPanChannel_1
    509          
    510            ZMacGetReq( ZMacChannel, &currChannel );
   \                     ??StubAPS_SetInterPanChannel_0:
   \   000010   ........     CALLA   #?Subroutine3
    511            if ( currChannel == channel )
   \                     ??CrossCallReturnLabel_3:
   \   000014   C19A0100     CMP.B   R10, 0x1(SP)
   \   000018   0C24         JEQ     ??StubAPS_SetInterPanChannel_2
    512            {
    513              // inter PANs communication within the same channel
    514              return ( ZSuccess );
    515            }
    516            
    517            // go into channel transition state
    518            channelChangeInProgress = TRUE;
   \   00001A   D243....     MOV.B   #0x1, &channelChangeInProgress
    519            
    520            // set NWK task to idle
    521            nwk_setStateIdle( TRUE );
   \   00001E   5C43         MOV.B   #0x1, R12
   \   000020   ........     CALLA   #nwk_setStateIdle
    522            
    523            // turn MAC receiver off
    524            rxOnIdle = false;
   \   000024   ........     CALLA   #?Subroutine1
    525            ZMacSetReq( ZMacRxOnIdle, &rxOnIdle );
    526          
    527            // try to change to the new channel
    528            if ( StubAPS_SetNewChannel( channel ) == ZSuccess )
   \                     ??CrossCallReturnLabel_8:
   \   000028   4C4A         MOV.B   R10, R12
   \   00002A   ........     CALLA   #StubAPS_SetNewChannel
   \   00002E   4C93         CMP.B   #0x0, R12
   \   000030   0220         JNE     ??StubAPS_SetInterPanChannel_3
    529              return ( ZSuccess );
   \                     ??StubAPS_SetInterPanChannel_2:
   \   000032   4C43         MOV.B   #0x0, R12
   \   000034   0B3C         JMP     ??StubAPS_SetInterPanChannel_1
    530              
    531            // save the new channel for retry
    532            newChannel = channel;
   \                     ??StubAPS_SetInterPanChannel_3:
   \   000036   C24A....     MOV.B   R10, &newChannel
    533            
    534            // ask StubAPS task to retry it later
    535            osal_start_timerEx( StubAPS_TaskID, CHANNEL_CHANGE_EVT, CHANNEL_CHANGE_RETRY_TIMEOUT );
   \   00003A   3E406400     MOV.W   #0x64, R14
   \   00003E   1D43         MOV.W   #0x1, R13
   \   000040   5C42....     MOV.B   &StubAPS_TaskID, R12
   \   000044   ........     CALLA   #osal_start_timerEx
    536              
    537            return ( ZApsNotAllowed );
   \   000048   7C40BA00     MOV.B   #0xba, R12
   \                     ??StubAPS_SetInterPanChannel_1:
   \   00004C   2153         ADD.W   #0x2, SP
   \   00004E   3A41         POP.W   R10
   \   000050   1001         RETA
    538            
    539          } /* StubAPS_SetInterPanChannel */

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine3:
   \   000000   0D41         MOV.W   SP, R13
   \   000002   3D500500     ADD.W   #0x5, R13
   \   000006   7C40E100     MOV.B   #0xe1, R12
   \   00000A   ........     BRA     #ZMacGetReq
    540          
    541          /******************************************************************************
    542           * @fn          StubAPS_SetIntraPanChannel
    543           *
    544           * @brief       This function sets the device's channel back to the NIB channel.
    545           *
    546           * @param       none
    547           *
    548           * @return      ZStatus_t
    549           */

   \                                 In  segment CODE, align 2
    550          ZStatus_t StubAPS_SetIntraPanChannel( void )
   \                     StubAPS_SetIntraPanChannel:
    551          {
   \   000000   2183         SUB.W   #0x2, SP
    552            uint8 currChannel;
    553            uint8 rxOnIdle;
    554            
    555            if ( channelChangeInProgress )
   \   000002   C293....     CMP.B   #0x0, &channelChangeInProgress
   \   000006   0224         JEQ     ??StubAPS_SetIntraPanChannel_2
    556              return ( ZFailure );
   \   000008   5C43         MOV.B   #0x1, R12
   \   00000A   143C         JMP     ??StubAPS_SetIntraPanChannel_3
    557            
    558            ZMacGetReq( ZMacChannel, &currChannel );
   \                     ??StubAPS_SetIntraPanChannel_2:
   \   00000C   ........     CALLA   #?Subroutine3
    559            if ( currChannel == _NIB.nwkLogicalChannel )
   \                     ??CrossCallReturnLabel_4:
   \   000010   D192....0100 CMP.B   &_NIB + 24, 0x1(SP)
   \   000016   0D24         JEQ     ??StubAPS_SetIntraPanChannel_1
    560              return ( ZSuccess );
    561            
    562            channelChangeInProgress = TRUE;
   \   000018   D243....     MOV.B   #0x1, &channelChangeInProgress
    563            
    564            // turn MAC receiver off
    565            rxOnIdle = false;
   \   00001C   ........     CALLA   #?Subroutine1
    566            ZMacSetReq( ZMacRxOnIdle, &rxOnIdle );
    567            
    568            // set the NIB channel
    569            ZMacSetReq( ZMacChannel, &(_NIB.nwkLogicalChannel) );
   \                     ??CrossCallReturnLabel_7:
   \   000020   3D40....     MOV.W   #_NIB + 24, R13
   \   000024   ........     CALLA   #?Subroutine0
    570            
    571            // turn MAC receiver back on
    572            rxOnIdle = true;
    573            ZMacSetReq( ZMacRxOnIdle, &rxOnIdle );
    574             
    575            // set NWK task to run
    576            nwk_setStateIdle( FALSE );
   \                     ??CrossCallReturnLabel_5:
   \   000028   4C43         MOV.B   #0x0, R12
   \   00002A   ........     CALLA   #nwk_setStateIdle
    577            
    578            channelChangeInProgress = FALSE;
   \   00002E   C243....     MOV.B   #0x0, &channelChangeInProgress
    579            
    580            return ( ZSuccess );
   \                     ??StubAPS_SetIntraPanChannel_1:
   \   000032   4C43         MOV.B   #0x0, R12
   \                     ??StubAPS_SetIntraPanChannel_3:
   \   000034   2153         ADD.W   #0x2, SP
   \   000036   1001         RETA
    581            
    582          } /* StubAPS_SetIntraPanChannel */
    583          
    584          /******************************************************************************
    585           * @fn          StubAPS_InterPan
    586           *
    587           * @brief       This function checks to see if a PAN is an Inter-PAN.
    588           *
    589           * @param       panId - PAN ID
    590           * @param       endPoint - endpoint
    591           *
    592           * @return      TRUE if PAN is Inter-PAN, FALSE otherwise
    593           */

   \                                 In  segment CODE, align 2
    594          uint8 StubAPS_InterPan( uint16 panId, uint8 endPoint )
   \                     StubAPS_InterPan:
    595          {
    596            (void)panId; // Intentionally unreferenced parameter
    597          
    598            // No need to check the MAC/NIB Channels or Source/Destination PAN IDs
    599            // since it's possible to send Inter-PAN messages within the same network.
    600            if ( endPoint == STUBAPS_INTER_PAN_EP )
   \   000000   7D90FE00     CMP.B   #0xfe, R13
   \   000004   0220         JNE     ??StubAPS_InterPan_0
    601            {
    602              // Inter-PAN endpoint
    603              return ( TRUE );
   \   000006   5C43         MOV.B   #0x1, R12
   \   000008   1001         RETA
    604            }
    605            
    606            return ( FALSE );
   \                     ??StubAPS_InterPan_0:
   \   00000A   4C43         MOV.B   #0x0, R12
   \   00000C   1001         RETA
    607            
    608          } /* StubAPS_InterPan */
    609          
    610          /******************************************************************************
    611           * @fn          StubAPS_RegisterApp
    612           *
    613           * @brief       This function registers the Application with the Stub APS layer.
    614           *
    615           *              NOTE: Since Stub APS messages don't include the application
    616           *                    endpoint, the application has to register its endpoint
    617           *                    with Stub APS.
    618           *
    619           * @param       epDesc - application's endpoint descriptor
    620           *
    621           * @return      none
    622           */

   \                                 In  segment CODE, align 2
    623          void StubAPS_RegisterApp( endPointDesc_t *epDesc )
   \                     StubAPS_RegisterApp:
    624          {
    625            appTaskID = *epDesc->task_id;
   \   000000   1F4C0200     MOV.W   0x2(R12), R15
   \   000004   E24F....     MOV.B   @R15, &appTaskID
    626            appEndPoint = epDesc->endPoint;
   \   000008   E24C....     MOV.B   @R12, &appEndPoint
    627            
    628          } /* StubAPS_RegisterApp */
   \   00000C   1001         RETA
    629          
    630          /******************************************************************************
    631           * @fn          StubAPS_ZMacCallback
    632           *
    633           * @brief       This function accepts an inter-PAN message from ZMac.
    634           *
    635           * @param       msgPtr - received message
    636           *
    637           * @return      TRUE if message is processed. FALSE otherwise.
    638           */

   \                                 In  segment CODE, align 2
    639          uint8 StubAPS_ZMacCallback( uint8 *msgPtr )
   \                     StubAPS_ZMacCallback:
    640          {
    641            uint16 nwk_fc;
    642            uint8  aps_fc;
    643            uint8  frameType;
    644            uint8 *buf = NULL;
    645            uint8  event = ((osal_event_hdr_t *)msgPtr)->event;
   \   000000   6E4C         MOV.B   @R12, R14
    646          
    647            if ( event == MAC_MCPS_DATA_IND )
   \   000002   7E900D00     CMP.B   #0xd, R14
   \   000006   0320         JNE     ??StubAPS_ZMacCallback_0
    648            {
    649              buf = ((macMcpsDataInd_t *)msgPtr)->msdu.p;
   \   000008   1F4C0200     MOV.W   0x2(R12), R15
   \   00000C   073C         JMP     ??StubAPS_ZMacCallback_1
    650            }
    651            else if ( event == MAC_MCPS_DATA_CNF )
   \                     ??StubAPS_ZMacCallback_0:
   \   00000E   7E900C00     CMP.B   #0xc, R14
   \   000012   1820         JNE     ??StubAPS_ZMacCallback_2
    652            {
    653              buf = ((macMcpsDataCnf_t *)msgPtr)->pDataReq->msdu.p;
   \   000014   1F4C0400     MOV.W   0x4(R12), R15
   \   000018   1F4F0200     MOV.W   0x2(R15), R15
    654            }
    655            
    656            if ( buf )
   \                     ??StubAPS_ZMacCallback_1:
   \   00001C   0F93         CMP.W   #0x0, R15
   \   00001E   1224         JEQ     ??StubAPS_ZMacCallback_2
    657            {
    658              // get the NWK frame control
    659              nwk_fc = BUILD_UINT16( buf[NWK_HDR_FRAME_CTRL_LSB], buf[NWK_HDR_FRAME_CTRL_MSB] );
    660            
    661              // frame type
    662              frameType = (uint8)((nwk_fc >> NWK_FC_FRAME_TYPE) & NWK_FC_FRAME_TYPE_MASK);
    663            
    664              // check if incoming frame is of the right type
    665              if ( frameType != STUB_NWK_FRAME_TYPE )
   \   000020   7E400300     MOV.B   #0x3, R14
   \   000024   4D4E         MOV.B   R14, R13
   \   000026   6DFF         AND.B   @R15, R13
   \   000028   4D9E         CMP.B   R14, R13
   \   00002A   0C20         JNE     ??StubAPS_ZMacCallback_2
    666              {
    667                // message doesn't belong to Stub APS
    668                return ( FALSE );
    669              }
    670           
    671              // get the APS frame control
    672              aps_fc = buf[STUB_APS_HDR_FRAME_CTRL];
    673            
    674              // frame type
    675              frameType = aps_fc & APS_FRAME_TYPE_MASK;
    676              
    677              // check if incoming frame is of the right type
    678              if ( frameType != STUB_APS_FRAME )
   \   00002C   4D4E         MOV.B   R14, R13
   \   00002E   5DFF0200     AND.B   0x2(R15), R13
   \   000032   4D9E         CMP.B   R14, R13
   \   000034   0720         JNE     ??StubAPS_ZMacCallback_2
    679              {
    680                // message doesn't belong to Stub APS
    681                return ( FALSE );
    682              }
    683              
    684              // message belongs to Stub APS
    685              osal_msg_send( StubAPS_TaskID, (uint8 *)msgPtr );
   \   000036   0D4C         MOV.W   R12, R13
   \   000038   5C42....     MOV.B   &StubAPS_TaskID, R12
   \   00003C   ........     CALLA   #osal_msg_send
    686           
    687              return ( TRUE );
   \   000040   5C43         MOV.B   #0x1, R12
   \   000042   1001         RETA
    688            }
    689            
    690            // message doesn't belong to Stub APS
    691            return ( FALSE );
   \                     ??StubAPS_ZMacCallback_2:
   \   000044   4C43         MOV.B   #0x0, R12
   \   000046   1001         RETA
    692              
    693          } /* StubAPS_ZMacCallback */
    694          
    695          /******************************************************************************
    696           *
    697           *  Stub APS Inter-PAN interface INTERP and its callbacks.
    698           */
    699          
    700          /******************************************************************************
    701           * @fn          INTERP_DataReq
    702           *
    703           * @brief       This function requests the transfer of data from the next
    704           *              higher layer to a single peer entity.
    705           *
    706           * @param       req - APSDE_DataReq_t
    707           *
    708           * @return      ZStatus_t
    709           */

   \                                 In  segment CODE, align 2
    710          ZStatus_t INTERP_DataReq( APSDE_DataReq_t *req )
   \                     INTERP_DataReq:
    711          {
   \   000000   3B15         PUSHM.W #0x4, R11
   \   000002   31802400     SUB.W   #0x24, SP
   \   000006   0B4C         MOV.W   R12, R11
    712            uint8 apsFrmCtrl;
    713            uint16 groupID = 0;
   \   000008   81430200     MOV.W   #0x0, 0x2(SP)
    714            uint8 *buf;
    715            uint8 hdrLen;
    716            ZMacDataReq_t dataReq;
    717            ZStatus_t status;
    718            
    719            if ( channelChangeInProgress || !StubAPS_InterPan( req->dstPanId, req->dstEP ) )
   \   00000C   C293....     CMP.B   #0x0, &channelChangeInProgress
   \   000010   0420         JNE     ??INTERP_DataReq_0
   \   000012   FC90FE000B00 CMP.B   #0xfe, 0xb(R12)
   \   000018   0224         JEQ     ??INTERP_DataReq_1
    720              return ( ZFailure );
   \                     ??INTERP_DataReq_0:
   \   00001A   5C43         MOV.B   #0x1, R12
   \   00001C   5B3C         JMP     ??INTERP_DataReq_2
    721            
    722            osal_memset( &dataReq, 0, sizeof( ZMacDataReq_t ) );
   \                     ??INTERP_DataReq_1:
   \   00001E   0841         MOV.W   SP, R8
   \   000020   2852         ADD.W   #0x4, R8
   \   000022   3E402000     MOV.W   #0x20, R14
   \   000026   4D43         MOV.B   #0x0, R13
   \   000028   0C48         MOV.W   R8, R12
   \   00002A   ........     CALLA   #osal_memset
    723            
    724            // Build Stub APS header
    725            status = StubAPS_BuildFrameControl( &apsFrmCtrl, &(dataReq.DstAddr), &groupID, req );
   \   00002E   0F4B         MOV.W   R11, R15
   \   000030   0E41         MOV.W   SP, R14
   \   000032   2E53         ADD.W   #0x2, R14
   \   000034   0D48         MOV.W   R8, R13
   \   000036   0C41         MOV.W   SP, R12
   \   000038   0C53         ADD.W   #0x0, R12
   \   00003A   ........     CALLA   #StubAPS_BuildFrameControl
   \   00003E   4A4C         MOV.B   R12, R10
    726            if ( status != ZSuccess )
   \   000040   4C93         CMP.B   #0x0, R12
   \   000042   4720         JNE     ??INTERP_DataReq_3
    727              return ( status );
    728          
    729            // set default Stub APS header length
    730            hdrLen = APS_FRAME_CTRL_FIELD_LEN;
   \   000044   5C43         MOV.B   #0x1, R12
    731            
    732            // add group ID length
    733            if ( ( apsFrmCtrl & APS_DELIVERYMODE_MASK ) == APS_FC_DM_GROUP )
   \   000046   6E41         MOV.B   @SP, R14
   \   000048   7EF00C00     AND.B   #0xc, R14
   \   00004C   7E900C00     CMP.B   #0xc, R14
   \   000050   0220         JNE     ??INTERP_DataReq_4
    734              hdrLen += APS_GROUP_ID_FIELD_LEN;
   \   000052   7C400300     MOV.B   #0x3, R12
    735            
    736            // add cluster ID length
    737            hdrLen += APS_CLUSTERID_FIELD_LEN;
    738            
    739            // add profile ID length
    740            hdrLen += APS_PROFILEID_FIELD_LEN;
    741            
    742            // add default Stub NWK header length
    743            hdrLen += STUB_NWK_HDR_LEN;
    744            
    745            // calculate MSDU length
    746            dataReq.msduLength = hdrLen + req->asduLen;
   \                     ??INTERP_DataReq_4:
   \   000056   5C5B1200     ADD.B   0x12(R11), R12
   \   00005A   7C500600     ADD.B   #0x6, R12
   \   00005E   C14C2000     MOV.B   R12, 0x20(SP)
    747            
    748            // allocate buffer
    749            buf = osal_mem_alloc( dataReq.msduLength );
   \   000062   ........     CALLA   #osal_mem_alloc
   \   000066   094C         MOV.W   R12, R9
    750            if ( buf != NULL )
   \   000068   0C93         CMP.W   #0x0, R12
   \   00006A   3124         JEQ     ??INTERP_DataReq_5
    751            {
    752              dataReq.msdu = buf;
   \   00006C   814C2200     MOV.W   R12, 0x22(SP)
    753              
    754              // Add Stub APS header and data
    755              StubAPS_BuildMsg( &buf[STUB_APS_HDR_FRAME_CTRL], apsFrmCtrl, groupID, req );
   \   000070   0F4B         MOV.W   R11, R15
   \   000072   1E410200     MOV.W   0x2(SP), R14
   \   000076   6D41         MOV.B   @SP, R13
   \   000078   2C53         ADD.W   #0x2, R12
   \   00007A   ........     CALLA   #StubAPS_BuildMsg
    756              
    757              // Add Stub NWK header
    758              StubNWK_BuildMsg( buf );  
   \   00007E   0A49         MOV.W   R9, R10
   \   000080   ........     CALLA   #NLME_GetProtocolVersion
   \   000084   4C4C         MOV.B   R12, R12
   \   000086   5C06         RLAM.W  #0x2, R12
   \   000088   3CD00300     BIS.W   #0x3, R12
   \   00008C   C94C0000     MOV.B   R12, 0(R9)
   \   000090   1A53         ADD.W   #0x1, R10
   \   000092                RPT     #0x8
   \   000092   47190C10     RRUX.W  R12
   \   000096   CA4C0000     MOV.B   R12, 0(R10)
    759          
    760              // Set ZMac data request
    761              dataReq.DstPANId = req->dstPanId;
   \   00009A   914B0C000E00 MOV.W   0xc(R11), 0xe(SP)
    762              dataReq.SrcAddrMode = Addr64Bit; 
   \   0000A0   F14003001000 MOV.B   #0x3, 0x10(SP)
    763              dataReq.Handle = req->transID;
   \   0000A6   D14B18001100 MOV.B   0x18(R11), 0x11(SP)
    764            
    765              if ( ( apsFrmCtrl & APS_DELIVERYMODE_MASK ) == APS_FC_DM_UNICAST )
   \   0000AC   F1B00C000000 BIT.B   #0xc, 0(SP)
   \   0000B2   0224         JEQ     ??INTERP_DataReq_6
   \   0000B4   4E43         MOV.B   #0x0, R14
   \   0000B6   013C         JMP     ??INTERP_DataReq_7
   \                     ??INTERP_DataReq_6:
   \   0000B8   5E43         MOV.B   #0x1, R14
   \                     ??INTERP_DataReq_7:
   \   0000BA   C14E1200     MOV.B   R14, 0x12(SP)
    766                dataReq.TxOptions = NWK_TXOPTIONS_ACK;
    767              else
    768                dataReq.TxOptions = 0;
    769              
    770              // send the frame
    771              status = ZMacDataReq( &dataReq );
   \   0000BE   0C48         MOV.W   R8, R12
   \   0000C0   ........     CALLA   #ZMacDataReq
   \   0000C4   4A4C         MOV.B   R12, R10
    772              
    773              // free the frame
    774              osal_mem_free( buf );
   \   0000C6   0C49         MOV.W   R9, R12
   \   0000C8   ........     CALLA   #osal_mem_free
   \   0000CC   023C         JMP     ??INTERP_DataReq_3
    775            }
    776            else
    777            {
    778              // flag a memory error
    779              status = ZMemError;
   \                     ??INTERP_DataReq_5:
   \   0000CE   7A401000     MOV.B   #0x10, R10
    780            }
    781            
    782            return ( status );
   \                     ??INTERP_DataReq_3:
   \   0000D2   4C4A         MOV.B   R10, R12
   \                     ??INTERP_DataReq_2:
   \   0000D4   31502400     ADD.W   #0x24, SP
   \   0000D8   3817         POPM.W  #0x4, R11
   \   0000DA   1001         RETA
    783            
    784          } /* INTERP_DataReq */
    785          
    786          /******************************************************************************
    787           * @fn          INTERP_DataReqMTU
    788           *
    789           * @brief       This function requests the MTU (Max Transport Unit) of the
    790           *              Inter-PAN Data Service.
    791           *
    792           * @param       none
    793           *
    794           * @return      uint8 - MTU
    795           */

   \                                 In  segment CODE, align 2
    796          uint8 INTERP_DataReqMTU( void )
   \                     INTERP_DataReqMTU:
    797          {
    798            uint8 mtu;
    799            uint8 hdrLen;
    800            
    801            // Use maximum header size for Stub APS header
    802            hdrLen = APS_FRAME_CTRL_FIELD_LEN +
    803                     APS_GROUP_ID_FIELD_LEN   +
    804                     APS_CLUSTERID_FIELD_LEN  +
    805                     APS_PROFILEID_FIELD_LEN;
    806          
    807            mtu = MAC_A_MAX_FRAME_SIZE - STUB_NWK_HDR_LEN - hdrLen;
    808          
    809            return ( mtu );
   \   000000   7C405D00     MOV.B   #0x5d, R12
   \   000004   1001         RETA
    810          
    811          } /* INTERP_DataReqMTU */
    812          
    813          /****************************************************************************
    814           * @fn          INTERP_DataConfirm
    815           *
    816           * @brief       This function processes the data confirm from the MAC layer.
    817           *
    818           * @param       dataCnf - data confirm primitive
    819           *
    820           * @return      none
    821           */

   \                                 In  segment CODE, align 2
    822          void INTERP_DataConfirm( ZMacDataCnf_t *dataCnf )
   \                     INTERP_DataConfirm:
    823          {
    824            afDataConfirm( appEndPoint, dataCnf->msduHandle, dataCnf->hdr.Status );
   \   000000   5E4C0100     MOV.B   0x1(R12), R14
   \   000004   5D4C0200     MOV.B   0x2(R12), R13
   \   000008   5C42....     MOV.B   &appEndPoint, R12
   \   00000C   ........     BRA     #afDataConfirm
    825          
    826          } /* INTERP_DataConfirm */
    827          
    828          /****************************************************************************
    829           * @fn          INTERP_DataIndication
    830           *
    831           * @brief       This function indicates the transfer of a data SPDU (MSDU)
    832           *              from the MAC layer to the local application layer entity.
    833           *
    834           * @param       dataInd - data indicate primitive
    835           *
    836           * @return      none
    837           */

   \                                 In  segment CODE, align 2
    838          void INTERP_DataIndication( macMcpsDataInd_t *dataInd )
   \                     INTERP_DataIndication:
    839          {
   \   000000   0A12         PUSH.W  R10
   \   000002   31804400     SUB.W   #0x44, SP
   \   000006   0A4C         MOV.W   R12, R10
    840            NLDE_FrameFormat_t snff;
    841            aps_FrameFormat_t saff;
    842            zAddrType_t srcAddr;
    843            NLDE_Signal_t sig;
    844          
    845            // parse the Stub NWK header
    846            StubNWK_ParseMsg( dataInd->msdu.p, dataInd->msdu.len, &snff );
   \   000008   0E41         MOV.W   SP, R14
   \   00000A   3E501A00     ADD.W   #0x1a, R14
   \   00000E   5D4C0400     MOV.B   0x4(R12), R13
   \   000012   1C4A0200     MOV.W   0x2(R10), R12
   \   000016   ........     CALLA   #StubNWK_ParseMsg
    847          
    848            // Fill in MAC destination address
    849            snff.macDstAddr = dataInd->mac.dstAddr.addr.shortAddr;
   \   00001A   914A1E002800 MOV.W   0x1e(R10), 0x28(SP)
    850            
    851            // fill in MAC source address (Stub NWK frame doesn't have address fields)
    852            osal_copyAddress( &srcAddr, (zAddrType_t *)&(dataInd->mac.srcAddr) );
   \   000020   0D4A         MOV.W   R10, R13
   \   000022   3D501400     ADD.W   #0x14, R13
   \   000026   0C41         MOV.W   SP, R12
   \   000028   3C503A00     ADD.W   #0x3a, R12
   \   00002C   ........     CALLA   #sAddrCpy
    853            
    854            // check if incoming frame is of the right type
    855            if ( snff.frameType != STUB_NWK_FRAME_TYPE )
   \   000030   F19003001C00 CMP.B   #0x3, 0x1c(SP)
   \   000036   5520         JNE     ??INTERP_DataIndication_1
    856              return;
    857              
    858            // check if incoming frame is of the right version
    859            if ( snff.protocolVersion != NLME_GetProtocolVersion() )
   \   000038   ........     CALLA   #NLME_GetProtocolVersion
   \   00003C   C19C1D00     CMP.B   R12, 0x1d(SP)
   \   000040   5020         JNE     ??INTERP_DataIndication_1
    860              return;
    861            
    862            // check if the remaining sun-fields are zero
    863            if ( ( snff.discoverRoute != 0 ) || ( snff.multicast != 0 )   ||
    864                 ( snff.secure != 0 )        || ( snff.srcRouteSet != 0 ) ||
    865                 ( snff.dstExtAddrSet != 0 ) || ( snff.srcExtAddrSet != 0 ) )
   \   000042   C1931E00     CMP.B   #0x0, 0x1e(SP)
   \   000046   4D20         JNE     ??INTERP_DataIndication_1
   \   000048   C1931F00     CMP.B   #0x0, 0x1f(SP)
   \   00004C   4A20         JNE     ??INTERP_DataIndication_1
   \   00004E   C1932000     CMP.B   #0x0, 0x20(SP)
   \   000052   4720         JNE     ??INTERP_DataIndication_1
   \   000054   C1933300     CMP.B   #0x0, 0x33(SP)
   \   000058   4420         JNE     ??INTERP_DataIndication_1
   \   00005A   C1932100     CMP.B   #0x0, 0x21(SP)
   \   00005E   4120         JNE     ??INTERP_DataIndication_1
   \   000060   C1932200     CMP.B   #0x0, 0x22(SP)
   \   000064   3E20         JNE     ??INTERP_DataIndication_1
    866            {
    867              return;
    868            }
    869            
    870            // parse the Stub APS header
    871            StubAPS_ParseMsg( &snff, &saff );
   \   000066   0D41         MOV.W   SP, R13
   \   000068   2D52         ADD.W   #0x4, R13
   \   00006A   0C41         MOV.W   SP, R12
   \   00006C   3C501A00     ADD.W   #0x1a, R12
   \   000070   ........     CALLA   #StubAPS_ParseMsg
    872          
    873            // check if incoming frame is of the right type
    874            if ( ( saff.FrmCtrl & APS_FRAME_TYPE_MASK ) != STUB_APS_FRAME )
   \   000074   5E410400     MOV.B   0x4(SP), R14
   \   000078   7EF00300     AND.B   #0x3, R14
   \   00007C   7E900300     CMP.B   #0x3, R14
   \   000080   3020         JNE     ??INTERP_DataIndication_1
    875              return;
    876             
    877            // check if delivery mode is of the right type
    878            if ( ( saff.FrmCtrl & APS_DELIVERYMODE_MASK ) == APS_FC_DM_INDIRECT )
   \   000082   5E410400     MOV.B   0x4(SP), R14
   \   000086   7EF00C00     AND.B   #0xc, R14
   \   00008A   6E92         CMP.B   #0x4, R14
   \   00008C   2A24         JEQ     ??INTERP_DataIndication_1
    879              return;
    880            
    881            // check if incoming frame is unsecured
    882            if ( saff.FrmCtrl & APS_FC_SECURITY )
   \   00008E   F1B020000400 BIT.B   #0x20, 0x4(SP)
   \   000094   262C         JC      ??INTERP_DataIndication_1
    883              return;
    884            
    885            // check if there's no extended header
    886            if ( saff.FrmCtrl & APS_FC_EXTENDED )
   \   000096   C1930400     CMP.B   #0x0, 0x4(SP)
   \   00009A   2338         JL      ??INTERP_DataIndication_1
    887                return;
    888            
    889            // Set the endpoints
    890            saff.DstEndPoint = appEndPoint;
   \   00009C   D142....0600 MOV.B   &appEndPoint, 0x6(SP)
    891            saff.SrcEndPoint = STUBAPS_INTER_PAN_EP;
   \   0000A2   F140FE000700 MOV.B   #0xfe, 0x7(SP)
    892            
    893            // Set the signal strength information
    894            sig.LinkQuality = dataInd->mac.mpduLinkQuality;
   \   0000A8   D14A32000000 MOV.B   0x32(R10), 0(SP)
    895            sig.correlation = dataInd->mac.correlation;
   \   0000AE   D14A33000100 MOV.B   0x33(R10), 0x1(SP)
    896            sig.rssi = dataInd->mac.rssi;
   \   0000B4   D14A34000200 MOV.B   0x34(R10), 0x2(SP)
    897            
    898            APSDE_DataIndication( &saff, &srcAddr, dataInd->mac.srcPanId, 
    899                                  &sig, snff.broadcastId, FALSE, dataInd->mac.timestamp );
   \   0000BA   1A122A00     PUSH.W  0x2a(R10)
   \   0000BE   1A122800     PUSH.W  0x28(R10)
   \   0000C2   4312         PUSH.B  #0x0
   \   0000C4   51123500     PUSH.B  0x35(SP)
   \   0000C8   0F41         MOV.W   SP, R15
   \   0000CA   3F52         ADD.W   #0x8, R15
   \   0000CC   1E4A2E00     MOV.W   0x2e(R10), R14
   \   0000D0   0D41         MOV.W   SP, R13
   \   0000D2   3D504200     ADD.W   #0x42, R13
   \   0000D6   0C41         MOV.W   SP, R12
   \   0000D8   3C500C00     ADD.W   #0xc, R12
   \   0000DC   ........     CALLA   #APSDE_DataIndication
    900          
    901          } /* INTERP_DataIndication */
   \   0000E0   3152         ADD.W   #0x8, SP
   \                     ??INTERP_DataIndication_1:
   \   0000E2   31504400     ADD.W   #0x44, SP
   \   0000E6   3A41         POP.W   R10
   \   0000E8   1001         RETA

   \                                 In  segment DATA16_ID, align 1, align-sorted
   \                     `?<Initializer for StubAPS_TaskID>`:
   \   000000   FF           DC8 255

   \                                 In  segment DATA16_ID, align 1, align-sorted
   \                     `?<Initializer for appTaskID>`:
   \   000000   FF           DC8 255
    902          
    903          
    904          /*********************************************************************
    905          *********************************************************************/

   Maximum stack usage in bytes:

   CSTACK Function
   ------ --------
      4   INTERP_DataConfirm
        4   -> afDataConfirm
     82   INTERP_DataIndication
       82   -> APSDE_DataIndication
       74   -> NLME_GetProtocolVersion
       74   -> StubAPS_ParseMsg
       74   -> StubNWK_ParseMsg
       74   -> sAddrCpy
     48   INTERP_DataReq
       48   -> NLME_GetProtocolVersion
       48   -> StubAPS_BuildFrameControl
       48   -> StubAPS_BuildMsg
       48   -> ZMacDataReq
       48   -> osal_mem_alloc
       48   -> osal_mem_free
       48   -> osal_memset
      4   INTERP_DataReqMTU
      6   StubAPS_BuildFrameControl
        6   -> sAddrExtCpy
      4   StubAPS_BuildMsg
        4   -> osal_memcpy
      4   StubAPS_Init
      4   StubAPS_InterPan
      8   StubAPS_ParseMsg
        8   -> osal_memset
     10   StubAPS_ProcessEvent
       10   -> INTERP_DataConfirm
       10   -> INTERP_DataIndication
       10   -> StubAPS_SetNewChannel
       10   -> ZMacSetReq
       10   -> nwk_setStateIdle
       10   -> osal_msg_allocate
       10   -> osal_msg_deallocate
       10   -> osal_msg_receive
       10   -> osal_msg_send
      4   StubAPS_RegisterApp
      8   StubAPS_SetInterPanChannel
        8   -> StubAPS_SetNewChannel
        8   -> ZMacGetReq
        8   -> ZMacSetReq
        8   -> nwk_setStateIdle
        8   -> osal_start_timerEx
      6   StubAPS_SetIntraPanChannel
        6   -> ZMacGetReq
        6   -> ZMacSetReq
        6   -> nwk_setStateIdle
      8   StubAPS_SetNewChannel
        8   -> ZMacSetReq
        8   -> ZMacStateIdle
        8   -> nwkDB_CountTypes
      4   StubAPS_ZMacCallback
        4   -> osal_msg_send
     12   StubNWK_ParseMsg
       12   -> NLDE_ParseFrameControl
       12   -> osal_memset


   Segment part sizes:

   Bytes  Function/Label
   -----  --------------
       1  ?<Initializer for StubAPS_TaskID>
       1  ?<Initializer for appTaskID>
      14  ?Subroutine0
       4  ?Subroutine1
      14  ?Subroutine2
      14  ?Subroutine3
      12  ?Subroutine4
       6  ?Subroutine5
      16  INTERP_DataConfirm
     234  INTERP_DataIndication
     220  INTERP_DataReq
       6  INTERP_DataReqMTU
     110  StubAPS_BuildFrameControl
      76  StubAPS_BuildMsg
      18  StubAPS_Init
      14  StubAPS_InterPan
     140  StubAPS_ParseMsg
     140  StubAPS_ProcessEvent
      14  StubAPS_RegisterApp
      82  StubAPS_SetInterPanChannel
      56  StubAPS_SetIntraPanChannel
      44  StubAPS_SetNewChannel
       1  StubAPS_TaskID
      72  StubAPS_ZMacCallback
      66  StubNWK_ParseMsg
       1  appEndPoint
       1  appTaskID
       1  channelChangeInProgress
       1  newChannel

 
 1 372 bytes in segment CODE
     2 bytes in segment DATA16_I
     2 bytes in segment DATA16_ID
     3 bytes in segment DATA16_Z
 
 1 372 bytes of CODE  memory
     2 bytes of CONST memory
     5 bytes of DATA  memory

Errors: none
Warnings: none
