###############################################################################
#                                                                             #
# IAR C/C++ Compiler V5.52.1.50724/W32 for MSP430       10/Jun/2013  16:27:26 #
# Copyright 1996-2013 IAR Systems AB.                                         #
#                                                                             #
#    __rt_version  =  3                                                       #
#    __double_size =  32                                                      #
#    __reg_r4      =  free                                                    #
#    __reg_r5      =  free                                                    #
#    __pic         =  no                                                      #
#    __core        =  430X                                                    #
#    __data_model  =  small                                                   #
#    Source file   =  C:\Texas Instruments\ZStack-MSP2618-2.5.1\Components\st #
#                     ack\zdo\ZDNwkMgr.c                                      #
#    Command line  =  -f "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\ #
#                     zstack\HomeAutomation\SampleLight\CC2520DB\..\..\..\Too #
#                     ls\MSP2618\f8wConfig.cfg" (-DZIGBEEPRO -DSECURE=0       #
#                     -DZG_SECURE_DYNAMIC=0 -DREFLECTOR                       #
#                     -DDEFAULT_CHANLIST=0x00000800                           #
#                     -DZDAPP_CONFIG_PAN_ID=0xFFFF -DNWK_START_DELAY=100      #
#                     -DEXTENDED_JOINING_RANDOM_MASK=0x007F                   #
#                     -DBEACON_REQUEST_DELAY=100                              #
#                     -DBEACON_REQ_DELAY_MASK=0x00FF                          #
#                     -DLINK_STATUS_JITTER_MASK=0x007F                        #
#                     -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_POLLED= #
#                     3000 -DNWK_INDIRECT_MSG_TIMEOUT=7 -DMAX_RREQ_ENTRIES=8  #
#                     -DAPSC_MAX_FRAME_RETRIES=3 -DNWK_MAX_DATA_RETRIES=2     #
#                     -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9              #
#                     -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40                #
#                     -DNWK_MAX_BINDING_ENTRIES=4                             #
#                     -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,       #
#                     0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00, 0x02,   #
#                     0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"                    #
#                     -DMAC_MAX_FRAME_SIZE=116 -DZDNWKMGR_MIN_TRANSMISSIONS=2 #
#                     0 -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=1000           #
#                     -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100         #
#                     -DREJOIN_POLL_RATE=440) -f "C:\Texas                    #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\Tools\MSP2618\f8 #
#                     wRouter.cfg" (-DCPU6MHZ -DMAC_CFG_APP_PENDING_QUEUE=TRU #
#                     E -DMAC_CFG_TX_DATA_MAX=5 -DMAC_CFG_TX_MAX=8            #
#                     -DMAC_CFG_RX_MAX=5 -DRTR_NWK) -f "C:\Texas              #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\Tools\MSP2618\f8 #
#                     wZCL.cfg" (-DZCL_READ -DZCL_WRITE -DZCL_BASIC           #
#                     -DZCL_IDENTIFY -DZCL_ON_OFF -DZCL_KEY_ESTABLISH         #
#                     -DZCL_KEY_ESTABLISHMENT_KEY_GENERATE_TIMEOUT=4          #
#                     -DZCL_KEY_ESTABLISHMENT_MAC_GENERATE_TIMEOUT=10         #
#                     -DZCL_KEY_ESTABLISHMENT_EKEY_GENERATE_TIMEOUT=10        #
#                     -DZCL_LOAD_CONTROL -DZCL_SIMPLE_METERING -DZCL_PRICING  #
#                     -DZCL_MESSAGE -DZCL_TUNNELING -DZCL_TOU)                #
#                     -DZCL_DEVICE_MGMT "C:\Texas                             #
#                     Instruments\ZStack-MSP2618-2.5.1\Components\stack\zdo\Z #
#                     DNwkMgr.c" -D MSP430F2618 -D ZTOOL_P1 -D MT_TASK -D     #
#                     MT_SYS_FUNC -D MT_ZDO_FUNC -D LCD_SUPPORTED -lC         #
#                     "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zst #
#                     ack\HomeAutomation\SampleLight\CC2520DB\Router\List\"   #
#                     -lA "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects #
#                     \zstack\HomeAutomation\SampleLight\CC2520DB\Router\List #
#                     \" --remarks --diag_suppress Pe001,Pe193,Pe236,Pe826    #
#                     -o "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\ #
#                     zstack\HomeAutomation\SampleLight\CC2520DB\Router\Obj\" #
#                      --debug -D__MSP430F2618__ -e --double=32 --clib -I     #
#                     "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zst #
#                     ack\HomeAutomation\SampleLight\CC2520DB\" -I "C:\Texas  #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\Source\" -I "C:\Texas  #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\Source\" -I         #
#                     "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zst #
#                     ack\HomeAutomation\SampleLight\CC2520DB\..\..\..\ZMain\ #
#                     MSP2618\" -I "C:\Texas Instruments\ZStack-MSP2618-2.5.1 #
#                     \Projects\zstack\HomeAutomation\SampleLight\CC2520DB\.. #
#                     \..\..\..\..\Components\hal\include\" -I "C:\Texas      #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \hal\target\MSP2618CC2520\" -I "C:\Texas                #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \mac\include\" -I "C:\Texas                             #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \mac\high_level\" -I "C:\Texas                          #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \mac\low_level\srf04\" -I "C:\Texas                     #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \mac\low_level\srf04\dual_chip\" -I "C:\Texas           #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \mt\" -I "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Pro #
#                     jects\zstack\HomeAutomation\SampleLight\CC2520DB\..\..\ #
#                     ..\..\..\Components\osal\include\" -I "C:\Texas         #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \osal\mcu\msp430\" -I "C:\Texas                         #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \services\saddr\" -I "C:\Texas                          #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \services\sdata\" -I "C:\Texas                          #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \stack\af\" -I "C:\Texas Instruments\ZStack-MSP2618-2.5 #
#                     .1\Projects\zstack\HomeAutomation\SampleLight\CC2520DB\ #
#                     ..\..\..\..\..\Components\stack\nwk\" -I "C:\Texas      #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \stack\sec\" -I "C:\Texas Instruments\ZStack-MSP2618-2. #
#                     5.1\Projects\zstack\HomeAutomation\SampleLight\CC2520DB #
#                     \..\..\..\..\..\Components\stack\sapi\" -I "C:\Texas    #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \stack\sys\" -I "C:\Texas Instruments\ZStack-MSP2618-2. #
#                     5.1\Projects\zstack\HomeAutomation\SampleLight\CC2520DB #
#                     \..\..\..\..\..\Components\stack\zcl\" -I "C:\Texas     #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \stack\zdo\" -I "C:\Texas Instruments\ZStack-MSP2618-2. #
#                     5.1\Projects\zstack\HomeAutomation\SampleLight\CC2520DB #
#                     \..\..\..\..\..\Components\zmac\" -I "C:\Texas          #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \zmac\f8w\" --core=430X --data_model=small -Ohz         #
#                     --multiplier=16s --require_prototypes                   #
#    List file     =  C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zsta #
#                     ck\HomeAutomation\SampleLight\CC2520DB\Router\List\ZDNw #
#                     kMgr.lst                                                #
#    Object file   =  C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zsta #
#                     ck\HomeAutomation\SampleLight\CC2520DB\Router\Obj\ZDNwk #
#                     Mgr.r43                                                 #
#                                                                             #
#                                                                             #
###############################################################################

C:\Texas Instruments\ZStack-MSP2618-2.5.1\Components\stack\zdo\ZDNwkMgr.c
      1          /**************************************************************************************************
      2            Filename:       ZDNwkMgr.c
      3            Revised:        $Date: 2007-10-17 15:38:45 -0700 (Wed, 17 Oct 2007) $
      4            Revision:       $Revision: 15716 $
      5          
      6            Description:    The ZigBee Network Manager.
      7          
      8          
      9            Copyright 2007 Texas Instruments Incorporated. All rights reserved.
     10          
     11            IMPORTANT: Your use of this Software is limited to those specific rights
     12            granted under the terms of a software license agreement between the user
     13            who downloaded the software, his/her employer (which must be your employer)
     14            and Texas Instruments Incorporated (the "License").  You may not use this
     15            Software unless you agree to abide by the terms of the License. The License
     16            limits your use, and you acknowledge, that the Software may not be modified,
     17            copied or distributed unless embedded on a Texas Instruments microcontroller
     18            or used solely and exclusively in conjunction with a Texas Instruments radio
     19            frequency transceiver, which is integrated into your product.  Other than for
     20            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     21            works of, modify, distribute, perform, display or sell this Software and/or
     22            its documentation for any purpose.
     23          
     24            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     25            PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, 
     26            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE, 
     27            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     28            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     29            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     30            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     31            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     32            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     33            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     34            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     35          
     36            Should you have any questions regarding your right to use this Software,
     37            contact Texas Instruments Incorporated at www.TI.com. 
     38          **************************************************************************************************/
     39          
     40          #ifdef __cplusplus
     41          extern "C"
     42          {
     43          #endif
     44          
     45          /******************************************************************************
     46           * INCLUDES
     47           */
     48          #include "ZComdef.h"
     49          #include "nwk_util.h"
     50          #include "ZDApp.h"
     51          #include "ZDObject.h"
     52          #include "ZGlobals.h"
     53          #include "ZDNwkMgr.h"
     54          
     55          #if defined( MT_ZDO_FUNC )
     56            #include "MT_ZDO.h"
     57          #endif
     58            
     59          #if defined ( LCD_SUPPORTED )
     60            #include "OnBoard.h"
     61          #endif
     62          
     63          /* HAL */
     64          #include "hal_lcd.h"
     65            
     66          /******************************************************************************
     67           * CONSTANTS
     68           */
     69          
     70          #define ONE_MINUTE             60000  // 1(m) * 60(s) * 1000(ms)
     71          
     72          #if defined ( LCD_SUPPORTED )

   \                                 In  segment DATA16_C, align 1, align-sorted
     73            const char NwkMgrStr_1[]     = "NM-fail not hi";
   \                     NwkMgrStr_1:
   \   000000   4E4D2D666169 DC8 "NM-fail not hi"
   \            6C206E6F7420
   \            686900      

   \                                 In  segment DATA16_C, align 1, align-sorted
     74            const char NwkMgrStr_2[]     = "NM-cur<last fail";
   \                     NwkMgrStr_2:
   \   000000   4E4D2D637572 DC8 "NM-cur<last fail"
   \            3C6C61737420
   \            6661696C00  

   \                                 In  segment DATA16_C, align 1, align-sorted
     75            const char NwkMgrStr_3[]     = "NM-energy too hi";
   \                     NwkMgrStr_3:
   \   000000   4E4D2D656E65 DC8 "NM-energy too hi"
   \            72677920746F
   \            6F20686900  

   \                                 In  segment DATA16_C, align 1, align-sorted
     76            const char NwkMgrStr_4[]     = "NM-energy not up";
   \                     NwkMgrStr_4:
   \   000000   4E4D2D656E65 DC8 "NM-energy not up"
   \            726779206E6F
   \            7420757000  
     77          #endif
     78            
     79          /******************************************************************************
     80           * TYPEDEFS
     81           */
     82          
     83          /*********************************************************************
     84           * GLOBAL VARIABLES
     85           */
     86            
     87          // Task ID for internal task/event processing. This variable will be
     88          // received when ZDNwkMgr_Init() is called.

   \                                 In  segment DATA16_Z, align 1, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
     89          uint8 ZDNwkMgr_TaskID = 0;
   \                     ZDNwkMgr_TaskID:
   \   000000                DS8 1
     90          
     91          /******************************************************************************
     92           * LOCAL VARIABLES
     93           */
     94          
     95          // Frequency Agility variables

   \                                 In  segment DATA16_Z, align 1, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
     96          uint8 ZDNwkMgr_MgmtNwkUpdateNotifyTransSeq = 0;
   \                     ZDNwkMgr_MgmtNwkUpdateNotifyTransSeq:
   \   000000                DS8 1

   \                                 In  segment DATA16_Z, align 2, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
     97          zAddrType_t ZDNwkMgr_MgmtNwkUpdateNotifyAddr;
   \                     ZDNwkMgr_MgmtNwkUpdateNotifyAddr:
   \   000000                DS8 10

   \                                 In  segment DATA16_Z, align 2, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
     98          uint16 ZDNwkMgr_UpdateNotifyTimer = 0;
   \                     ZDNwkMgr_UpdateNotifyTimer:
   \   000000                DS8 2

   \                                 In  segment DATA16_Z, align 1, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
     99          uint8  ZDNwkMgr_NumUpdateNotifySent = 0;
   \                     ZDNwkMgr_NumUpdateNotifySent:
   \   000000                DS8 1

   \                                 In  segment DATA16_Z, align 1, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
    100          uint8  ZDNwkMgr_WaitingForNotifyConfirm = FALSE;
   \                     ZDNwkMgr_WaitingForNotifyConfirm:
   \   000000                DS8 1

   \                                 In  segment DATA16_Z, align 2, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
    101          uint16 ZDNwkMgr_TotalTransmissions;
   \                     ZDNwkMgr_TotalTransmissions:
   \   000000                DS8 2

   \                                 In  segment DATA16_Z, align 2, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
    102          uint16 ZDNwkMgr_TxFailures;
   \                     ZDNwkMgr_TxFailures:
   \   000000                DS8 2
    103          

   \                                 In  segment DATA16_Z, align 2, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
    104          ZDO_MgmtNwkUpdateReq_t ZDNwkMgr_MgmtNwkUpdateReq;
   \                     ZDNwkMgr_MgmtNwkUpdateReq:
   \   000000                DS8 10
    105            
    106          #if defined ( NWK_MANAGER )
    107          uint16 ZDNwkMgr_UpdateRequestTimer = 0;
    108          uint8  ZDNwkMgr_LastChannelEnergy = 0;
    109          uint16 ZDNwkMgr_LastChannelFailureRate = 0;
    110          #endif // NWK_MANAGER
    111          

   \                                 In  segment DATA16_Z, align 1, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
    112          uint8 ZDNwkMgr_NewChannel;
   \                     ZDNwkMgr_NewChannel:
   \   000000                DS8 1
    113          
    114          // PAN ID Conflict variables
    115          #if defined ( NWK_MANAGER )
    116          uint8 ZDNwkMgr_PanIdUpdateInProgress = FALSE;
    117          #endif // NWK_MANAGER
    118          
    119          /*********************************************************************
    120           * GLOBAL FUNCTIONS
    121           */
    122          // Freguency Agility functions

   \                                 In  segment DATA16_Z, align 2, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
    123          void (*pZDNwkMgr_ReportChannelInterference)( NLME_ChanInterference_t *chanInterference ) = NULL;
   \                     pZDNwkMgr_ReportChannelInterference:
   \   000000                DS8 4

   \                                 In  segment DATA16_Z, align 2, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
    124          void (*pZDNwkMgr_ProcessDataConfirm)( afDataConfirm_t *afDataConfirm ) = NULL;
   \                     pZDNwkMgr_ProcessDataConfirm:
   \   000000                DS8 4

   \                                 In  segment DATA16_Z, align 2, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
    125          void (*pZDNwkMgr_EDScanConfirmCB)( NLME_EDScanConfirm_t *EDScanConfirm ) = NULL;
   \                     pZDNwkMgr_EDScanConfirmCB:
   \   000000                DS8 4
    126          
    127          // PAN ID Conflict functions

   \                                 In  segment DATA16_Z, align 2, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
    128          void (*pZDNwkMgr_NetworkReportCB)( ZDNwkMgr_NetworkReport_t *pReport ) = NULL;
   \                     pZDNwkMgr_NetworkReportCB:
   \   000000                DS8 4

   \                                 In  segment DATA16_Z, align 2, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
    129          void (*pZDNwkMgr_NetworkUpdateCB)( ZDNwkMgr_NetworkUpdate_t *pUpdate ) = NULL;
   \                     pZDNwkMgr_NetworkUpdateCB:
   \   000000                DS8 4
    130          
    131          /******************************************************************************
    132           * LOCAL FUNCTIONS
    133           */
    134          
    135          void ZDNwkMgr_ProcessServerDiscRsp( zdoIncomingMsg_t *inMsg );
    136          void ZDNwkMgr_SetNwkManagerAddr( uint16 nwkManagerAddr );
    137          
    138          // Frequency Agility functions
    139          static void ZDNwkMgr_ProcessMsgCBs( zdoIncomingMsg_t *inMsg );
    140          
    141          static void ZDNwkMgr_ProcessMgmtNwkUpdateReq( zdoIncomingMsg_t *inMsg );
    142          static void ZDNwkMgr_ProcessChannelInterference( ZDNwkMgr_ChanInterference_t *pChanInterference );
    143          static void ZDNwkMgr_ProcessEDScanConfirm( ZDNwkMgr_EDScanConfirm_t *pEDScanConfirm );
    144          static void ZDNwkMgr_CheckForChannelInterference( ZDNwkMgr_EDScanConfirm_t *pEDScanConfirm );
    145          static void ZDNwkMgr_BuildAndSendUpdateNotify( uint8 TransSeq, zAddrType_t *dstAddr,
    146                                                         uint16 totalTransmissions, uint16 txFailures,
    147                                                         ZDNwkMgr_EDScanConfirm_t *pEDScanConfirm, uint8 txOptions );
    148          void ZDNwkMgr_EDScanConfirmCB( NLME_EDScanConfirm_t *EDScanConfirm );
    149          void ZDNwkMgr_ProcessDataConfirm( afDataConfirm_t *afDataConfirm );
    150          void ZDNwkMgr_ReportChannelInterference( NLME_ChanInterference_t *chanInterference );
    151          
    152          #if defined ( NWK_MANAGER )
    153          static void ZDNwkMgr_ProcessMgmtNwkUpdateNotify( zdoIncomingMsg_t *inMsg );
    154          static void ZDNwkMgr_CheckForChannelChange( ZDO_MgmtNwkUpdateNotify_t *pNotify );
    155          #endif // NWK_MANAGER
    156          
    157          // PAN ID Conflict functions
    158          #if defined ( NWK_MANAGER )
    159          void ZDNwkMgr_NetworkReportCB( ZDNwkMgr_NetworkReport_t *pReport );
    160          void ZDNwkMgr_NetworkUpdateCB( ZDNwkMgr_NetworkUpdate_t *pUpdate );
    161          
    162          void ZDNwkMgr_ProcessNetworkReport( ZDNwkMgr_NetworkReport_t *pNetworkReport );
    163          void ZDNwkMgr_ProcessNetworkUpdate( ZDNwkMgr_NetworkUpdate_t *pNetworkUpdate );
    164          #endif // NWK_MANAGER
    165          
    166          /*********************************************************************
    167           * @fn      ZDNwkMgr_Init
    168           *
    169           * @brief   Initialization function for the Network Manager Task.
    170           *          This is called during initialization and should contain
    171           *          any application specific initialization (ie. hardware
    172           *          initialization/setup, table initialization, power up
    173           *          notificaiton ... ).
    174           *
    175           * @param   task_id - the ID assigned by OSAL.  This ID should be
    176           *                    used to send messages and set timers.
    177           *
    178           * @return  none
    179           */

   \                                 In  segment CODE, align 2
    180          void ZDNwkMgr_Init( byte task_id )
   \                     ZDNwkMgr_Init:
    181          {
    182            // Save the task ID
    183            ZDNwkMgr_TaskID = task_id;
   \   000000   C24C....     MOV.B   R12, &ZDNwkMgr_TaskID
    184          
    185            ZDO_RegisterForZDOMsg( ZDNwkMgr_TaskID, Server_Discovery_rsp );
   \   000004   3D401580     MOV.W   #0x8015, R13
   \   000008   ........     CALLA   #ZDO_RegisterForZDOMsg
    186          
    187            // Frequecy Agility initialization
    188            ZDO_RegisterForZDOMsg( ZDNwkMgr_TaskID, Mgmt_NWK_Update_req );
   \   00000C   3D403800     MOV.W   #0x38, R13
   \   000010   5C42....     MOV.B   &ZDNwkMgr_TaskID, R12
   \   000014   ........     CALLA   #ZDO_RegisterForZDOMsg
    189          #if defined ( NWK_MANAGER )
    190            ZDO_RegisterForZDOMsg( ZDNwkMgr_TaskID, Mgmt_NWK_Update_notify );
    191          #endif // NWK_MANAGER
    192          
    193            pZDNwkMgr_EDScanConfirmCB = ZDNwkMgr_EDScanConfirmCB;
   \   000018   B240........ MOV.W   #LWRD(ZDNwkMgr_EDScanConfirmCB), &pZDNwkMgr_EDScanConfirmCB
   \   00001E   B240........ MOV.W   #HWRD(ZDNwkMgr_EDScanConfirmCB), &pZDNwkMgr_EDScanConfirmCB + 2
    194            pZDNwkMgr_ProcessDataConfirm = ZDNwkMgr_ProcessDataConfirm;
   \   000024   B240........ MOV.W   #LWRD(ZDNwkMgr_ProcessDataConfirm), &pZDNwkMgr_ProcessDataConfirm
   \   00002A   B240........ MOV.W   #HWRD(ZDNwkMgr_ProcessDataConfirm), &pZDNwkMgr_ProcessDataConfirm + 2
    195            pZDNwkMgr_ReportChannelInterference = ZDNwkMgr_ReportChannelInterference;
   \   000030   B240........ MOV.W   #LWRD(ZDNwkMgr_ReportChannelInterference), &pZDNwkMgr_ReportChannelInterference
   \   000036   B240........ MOV.W   #HWRD(ZDNwkMgr_ReportChannelInterference), &pZDNwkMgr_ReportChannelInterference + 2
    196            
    197            // PAN ID Conflict initialization
    198          #if defined ( NWK_MANAGER )
    199            pZDNwkMgr_NetworkReportCB = ZDNwkMgr_NetworkReportCB;
    200            pZDNwkMgr_NetworkUpdateCB = ZDNwkMgr_NetworkUpdateCB;
    201          #endif // NWK_MANAGER
    202            
    203            ZDNwkMgr_MgmtNwkUpdateNotifyAddr.addrMode = Addr16Bit;
   \   00003C   E243....     MOV.B   #0x2, &ZDNwkMgr_MgmtNwkUpdateNotifyAddr + 8
    204            ZDNwkMgr_MgmtNwkUpdateNotifyAddr.addr.shortAddr = INVALID_NODE_ADDR;
   \   000040   B240FEFF.... MOV.W   #0xfffe, &ZDNwkMgr_MgmtNwkUpdateNotifyAddr
    205          }
   \   000046   1001         RETA
    206          
    207          /*********************************************************************
    208           * @fn      ZDNwkMgr_event_loop
    209           *
    210           * @brief   Main event loop for the Network Manager task. This function
    211           *          is called to process all events for the task.  Events
    212           *          include timers, messages and any other user defined events.
    213           *
    214           * @param   task_id  - The OSAL assigned task ID.
    215           * @param   events - events to process.  This is a bit map and can
    216           *                   contain more than one event.
    217           *
    218           * @return  none
    219           */

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine0:
   \   000000   3E4060EA     MOV.W   #0xea60, R14
   \   000004   2D43         MOV.W   #0x2, R13
   \   000006                REQUIRE ??Subroutine0_0
   \   000006                // Fall through to label ??Subroutine0_0

   \                                 In  segment CODE, align 2
   \                     ??Subroutine0_0:
   \   000000   5C42....     MOV.B   &ZDNwkMgr_TaskID, R12
   \   000004   ........     BRA     #osal_start_timerEx

   \                                 In  segment CODE, align 2
    220          UINT16 ZDNwkMgr_event_loop( byte task_id, UINT16 events )
   \                     ZDNwkMgr_event_loop:
    221          {
   \   000000   1B15         PUSHM.W #0x2, R11
   \   000002   0A4D         MOV.W   R13, R10
    222            osal_event_hdr_t *msgPtr;
    223            (void)task_id;  // Intentionally unreferenced parameter
    224          
    225            if ( events & SYS_EVENT_MSG )
   \   000004   0D93         CMP.W   #0x0, R13
   \   000006   4034         JGE     ??ZDNwkMgr_event_loop_5
    226            {
    227              msgPtr = (osal_event_hdr_t *)osal_msg_receive( ZDNwkMgr_TaskID );
   \   000008   063C         JMP     ??ZDNwkMgr_event_loop_6
    228              while ( msgPtr )
    229              {
    230                switch ( msgPtr->event )
    231                {
    232                  case ZDO_CB_MSG:
    233                    // ZDO sends the message that we registered for
    234                    ZDNwkMgr_ProcessMsgCBs( (zdoIncomingMsg_t *)msgPtr );
    235                    break;
    236                   
    237                  case NM_CHANNEL_INTERFERE:
    238                    // NWK layer sends the message when it detectes Channel Interference
    239                    ZDNwkMgr_ProcessChannelInterference( (ZDNwkMgr_ChanInterference_t *)msgPtr );
    240                    break;
    241             
    242                  case NM_ED_SCAN_CONFIRM:
    243                    // NWK layer sends the message when it receives an ED scan confirmation
    244                    ZDNwkMgr_ProcessEDScanConfirm( (ZDNwkMgr_EDScanConfirm_t *)msgPtr );
   \                     ??ZDNwkMgr_event_loop_0:
   \   00000A   0C4B         MOV.W   R11, R12
   \   00000C   ........     CALLA   #ZDNwkMgr_ProcessEDScanConfirm
    245                    break;
    246          #if defined ( NWK_MANAGER )
    247                  case ZDO_NETWORK_REPORT:
    248                    // NWK layer sends this message when it receives a Network Report message
    249                    ZDNwkMgr_ProcessNetworkReport( (ZDNwkMgr_NetworkReport_t *)msgPtr );
    250                    break;
    251                 
    252                  case ZDO_NETWORK_UPDATE:
    253                    // NKW layer sends this message when it receives a Network Update message
    254                    ZDNwkMgr_ProcessNetworkUpdate( (ZDNwkMgr_NetworkUpdate_t *)msgPtr );
    255                    break;
    256          #endif // NWK_MANAGER         
    257                  default:
    258                    break;
    259                }
    260          
    261                // Release the memory
    262                osal_msg_deallocate( (uint8 *)msgPtr );
   \                     ??ZDNwkMgr_event_loop_1:
   \   000010   0C4B         MOV.W   R11, R12
   \   000012   ........     CALLA   #osal_msg_deallocate
    263          
    264                // Next
    265                msgPtr = (osal_event_hdr_t *)osal_msg_receive( ZDNwkMgr_TaskID );
   \                     ??ZDNwkMgr_event_loop_6:
   \   000016   5C42....     MOV.B   &ZDNwkMgr_TaskID, R12
   \   00001A   ........     CALLA   #osal_msg_receive
   \   00001E   0B4C         MOV.W   R12, R11
   \   000020   0B93         CMP.W   #0x0, R11
   \   000022   2F24         JEQ     ??ZDNwkMgr_event_loop_7
   \   000024   6E4B         MOV.B   @R11, R14
   \   000026   7E803100     SUB.B   #0x31, R14
   \   00002A   1524         JEQ     ??ZDNwkMgr_event_loop_8
   \   00002C   5E83         SUB.B   #0x1, R14
   \   00002E   ED27         JEQ     ??ZDNwkMgr_event_loop_0
   \   000030   7E80A100     SUB.B   #0xa1, R14
   \   000034   ED23         JNE     ??ZDNwkMgr_event_loop_1
   \   000036   1F4B0E00     MOV.W   0xe(R11), R15
   \   00003A   3F803800     SUB.W   #0x38, R15
   \   00003E   0724         JEQ     ??ZDNwkMgr_event_loop_9
   \   000040   3F80DD7F     SUB.W   #0x7fdd, R15
   \   000044   E523         JNE     ??ZDNwkMgr_event_loop_1
   \   000046   0C4B         MOV.W   R11, R12
   \   000048   ........     CALLA   #ZDNwkMgr_ProcessServerDiscRsp
   \   00004C   E13F         JMP     ??ZDNwkMgr_event_loop_1
   \                     ??ZDNwkMgr_event_loop_9:
   \   00004E   0C4B         MOV.W   R11, R12
   \   000050   ........     CALLA   #ZDNwkMgr_ProcessMgmtNwkUpdateReq
   \   000054   DD3F         JMP     ??ZDNwkMgr_event_loop_1
   \                     ??ZDNwkMgr_event_loop_8:
   \   000056   E292....     CMP.B   #0x4, &ZDNwkMgr_NumUpdateNotifySent
   \   00005A   DA2F         JC      ??ZDNwkMgr_event_loop_1
   \   00005C   5E42....     MOV.B   &_NIB + 46, R14
   \   000060   3C4000F8     MOV.W   #0xf800, R12
   \   000064   3D40FF07     MOV.W   #0x7ff, R13
   \   000068   ........     CALLA   #NLME_EDScanRequest
   \   00006C   4C93         CMP.B   #0x0, R12
   \   00006E   D023         JNE     ??ZDNwkMgr_event_loop_1
   \   000070   924B0200.... MOV.W   0x2(R11), &ZDNwkMgr_TotalTransmissions
   \   000076   924B0400.... MOV.W   0x4(R11), &ZDNwkMgr_TxFailures
   \   00007C   F243....     MOV.B   #0xff, &ZDNwkMgr_MgmtNwkUpdateReq + 5
   \   000080   C73F         JMP     ??ZDNwkMgr_event_loop_1
    266              }
    267              
    268              // Return unprocessed events
    269              return (events ^ SYS_EVENT_MSG);
   \                     ??ZDNwkMgr_event_loop_7:
   \   000082   3AE00080     XOR.W   #0x8000, R10
   \   000086   313C         JMP     ??ZDNwkMgr_event_loop_4
    270            }
    271          
    272            if ( events & ZDNWKMGR_CHANNEL_CHANGE_EVT )
   \                     ??ZDNwkMgr_event_loop_5:
   \   000088   1DB3         BIT.W   #0x1, R13
   \   00008A   0F28         JNC     ??ZDNwkMgr_event_loop_10
    273            {       
    274              // Switch channel
    275              _NIB.nwkLogicalChannel = ZDNwkMgr_NewChannel;
   \   00008C   D242........ MOV.B   &ZDNwkMgr_NewChannel, &_NIB + 24
    276              ZMacSetReq( ZMacChannel, &ZDNwkMgr_NewChannel );
   \   000092   3D40....     MOV.W   #ZDNwkMgr_NewChannel, R13
   \   000096   7C40E100     MOV.B   #0xe1, R12
   \   00009A   ........     CALLA   #ZMacSetReq
    277           
    278              // Our Channel has been changed -- notify to save info into NV
    279              ZDApp_NwkStateUpdateCB();
   \   00009E   ........     CALLA   #ZDApp_NwkStateUpdateCB
    280              
    281              // Reset the total transmit count and the transmit failure counters
    282              _NIB.nwkTotalTransmissions = 0;
   \   0000A2   ........     CALLA   #?Subroutine2
    283              nwkTransmissionFailures( TRUE );
    284              
    285              return ( events ^ ZDNWKMGR_CHANNEL_CHANGE_EVT );
   \                     ??CrossCallReturnLabel_2:
   \   0000A6   1AE3         XOR.W   #0x1, R10
   \   0000A8   203C         JMP     ??ZDNwkMgr_event_loop_4
    286            }
    287          
    288            if ( events & ZDNWKMGR_UPDATE_NOTIFY_EVT )
   \                     ??ZDNwkMgr_event_loop_10:
   \   0000AA   2DB3         BIT.W   #0x2, R13
   \   0000AC   0C28         JNC     ??ZDNwkMgr_event_loop_11
    289            {
    290              // Update the Update Notify timer
    291              if ( ZDNwkMgr_UpdateNotifyTimer > 0 )
   \   0000AE   8293....     CMP.W   #0x0, &ZDNwkMgr_UpdateNotifyTimer
   \   0000B2   0524         JEQ     ??ZDNwkMgr_event_loop_12
    292              {
    293                ZDNwkMgr_UpdateNotifyTimer--;
   \   0000B4   B253....     ADD.W   #0xffff, &ZDNwkMgr_UpdateNotifyTimer
    294                osal_start_timerEx( ZDNwkMgr_TaskID, ZDNWKMGR_UPDATE_NOTIFY_EVT, ONE_MINUTE );
   \   0000B8   ........     CALLA   #?Subroutine0
    295              }
   \                     ??CrossCallReturnLabel_7:
   \   0000BC   023C         JMP     ??ZDNwkMgr_event_loop_13
    296              else
    297              {
    298                ZDNwkMgr_NumUpdateNotifySent = 0;
   \                     ??ZDNwkMgr_event_loop_12:
   \   0000BE   C243....     MOV.B   #0x0, &ZDNwkMgr_NumUpdateNotifySent
    299              }
    300              
    301              return ( events ^ ZDNWKMGR_UPDATE_NOTIFY_EVT );
   \                     ??ZDNwkMgr_event_loop_13:
   \   0000C2   2AE3         XOR.W   #0x2, R10
   \   0000C4   123C         JMP     ??ZDNwkMgr_event_loop_4
    302            }
    303            
    304          #if defined ( NWK_MANAGER )
    305            if ( events & ZDNWKMGR_UPDATE_REQUEST_EVT )
    306            {
    307              // Update the Update Request timer
    308              if ( ZDNwkMgr_UpdateRequestTimer > 0 )
    309              {
    310                ZDNwkMgr_UpdateRequestTimer--;
    311                osal_start_timerEx( ZDNwkMgr_TaskID, ZDNWKMGR_UPDATE_REQUEST_EVT, ONE_MINUTE );
    312              }
    313              
    314              return ( events ^ ZDNWKMGR_UPDATE_REQUEST_EVT );
    315            }
    316          #endif // NWK_MANAGER
    317            
    318            if ( events & ZDNWKMGR_SCAN_REQUEST_EVT )
   \                     ??ZDNwkMgr_event_loop_11:
   \   0000C6   3DB2         BIT.W   #0x8, R13
   \   0000C8   1228         JNC     ??ZDNwkMgr_event_loop_14
    319            {  
    320              if ( ZDNwkMgr_MgmtNwkUpdateReq.scanCount > 0 )
   \   0000CA   C293....     CMP.B   #0x0, &ZDNwkMgr_MgmtNwkUpdateReq + 5
   \   0000CE   0C24         JEQ     ??ZDNwkMgr_event_loop_15
    321              {
    322                if (  NLME_EDScanRequest( ZDNwkMgr_MgmtNwkUpdateReq.channelMask, 
    323                                          ZDNwkMgr_MgmtNwkUpdateReq.scanDuration ) == ZSuccess )
   \   0000D0   5E42....     MOV.B   &ZDNwkMgr_MgmtNwkUpdateReq + 4, R14
   \   0000D4   1C42....     MOV.W   &ZDNwkMgr_MgmtNwkUpdateReq, R12
   \   0000D8   1D42....     MOV.W   &ZDNwkMgr_MgmtNwkUpdateReq + 2, R13
   \   0000DC   ........     CALLA   #NLME_EDScanRequest
   \   0000E0   4C93         CMP.B   #0x0, R12
   \   0000E2   0220         JNE     ??ZDNwkMgr_event_loop_15
    324                {
    325                  ZDNwkMgr_MgmtNwkUpdateReq.scanCount--;
   \   0000E4   F253....     ADD.B   #0xff, &ZDNwkMgr_MgmtNwkUpdateReq + 5
    326                }
    327              }
    328                
    329              return ( events ^ ZDNWKMGR_SCAN_REQUEST_EVT );
   \                     ??ZDNwkMgr_event_loop_15:
   \   0000E8   3AE2         XOR.W   #0x8, R10
   \                     ??ZDNwkMgr_event_loop_4:
   \   0000EA   0C4A         MOV.W   R10, R12
   \   0000EC   013C         JMP     ??ZDNwkMgr_event_loop_16
    330            }
    331            
    332            // Discard or make more handlers
    333            return 0;
   \                     ??ZDNwkMgr_event_loop_14:
   \   0000EE   0C43         MOV.W   #0x0, R12
   \                     ??ZDNwkMgr_event_loop_16:
   \   0000F0   1A17         POPM.W  #0x2, R11
   \   0000F2   1001         RETA
    334          }

   \                                 In  segment CODE, align 2
   \                     ?Subroutine2:
   \   000000   8243....     MOV.W   #0x0, &_NIB + 112
   \   000004   5C43         MOV.B   #0x1, R12
   \   000006   ........     BRA     #nwkTransmissionFailures
    335          
    336          /*********************************************************************
    337           * @fn      ZDNwkMgr_ProcessMsgCBs
    338           *
    339           * @brief   Process the incoming messages.
    340           *
    341           * @param   msgPtr - message to process
    342           *
    343           * @return  TRUE if message to be freed. FALSE otherwise.
    344           */
    345          static void ZDNwkMgr_ProcessMsgCBs( zdoIncomingMsg_t *inMsg )
    346          {
    347            switch ( inMsg->clusterID )
    348            {   
    349              case Mgmt_NWK_Update_req:
    350                ZDNwkMgr_ProcessMgmtNwkUpdateReq( inMsg );
    351                break;    
    352          #if defined ( NWK_MANAGER )  
    353              case Mgmt_NWK_Update_notify:
    354                ZDNwkMgr_ProcessMgmtNwkUpdateNotify( inMsg );
    355                break;
    356          #endif // NWK_MANAGER
    357              case Server_Discovery_rsp:
    358                ZDNwkMgr_ProcessServerDiscRsp( inMsg );
    359                break;
    360                
    361              default:
    362                // Unknown message
    363                break;
    364            }
    365          }
    366          
    367          /*********************************************************************
    368           * Frequency Agility Routines
    369           */
    370          #if defined ( NWK_MANAGER )
    371          /*********************************************************************
    372           * @fn          ZDNwkMgr_ProcessMgmtNwkUpdateNotify
    373           *
    374           * @brief       This function processes the incoming Management
    375           *              Network Update notify.
    376           *
    377           * @param       pUpdateNotify - notify message
    378           *
    379           * @return      TRUE if message to be freed. FALSE otherwise.
    380           */
    381          static void ZDNwkMgr_ProcessMgmtNwkUpdateNotify( zdoIncomingMsg_t *inMsg )
    382          {
    383            if ( zgNwkMgrMode == ZDNWKMGR_ENABLE )
    384            {
    385              ZDO_MgmtNwkUpdateNotify_t *pNotify = ZDO_ParseMgmtNwkUpdateNotify( inMsg ); 
    386              if ( pNotify )
    387              {
    388                ZDNwkMgr_CheckForChannelChange( pNotify );
    389          
    390                osal_mem_free( pNotify );
    391              }
    392            }
    393          }
    394          
    395          /*********************************************************************
    396           * @fn          ZDNwkMgr_CheckForChannelChange
    397           *
    398           * @brief       This function processes the incoming Management Network
    399           *              Update notify and starts an Update Request if a channel
    400           *              change is needed.
    401           *
    402           * @param       pUpdateNotify - notify message
    403           *
    404           * @return      none
    405           */
    406          static void ZDNwkMgr_CheckForChannelChange( ZDO_MgmtNwkUpdateNotify_t *pNotify )
    407          {
    408            uint8  i;
    409            uint16 failureRate;
    410            uint8  lowestEnergyIndex;
    411            uint8  lowestEnergyValue = 0xFF;
    412                
    413            // If any device has more than 50% transmission failures, a channel
    414            // change should be considered
    415            failureRate = ( pNotify->transmissionFailures * 100 ) / pNotify->totalTransmissions;
    416            if ( failureRate < ZDNWKMGR_CC_TX_FAILURE )
    417            {
    418          #if defined ( LCD_SUPPORTED )
    419              HalLcdWriteString( (char*)NwkMgrStr_1, HAL_LCD_LINE_1 );
    420              HalLcdWriteStringValueValue( ": ", failureRate, 10, ZDNWKMGR_CC_TX_FAILURE, 10, HAL_LCD_LINE_2 );
    421          #endif
    422              return;
    423            }
    424          
    425            // If the current failure rate is higher than the last failure rate,
    426            // a channel change should be considered
    427            if ( failureRate < ZDNwkMgr_LastChannelFailureRate )
    428            {
    429          #if defined ( LCD_SUPPORTED )
    430              HalLcdWriteString( (char*)NwkMgrStr_2, HAL_LCD_LINE_1 );
    431              HalLcdWriteStringValueValue( ": ", failureRate, 10, 
    432                                           ZDNwkMgr_LastChannelFailureRate, 10, HAL_LCD_LINE_2 );
    433          #endif
    434              return;
    435            }
    436            
    437            // Select a single channel based on the Mgmt_NWK_Update_notify based on
    438            // the lowest energy. This is the proposed new channel. 
    439            for ( i = 0; i < pNotify->listCount; i++ )
    440            {
    441              if ( pNotify->energyValues[i] < lowestEnergyValue )
    442              {
    443                lowestEnergyIndex = i;
    444                lowestEnergyValue = pNotify->energyValues[i];
    445              }
    446            }
    447                
    448            // If this new channel does not have an energy level below an acceptable
    449            // threshold, a channel change should not be done.
    450            if ( lowestEnergyValue > ZDNWKMGR_ACCEPTABLE_ENERGY_LEVEL )
    451            {
    452          #if defined ( LCD_SUPPORTED )
    453              HalLcdWriteString( (char*)NwkMgrStr_3, HAL_LCD_LINE_1 );
    454              HalLcdWriteStringValueValue( ": ", lowestEnergyValue, 10, 
    455                                           ZDNWKMGR_ACCEPTABLE_ENERGY_LEVEL, 10, HAL_LCD_LINE_2 );
    456          #endif
    457              return;
    458            }
    459          
    460            // Channel change should be done -- find out the new active channel
    461            for ( i = 0; i < ED_SCAN_MAXCHANNELS; i++ )
    462            {
    463              if ( ( (uint32)1 << i ) & pNotify->scannedChannels )
    464              {
    465                if ( lowestEnergyIndex == 0 )
    466                  break;
    467                lowestEnergyIndex--;
    468              }
    469            }
    470            
    471            if ( ( _NIB.nwkLogicalChannel != i ) && ( ZDNwkMgr_UpdateRequestTimer == 0 ) )
    472            {
    473              uint32 channelMask;
    474              zAddrType_t dstAddr;
    475              
    476              // The new channel
    477              ZDNwkMgr_NewChannel = i;
    478                  
    479              // Prior to changing channels, the network manager should store the 
    480              // energy scan value as the last energy scan value and the failure 
    481              // rate from the existing channel as the last failure rate.  These 
    482              // values are useful to allow comparison of the failure rate and energy
    483              // level on the previous channel to evaluate if the network is causing
    484              // its own interference.
    485              ZDNwkMgr_LastChannelEnergy = lowestEnergyValue;
    486              ZDNwkMgr_LastChannelFailureRate = failureRate;
    487                 
    488              // The network manager should broadcast a Mgmt_NWK_Update_req notifying
    489              // devices of the new channel.  The broadcast shall be to all routers 
    490              // and coordinator.
    491              dstAddr.addrMode = AddrBroadcast;
    492              dstAddr.addr.shortAddr = NWK_BROADCAST_SHORTADDR_DEVRXON;
    493              channelMask = (uint32)1 << i;
    494                  
    495              // Increment the nwkUpdateId parameter and set the updateID in the beacon
    496              NLME_SetUpdateID(_NIB.nwkUpdateId + 1); 
    497              
    498              ZDP_MgmtNwkUpdateReq( &dstAddr, channelMask, 0xfe, 0, _NIB.nwkUpdateId, 0 );
    499                  
    500              // The network manager shall set a timer based on the value of 
    501              // apsChannelTimer upon issue of a Mgmt_NWK_Update_req that changes 
    502              // channels and shall not issue another such command until this 
    503              // timer expires.  
    504              ZDNwkMgr_UpdateRequestTimer = ZDNWKMGR_UPDATE_REQUEST_TIMER;
    505              osal_start_timerEx( ZDNwkMgr_TaskID, ZDNWKMGR_UPDATE_REQUEST_EVT, ONE_MINUTE );
    506                            
    507              // Upon receipt of a Mgmt_NWK_Update_req with a change of channels, 
    508              // the local network manager shall set a timer equal to the 
    509              // nwkNetworkBroadcastDeliveryTime and shall switch channels upon 
    510              // expiration of this timer.  NOTE: since we won't recevied our own
    511              // broadcasted Update Request, we start the channel change timer here.  
    512              osal_start_timerEx( ZDNwkMgr_TaskID, ZDNWKMGR_CHANNEL_CHANGE_EVT, 
    513                                  ZDNWKMGR_BCAST_DELIVERY_TIME );
    514            }
    515          }
    516          #endif  // NWK_MANAGER
    517          
    518          /*********************************************************************
    519           * @fn          ZDNwkMgr_ProcessMgmtNwkUpdateReq
    520           *
    521           * @brief       This function processes the incoming Management
    522           *              Network Update request and starts the request (if needed).
    523           *
    524           * @param       Request message
    525           *
    526           * @return      none
    527           */

   \                                 In  segment CODE, align 2
    528          static void ZDNwkMgr_ProcessMgmtNwkUpdateReq( zdoIncomingMsg_t *inMsg )
   \                     ZDNwkMgr_ProcessMgmtNwkUpdateReq:
    529          {
   \   000000   0A12         PUSH.W  R10
   \   000002   31800A00     SUB.W   #0xa, SP
   \   000006   0A4C         MOV.W   R12, R10
    530            ZDO_MgmtNwkUpdateReq_t Req;
    531            
    532            ZDO_ParseMgmtNwkUpdateReq( inMsg, &Req );
   \   000008   0D41         MOV.W   SP, R13
   \   00000A   0D53         ADD.W   #0x0, R13
   \   00000C   ........     CALLA   #ZDO_ParseMgmtNwkUpdateReq
    533             
    534            if ( Req.scanDuration <= 0x05 )
   \   000010   5E410400     MOV.B   0x4(SP), R14
   \   000014   7E900600     CMP.B   #0x6, R14
   \   000018   222C         JC      ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_1
    535            {
    536              // Request is to scan over channelMask. The result will be reported by Confirm   
    537              if ( ( !inMsg->wasBroadcast )                     && 
    538                   ( Req.scanCount >  ZDNWKMGR_MIN_SCAN_COUNT ) && 
    539                   ( Req.scanCount <= ZDNWKMGR_MAX_SCAN_COUNT ) )
   \   00001A   CA930C00     CMP.B   #0x0, 0xc(R10)
   \   00001E   8020         JNE     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_2
   \   000020   5F410500     MOV.B   0x5(SP), R15
   \   000024   4F93         CMP.B   #0x0, R15
   \   000026   7C24         JEQ     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_2
   \   000028   7F900600     CMP.B   #0x6, R15
   \   00002C   792C         JC      ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_2
    540              {
    541                if ( NLME_EDScanRequest( Req.channelMask, Req.scanDuration ) == ZSuccess )
   \   00002E   2C41         MOV.W   @SP, R12
   \   000030   1D410200     MOV.W   0x2(SP), R13
   \   000034   ........     CALLA   #NLME_EDScanRequest
   \   000038   4C93         CMP.B   #0x0, R12
   \   00003A   7220         JNE     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_2
    542                {
    543                  // Save off the information to be used for the notify
    544                  ZDNwkMgr_MgmtNwkUpdateNotifyTransSeq            = inMsg->TransSeq;
   \   00003C   D24A1100.... MOV.B   0x11(R10), &ZDNwkMgr_MgmtNwkUpdateNotifyTransSeq
    545                  ZDNwkMgr_MgmtNwkUpdateNotifyAddr.addr.shortAddr = inMsg->srcAddr.addr.shortAddr;
   \   000042   924A0200.... MOV.W   0x2(R10), &ZDNwkMgr_MgmtNwkUpdateNotifyAddr
    546                  
    547                  Req.scanCount--;
   \   000048   F1530500     ADD.B   #0xff, 0x5(SP)
    548                  
    549                  // Save off scan info for the subsequent scans
    550                  ZDNwkMgr_MgmtNwkUpdateReq = Req;
   \   00004C   3C40....     MOV.W   #ZDNwkMgr_MgmtNwkUpdateReq, R12
   \   000050   0E41         MOV.W   SP, R14
   \   000052   0E53         ADD.W   #0x0, R14
   \   000054   3D400500     MOV.W   #0x5, R13
   \   000058   ........     CALLA   #?CopyMemoryWords
   \   00005C   613C         JMP     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_2
    551                }
    552              }
    553            }
    554            else if ( Req.scanDuration == 0xFE )
   \                     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_1:
   \   00005E   7E90FE00     CMP.B   #0xfe, R14
   \   000062   2520         JNE     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_3
    555            {
    556              // Request is to change Channel. The command provide a new active
    557              // channel as a single channel in the channelMask.
    558              if ( Req.nwkUpdateId > _NIB.nwkUpdateId )
   \   000064   5C410600     MOV.B   0x6(SP), R12
   \   000068   C29C....     CMP.B   R12, &_NIB + 114
   \   00006C   592C         JC      ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_2
    559              {
    560                uint8 i;
    561                
    562                // Set update ID in the Beacon
    563                NLME_SetUpdateID(Req.nwkUpdateId); 
   \   00006E   ........     CALLA   #NLME_SetUpdateID
    564                
    565                // Find out the new active channel
    566                for ( i = 0; i < ED_SCAN_MAXCHANNELS; i++ )
   \   000072   4F43         MOV.B   #0x0, R15
    567                {
    568                  if ( ( (uint32)1 << i ) & Req.channelMask )
   \                     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_0:
   \   000074   2C41         MOV.W   @SP, R12
   \   000076   1D410200     MOV.W   0x2(SP), R13
   \   00007A   4E4F         MOV.B   R15, R14
   \   00007C   ........     CALLA   #?ShiftRight32u
   \   000080   5CB3         BIT.B   #0x1, R12
   \   000082   0420         JNE     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_4
    569                  {
    570                    break;
    571                  }
    572                }
   \   000084   5F53         ADD.B   #0x1, R15
   \   000086   7F901B00     CMP.B   #0x1b, R15
   \   00008A   F42B         JNC     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_0
    573          
    574                if ( _NIB.nwkLogicalChannel != i )
   \                     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_4:
   \   00008C   C29F....     CMP.B   R15, &_NIB + 24
   \   000090   4724         JEQ     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_2
    575                {
    576                  ZDNwkMgr_NewChannel = i;
   \   000092   C24F....     MOV.B   R15, &ZDNwkMgr_NewChannel
    577                    
    578                  // Upon receipt of a Mgmt_NWK_Update_req with a change of channels, 
    579                  // the local network manager shall set a timer equal to the 
    580                  // nwkNetworkBroadcastDeliveryTime and shall switch channels upon 
    581                  // expiration of this timer.  Each node shall also increment the 
    582                  // nwkUpdateId parameter and also reset the total transmit count 
    583                  // and the transmit failure counters.  
    584                  osal_start_timerEx( ZDNwkMgr_TaskID, ZDNWKMGR_CHANNEL_CHANGE_EVT, 
    585                                      ZDNWKMGR_BCAST_DELIVERY_TIME );
   \   000096   5E42....     MOV.B   &_NIB + 7, R14
   \   00009A   5E06         RLAM.W  #0x2, R14
   \   00009C   0F4E         MOV.W   R14, R15
   \   00009E   5E0A         RLAM.W  #0x3, R14
   \   0000A0   0F5E         ADD.W   R14, R15
   \   0000A2   0E5E         RLA.W   R14
   \   0000A4   0E5F         ADD.W   R15, R14
   \   0000A6   1D43         MOV.W   #0x1, R13
   \   0000A8   ........     CALLA   #??Subroutine0_0
    586                }
    587              }
    588            }
   \                     ??CrossCallReturnLabel_6:
   \   0000AC   393C         JMP     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_2
    589            else if ( Req.scanDuration == 0xFF )
   \                     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_3:
   \   0000AE   7E93         CMP.B   #0xff, R14
   \   0000B0   1F20         JNE     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_5
    590            {
    591              // Request is to change apsChannelMask and nwkManagerAddr
    592              if ( Req.nwkUpdateId > _NIB.nwkUpdateId )
   \   0000B2   5C410600     MOV.B   0x6(SP), R12
   \   0000B6   C29C....     CMP.B   R12, &_NIB + 114
   \   0000BA   322C         JC      ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_2
    593              {
    594                NLME_SetUpdateID(Req.nwkUpdateId); // Set the updateID in the beacon
   \   0000BC   ........     CALLA   #NLME_SetUpdateID
    595                 
    596                if ( ( Req.channelMask != 0 ) && ( _NIB.channelList != Req.channelMask ) )
   \   0000C0   2F41         MOV.W   @SP, R15
   \   0000C2   1FD10200     BIS.W   0x2(SP), R15
   \   0000C6   0F93         CMP.W   #0x0, R15
   \   0000C8   0E24         JEQ     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_6
   \   0000CA   A291....     CMP.W   @SP, &_NIB + 40
   \   0000CE   0420         JNE     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_7
   \   0000D0   92910200.... CMP.W   0x2(SP), &_NIB + 42
   \   0000D6   0724         JEQ     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_6
    597                {
    598                  _NIB.channelList = Req.channelMask;
   \                     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_7:
   \   0000D8   A241....     MOV.W   @SP, &_NIB + 40
   \   0000DC   92410200.... MOV.W   0x2(SP), &_NIB + 42
    599                
    600                  // Our Channel List has been changed -- notify to save info into NV
    601                  ZDApp_NwkStateUpdateCB();
   \   0000E2   ........     CALLA   #ZDApp_NwkStateUpdateCB
    602                }
    603              
    604                ZDNwkMgr_SetNwkManagerAddr( Req.nwkManagerAddr );
   \                     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_6:
   \   0000E6   1C410800     MOV.W   0x8(SP), R12
   \   0000EA   ........     CALLA   #ZDNwkMgr_SetNwkManagerAddr
   \   0000EE   183C         JMP     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_2
    605              }
    606            }
    607            else // 0x06-0xFD
    608            {
    609              // Request is invalid
    610              if ( !inMsg->wasBroadcast )
   \                     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_5:
   \   0000F0   CA930C00     CMP.B   #0x0, 0xc(R10)
   \   0000F4   1520         JNE     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_2
    611              {
    612                ZDNwkMgr_MgmtNwkUpdateNotifyAddr.addr.shortAddr = inMsg->srcAddr.addr.shortAddr;
   \   0000F6   924A0200.... MOV.W   0x2(R10), &ZDNwkMgr_MgmtNwkUpdateNotifyAddr
    613                ZDP_MgmtNwkUpdateNotify( inMsg->TransSeq, &ZDNwkMgr_MgmtNwkUpdateNotifyAddr,
    614                                         ZDP_INVALID_REQTYPE, 0, 0, 0, 0, NULL, AF_TX_OPTIONS_NONE, false );
   \   0000FC   4312         PUSH.B  #0x0
   \   0000FE   4312         PUSH.B  #0x0
   \   000100   0312         PUSH.W  #0x0
   \   000102   4312         PUSH.B  #0x0
   \   000104   0312         PUSH.W  #0x0
   \   000106   0312         PUSH.W  #0x0
   \   000108   0312         PUSH.W  #0x0
   \   00010A   0F43         MOV.W   #0x0, R15
   \   00010C   7E408000     MOV.B   #0x80, R14
   \   000110   3D40....     MOV.W   #ZDNwkMgr_MgmtNwkUpdateNotifyAddr, R13
   \   000114   5C4A1100     MOV.B   0x11(R10), R12
   \   000118   ........     CALLA   #ZDP_MgmtNwkUpdateNotify
   \   00011C   31500E00     ADD.W   #0xe, SP
    615              }
    616            }
    617          }
   \                     ??ZDNwkMgr_ProcessMgmtNwkUpdateReq_2:
   \   000120   31500A00     ADD.W   #0xa, SP
   \   000124   3A41         POP.W   R10
   \   000126   1001         RETA
    618          
    619          /*********************************************************************
    620           * @fn      ZDNwkMgr_ProcessServerDiscRsp
    621           *
    622           * @brief   Process the incoming System Server Discovery Response
    623           *
    624           * @param   pRsp - Structure containing Server Discovery response
    625           *
    626           * @return  none
    627           */

   \                                 In  segment CODE, align 2
    628          void ZDNwkMgr_ProcessServerDiscRsp( zdoIncomingMsg_t *inMsg )
   \                     ZDNwkMgr_ProcessServerDiscRsp:
    629          {
   \   000000   0A12         PUSH.W  R10
   \   000002   2182         SUB.W   #0x4, SP
   \   000004   0A4C         MOV.W   R12, R10
    630            ZDO_ServerDiscRsp_t Rsp;
    631            
    632            ZDO_ParseServerDiscRsp( inMsg, &Rsp );
   \   000006   0D41         MOV.W   SP, R13
   \   000008   0D53         ADD.W   #0x0, R13
   \   00000A   ........     CALLA   #ZDO_ParseServerDiscRsp
    633            
    634            if ( Rsp.status == ZSuccess )
   \   00000E   C1930000     CMP.B   #0x0, 0(SP)
   \   000012   0820         JNE     ??ZDNwkMgr_ProcessServerDiscRsp_0
    635            {
    636              // Is the Network Manager bit set in the response?
    637              if ( Rsp.serverMask & NETWORK_MANAGER )
   \   000014   B1B040000200 BIT.W   #0x40, 0x2(SP)
   \   00001A   0428         JNC     ??ZDNwkMgr_ProcessServerDiscRsp_0
    638              {
    639                // Set the Remote Device's NWK Address as the Network Manager Address
    640                ZDNwkMgr_SetNwkManagerAddr( inMsg->srcAddr.addr.shortAddr );
   \   00001C   1C4A0200     MOV.W   0x2(R10), R12
   \   000020   ........     CALLA   #ZDNwkMgr_SetNwkManagerAddr
    641              }
    642            }
    643          }
   \                     ??ZDNwkMgr_ProcessServerDiscRsp_0:
   \   000024   2152         ADD.W   #0x4, SP
   \   000026   3A41         POP.W   R10
   \   000028   1001         RETA
    644          
    645          /*********************************************************************
    646           * @fn          ZDNwkMgr_ProcessChannelInterference
    647           *
    648           * @brief       This function processes the incoming Channel Interference
    649           *              detection message and sends out a notify (if needed).
    650           *
    651           * @param       pChannelInterference - interference message
    652           *
    653           * @return      none
    654           */
    655          static void ZDNwkMgr_ProcessChannelInterference( ZDNwkMgr_ChanInterference_t *pChanInterference )
    656          {
    657            // To avoid a device with communication problems from constantly 
    658            // sending reports to the network manager, the device should not 
    659            // send a Mgmt_NWK_Update_notify more than 4 times per hour.
    660            if ( ZDNwkMgr_NumUpdateNotifySent < 4 )
    661            {
    662              // Conduct an energy scan on all channels.
    663              if ( NLME_EDScanRequest( MAX_CHANNELS_24GHZ, _NIB.scanDuration ) == ZSuccess )
    664              {
    665                // Save the counters for the Update Notify message to be sent
    666                ZDNwkMgr_TotalTransmissions = pChanInterference->totalTransmissions;
    667                ZDNwkMgr_TxFailures = pChanInterference->txFailures;
    668          
    669                // Mark scan as channel inetrference check
    670                ZDNwkMgr_MgmtNwkUpdateReq.scanCount = 0xFF;
    671              }
    672            }
    673          }
    674          
    675          /*********************************************************************
    676           * @fn          ZDNwkMgr_ProcessEDScanConfirm
    677           *
    678           * @brief       This function processes the incoming ED Scan Confirm
    679           *              message and sends out a notify (if needed).
    680           *
    681           * @param       pEDScanConfirm - SD Scan Confirmation message
    682           *
    683           * @return      none
    684           */

   \                                 In  segment CODE, align 2
    685          static void ZDNwkMgr_ProcessEDScanConfirm( ZDNwkMgr_EDScanConfirm_t *pEDScanConfirm )
   \                     ZDNwkMgr_ProcessEDScanConfirm:
    686          { 
   \   000000   0A12         PUSH.W  R10
   \   000002   0A4C         MOV.W   R12, R10
    687            if ( ZDNwkMgr_MgmtNwkUpdateReq.scanCount == 0xFF )
   \   000004   F293....     CMP.B   #0xff, &ZDNwkMgr_MgmtNwkUpdateReq + 5
   \   000008   0520         JNE     ??ZDNwkMgr_ProcessEDScanConfirm_0
    688            {
    689              // Confirm to scan all channels for channel interference check
    690              ZDNwkMgr_CheckForChannelInterference( pEDScanConfirm ); 
   \   00000A   ........     CALLA   #ZDNwkMgr_CheckForChannelInterference
    691              
    692              ZDNwkMgr_MgmtNwkUpdateReq.scanCount = 0;
   \   00000E   C243....     MOV.B   #0x0, &ZDNwkMgr_MgmtNwkUpdateReq + 5
   \   000012   173C         JMP     ??ZDNwkMgr_ProcessEDScanConfirm_1
    693            }
    694            else
    695            {
    696              // Confirm to the requested scan
    697              uint16 txFailures = nwkTransmissionFailures( FALSE );
   \                     ??ZDNwkMgr_ProcessEDScanConfirm_0:
   \   000014   4C43         MOV.B   #0x0, R12
   \   000016   ........     CALLA   #nwkTransmissionFailures
    698              
    699              ZDNwkMgr_BuildAndSendUpdateNotify( ZDNwkMgr_MgmtNwkUpdateNotifyTransSeq,
    700                                                 &ZDNwkMgr_MgmtNwkUpdateNotifyAddr, 
    701                                                 _NIB.nwkTotalTransmissions, txFailures, 
    702                                                 pEDScanConfirm, AF_TX_OPTIONS_NONE );
   \   00001A   4312         PUSH.B  #0x0
   \   00001C   0A12         PUSH.W  R10
   \   00001E   0F4C         MOV.W   R12, R15
   \   000020   1E42....     MOV.W   &_NIB + 112, R14
   \   000024   3D40....     MOV.W   #ZDNwkMgr_MgmtNwkUpdateNotifyAddr, R13
   \   000028   5C42....     MOV.B   &ZDNwkMgr_MgmtNwkUpdateNotifyTransSeq, R12
   \   00002C   ........     CALLA   #ZDNwkMgr_BuildAndSendUpdateNotify
    703              // More scans needed?
    704              if ( ZDNwkMgr_MgmtNwkUpdateReq.scanCount > 0 )
   \   000030   2152         ADD.W   #0x4, SP
   \   000032   C293....     CMP.B   #0x0, &ZDNwkMgr_MgmtNwkUpdateReq + 5
   \   000036   0524         JEQ     ??ZDNwkMgr_ProcessEDScanConfirm_1
    705              {
    706                osal_start_timerEx( ZDNwkMgr_TaskID, ZDNWKMGR_SCAN_REQUEST_EVT, 50 );
   \   000038   3E403200     MOV.W   #0x32, R14
   \   00003C   3D42         MOV.W   #0x8, R13
   \   00003E   ........     CALLA   #??Subroutine0_0
    707              }
    708            }
    709          }
   \                     ??ZDNwkMgr_ProcessEDScanConfirm_1:
   \   000042   3A41         POP.W   R10
   \   000044   1001         RETA
    710          
    711          /*********************************************************************
    712           * @fn          ZDNwkMgr_CheckForChannelInterference
    713           *
    714           * @brief       This function processes the incoming ED Scan Confirm
    715           *              message and sends out an Update Notify (if needed).
    716           *
    717           * @param       pEDScanConfirm - SD Scan Confirmation message
    718           *
    719           * @return      none
    720           */

   \                                 In  segment CODE, align 2
    721          static void ZDNwkMgr_CheckForChannelInterference( ZDNwkMgr_EDScanConfirm_t *pEDScanConfirm )
   \                     ZDNwkMgr_CheckForChannelInterference:
    722          {
   \   000000   1B15         PUSHM.W #0x2, R11
   \   000002   0F4C         MOV.W   R12, R15
    723            uint8 i;
    724            uint8 channelEnergy = 0;
   \   000004   4A43         MOV.B   #0x0, R10
   \   000006   5B42....     MOV.B   &_NIB + 24, R11
   \   00000A   ........     CALLA   #?Subroutine3
   \                     ??CrossCallReturnLabel_4:
   \   00000E   5CB3         BIT.B   #0x1, R12
   \   000010   0424         JEQ     ??ZDNwkMgr_CheckForChannelInterference_1
    725            uint8 energyIncreased = FALSE;
    726              
    727            // Get the current channel energy
    728            if ( ( (uint32)1 << _NIB.nwkLogicalChannel ) & pEDScanConfirm->scannedChannels )
    729            {
    730              channelEnergy = pEDScanConfirm->energyDetectList[_NIB.nwkLogicalChannel];
   \   000012   0E4F         MOV.W   R15, R14
   \   000014   0E5B         ADD.W   R11, R14
   \   000016   5A4E0800     MOV.B   0x8(R14), R10
    731            }
    732              
    733            // If this energy scan does not indicate higher energy on the current 
    734            // channel then other channels, no action is taken. The device should 
    735            // continue to operate as normal and the message counters are not reset.
    736            for ( i = 0; i < ED_SCAN_MAXCHANNELS; i++ )
   \                     ??ZDNwkMgr_CheckForChannelInterference_1:
   \   00001A   4B43         MOV.B   #0x0, R11
    737            {
    738              if ( ( ( (uint32)1 << i ) & pEDScanConfirm->scannedChannels ) && 
    739                   ( channelEnergy > pEDScanConfirm->energyDetectList[i] ) )
   \                     ??ZDNwkMgr_CheckForChannelInterference_0:
   \   00001C   ........     CALLA   #?Subroutine3
   \                     ??CrossCallReturnLabel_5:
   \   000020   5CB3         BIT.B   #0x1, R12
   \   000022   2224         JEQ     ??ZDNwkMgr_CheckForChannelInterference_2
   \   000024   0E4F         MOV.W   R15, R14
   \   000026   0E5B         ADD.W   R11, R14
   \   000028   CE9A0800     CMP.B   R10, 0x8(R14)
   \   00002C   1D2C         JC      ??ZDNwkMgr_CheckForChannelInterference_2
    740              {
    741                energyIncreased = TRUE;
    742                break;
    743              }
    744            }
    745              
    746            // If the energy scan does indicate increased energy on the channel
    747            // in use, a Mgmt_NWK_Update_notify should be sent to the Network 
    748            // Manager to indicate interference is present.
    749            if ( energyIncreased )
    750            {
    751              // Send a Management Network Update notify to the Network Manager
    752              ZDNwkMgr_MgmtNwkUpdateNotifyAddr.addr.shortAddr = _NIB.nwkManagerAddr;
   \   00002E   9242........ MOV.W   &_NIB + 110, &ZDNwkMgr_MgmtNwkUpdateNotifyAddr
    753              ZDNwkMgr_BuildAndSendUpdateNotify( 0, &ZDNwkMgr_MgmtNwkUpdateNotifyAddr, 
    754                                                 ZDNwkMgr_TotalTransmissions, ZDNwkMgr_TxFailures,
    755                                                 pEDScanConfirm, AF_MSG_ACK_REQUEST );
   \   000034   70121000     PUSH.B  #0x10
   \   000038   0F12         PUSH.W  R15
   \   00003A   1F42....     MOV.W   &ZDNwkMgr_TxFailures, R15
   \   00003E   1E42....     MOV.W   &ZDNwkMgr_TotalTransmissions, R14
   \   000042   3D40....     MOV.W   #ZDNwkMgr_MgmtNwkUpdateNotifyAddr, R13
   \   000046   4C43         MOV.B   #0x0, R12
   \   000048   ........     CALLA   #ZDNwkMgr_BuildAndSendUpdateNotify
    756              ZDNwkMgr_WaitingForNotifyConfirm = TRUE; // Confirm will clear the counters
   \   00004C   D243....     MOV.B   #0x1, &ZDNwkMgr_WaitingForNotifyConfirm
    757                
    758              if ( ZDNwkMgr_NumUpdateNotifySent == 0 )
   \   000050   2152         ADD.W   #0x4, SP
   \   000052   C293....     CMP.B   #0x0, &ZDNwkMgr_NumUpdateNotifySent
   \   000056   0520         JNE     ??ZDNwkMgr_CheckForChannelInterference_3
    759              {
    760                // First notify message sent within this hour. Start the Update Notify timer.
    761                ZDNwkMgr_UpdateNotifyTimer = ZDNWKMGR_UPDATE_NOTIFY_TIMER;
   \   000058   B2403C00.... MOV.W   #0x3c, &ZDNwkMgr_UpdateNotifyTimer
    762                osal_start_timerEx( ZDNwkMgr_TaskID, ZDNWKMGR_UPDATE_NOTIFY_EVT, ONE_MINUTE );
   \   00005E   ........     CALLA   #?Subroutine0
    763              }
    764              
    765              ZDNwkMgr_NumUpdateNotifySent++;
   \                     ??ZDNwkMgr_CheckForChannelInterference_3:
   \   000062   D253....     ADD.B   #0x1, &ZDNwkMgr_NumUpdateNotifySent
   \   000066   163C         JMP     ??ZDNwkMgr_CheckForChannelInterference_4
    766            }
   \                     ??ZDNwkMgr_CheckForChannelInterference_2:
   \   000068   5B53         ADD.B   #0x1, R11
   \   00006A   7B901B00     CMP.B   #0x1b, R11
   \   00006E   D62B         JNC     ??ZDNwkMgr_CheckForChannelInterference_0
    767          #if defined ( LCD_SUPPORTED )
    768            else
    769            {
    770              HalLcdWriteString( (char*)NwkMgrStr_4, HAL_LCD_LINE_1 );
   \   000070   5D43         MOV.B   #0x1, R13
   \   000072   3C40....     MOV.W   #NwkMgrStr_4, R12
   \   000076   ........     CALLA   #HalLcdWriteString
    771              HalLcdWriteStringValueValue( ": ", _NIB.nwkLogicalChannel, 10, channelEnergy, 10, HAL_LCD_LINE_2 );
   \   00007A   6312         PUSH.B  #0x2
   \   00007C   70120A00     PUSH.B  #0xa
   \   000080   4F4A         MOV.B   R10, R15
   \   000082   7E400A00     MOV.B   #0xa, R14
   \   000086   5D42....     MOV.B   &_NIB + 24, R13
   \   00008A   3C40....     MOV.W   #`?<Constant ": ">`, R12
   \   00008E   ........     CALLA   #HalLcdWriteStringValueValue
   \   000092   2152         ADD.W   #0x4, SP
    772            }
    773          #endif
    774          }
   \                     ??ZDNwkMgr_CheckForChannelInterference_4:
   \   000094   1A17         POPM.W  #0x2, R11
   \   000096   1001         RETA

   \                                 In  segment CODE, align 2
   \                     ?Subroutine3:
   \   000000   1C4F0400     MOV.W   0x4(R15), R12
   \   000004   1D4F0600     MOV.W   0x6(R15), R13
   \   000008   4E4B         MOV.B   R11, R14
   \   00000A   ........     BRA     #?ShiftRight32u
    775          
    776          /*********************************************************************
    777           * @fn          ZDNwkMgr_BuildAndSendUpdateNotify
    778           *
    779           * @brief       This builds and send a Mgmt_NWK_Update_notify message. This
    780           *              function sends a unicast message.
    781           *
    782           * @param       TransSeq - transaction sequence number
    783           * @param       dstAddr - destination address of the message
    784           * @param       pEDScanConfirm - update notify info
    785           *
    786           * @return      afStatus_t
    787           */

   \                                 In  segment CODE, align 2
    788          static void ZDNwkMgr_BuildAndSendUpdateNotify( uint8 TransSeq, zAddrType_t *dstAddr,
   \                     ZDNwkMgr_BuildAndSendUpdateNotify:
    789                                                         uint16 totalTransmissions, uint16 txFailures,
    790                                                         ZDNwkMgr_EDScanConfirm_t *pEDScanConfirm,
    791                                                         uint8 txOptions )
    792          {
   \   000000   7B15         PUSHM.W #0x8, R11
   \   000002   4C12         PUSH.B  R12
   \   000004   054D         MOV.W   R13, R5
   \   000006   044E         MOV.W   R14, R4
   \   000008   084F         MOV.W   R15, R8
   \   00000A   59411800     MOV.B   0x18(SP), R9
    793            uint8 i;
    794            uint8 listCount = 0;
   \   00000E   4A43         MOV.B   #0x0, R10
    795            uint8 *energyValues = NULL;
   \   000010   0B43         MOV.W   #0x0, R11
    796            
    797            // Count number of energy detects
    798            for ( i = 0; i < ED_SCAN_MAXCHANNELS; i++ )
   \   000012   4F43         MOV.B   #0x0, R15
   \   000014   16411600     MOV.W   0x16(SP), R6
    799            {
    800              if ( ( (uint32)1 << i ) & pEDScanConfirm->scannedChannels )
   \                     ??ZDNwkMgr_BuildAndSendUpdateNotify_0:
   \   000018   ........     CALLA   #?Subroutine1
   \                     ??CrossCallReturnLabel_0:
   \   00001C   0124         JEQ     ??ZDNwkMgr_BuildAndSendUpdateNotify_2
    801                listCount++;
   \   00001E   5A53         ADD.B   #0x1, R10
    802            }
   \                     ??ZDNwkMgr_BuildAndSendUpdateNotify_2:
   \   000020   5F53         ADD.B   #0x1, R15
   \   000022   7F901B00     CMP.B   #0x1b, R15
   \   000026   F82B         JNC     ??ZDNwkMgr_BuildAndSendUpdateNotify_0
    803            
    804            if ( listCount > 0 )
   \   000028   4A93         CMP.B   #0x0, R10
   \   00002A   1724         JEQ     ??ZDNwkMgr_BuildAndSendUpdateNotify_3
    805            {
    806              energyValues = (uint8 *)osal_mem_alloc( listCount );
   \   00002C   4C4A         MOV.B   R10, R12
   \   00002E   ........     CALLA   #osal_mem_alloc
   \   000032   0B4C         MOV.W   R12, R11
    807              if ( energyValues )
   \   000034   0C93         CMP.W   #0x0, R12
   \   000036   1124         JEQ     ??ZDNwkMgr_BuildAndSendUpdateNotify_3
    808              {
    809                uint8 j = 0;
   \   000038   4743         MOV.B   #0x0, R7
    810          
    811                for ( i = 0; i < ED_SCAN_MAXCHANNELS; i++ )
   \   00003A   4F43         MOV.B   #0x0, R15
    812                {
    813                  if ( ( (uint32)1 << i ) & pEDScanConfirm->scannedChannels )
   \                     ??ZDNwkMgr_BuildAndSendUpdateNotify_1:
   \   00003C   ........     CALLA   #?Subroutine1
   \                     ??CrossCallReturnLabel_1:
   \   000040   0824         JEQ     ??ZDNwkMgr_BuildAndSendUpdateNotify_4
    814                    energyValues[j++] = pEDScanConfirm->energyDetectList[i];
   \   000042   0D46         MOV.W   R6, R13
   \   000044   0D5F         ADD.W   R15, R13
   \   000046   0E4B         MOV.W   R11, R14
   \   000048   0E57         ADD.W   R7, R14
   \   00004A   DE4D08000000 MOV.B   0x8(R13), 0(R14)
   \   000050   5753         ADD.B   #0x1, R7
    815                }
   \                     ??ZDNwkMgr_BuildAndSendUpdateNotify_4:
   \   000052   5F53         ADD.B   #0x1, R15
   \   000054   7F901B00     CMP.B   #0x1b, R15
   \   000058   F12B         JNC     ??ZDNwkMgr_BuildAndSendUpdateNotify_1
    816              }
    817            }
    818              
    819            // Send a Management Network Update notify back
    820            ZDP_MgmtNwkUpdateNotify( TransSeq, dstAddr, pEDScanConfirm->status, 
    821                                     pEDScanConfirm->scannedChannels,
    822                                     totalTransmissions, txFailures,
    823                                     listCount, energyValues, txOptions, false );
   \                     ??ZDNwkMgr_BuildAndSendUpdateNotify_3:
   \   00005A   4312         PUSH.B  #0x0
   \   00005C   4912         PUSH.B  R9
   \   00005E   0B12         PUSH.W  R11
   \   000060   4A12         PUSH.B  R10
   \   000062   0812         PUSH.W  R8
   \   000064   16120600     PUSH.W  0x6(R6)
   \   000068   16120400     PUSH.W  0x4(R6)
   \   00006C   0F44         MOV.W   R4, R15
   \   00006E   5E460200     MOV.B   0x2(R6), R14
   \   000072   0D45         MOV.W   R5, R13
   \   000074   5C410E00     MOV.B   0xe(SP), R12
   \   000078   ........     CALLA   #ZDP_MgmtNwkUpdateNotify
    824            if ( energyValues )
   \   00007C   31500E00     ADD.W   #0xe, SP
   \   000080   0B93         CMP.W   #0x0, R11
   \   000082   0324         JEQ     ??ZDNwkMgr_BuildAndSendUpdateNotify_5
    825              osal_mem_free( energyValues );
   \   000084   0C4B         MOV.W   R11, R12
   \   000086   ........     CALLA   #osal_mem_free
    826          }
   \                     ??ZDNwkMgr_BuildAndSendUpdateNotify_5:
   \   00008A   2153         ADD.W   #0x2, SP
   \   00008C   7417         POPM.W  #0x8, R11
   \   00008E   1001         RETA

   \                                 In  segment CODE, align 2
   \                     ?Subroutine1:
   \   000000   1C460400     MOV.W   0x4(R6), R12
   \   000004   1D460600     MOV.W   0x6(R6), R13
   \   000008   4E4F         MOV.B   R15, R14
   \   00000A   ........     CALLA   #?ShiftRight32u
   \   00000E   5CB3         BIT.B   #0x1, R12
   \   000010   1001         RETA
    827          
    828          #if defined ( NWK_MANAGER )
    829          /*********************************************************************
    830           * @fn      NwkMgr_SetNwkManager
    831           *
    832           * @brief   Set the local device as the Network Manager
    833           *
    834           * @param   none
    835           *
    836           * @return  none
    837           */
    838          void NwkMgr_SetNwkManager( void )
    839          {
    840            if ( zgNwkMgrMode == ZDNWKMGR_ENABLE )
    841            {
    842              // We're the Network Manager. Set our address as the Network Manager Address
    843              ZDNwkMgr_SetNwkManagerAddr( _NIB.nwkDevAddress );
    844              
    845              // Set the Network Manager bit of the Server Mask
    846              ZDO_Config_Node_Descriptor.ServerMask |= NETWORK_MANAGER;
    847            }
    848          }
    849          #endif // NWK_MANAGER
    850          
    851          /*********************************************************************
    852           * @fn      ZDApp_SetNwkManagerAddr()
    853           *
    854           * @brief   Sets the nwkManagerAddr in NIB.
    855           *
    856           * @param   nwkManagerAddr
    857           *
    858           * @return  none
    859           */

   \                                 In  segment CODE, align 2
    860          void ZDNwkMgr_SetNwkManagerAddr( uint16 nwkManagerAddr )
   \                     ZDNwkMgr_SetNwkManagerAddr:
    861          {
    862            if ( _NIB.nwkManagerAddr != nwkManagerAddr )
   \   000000   829C....     CMP.W   R12, &_NIB + 110
   \   000004   0424         JEQ     ??ZDNwkMgr_SetNwkManagerAddr_0
    863            {
    864              // Update the Network Manager Address
    865              _NIB.nwkManagerAddr = nwkManagerAddr;
   \   000006   824C....     MOV.W   R12, &_NIB + 110
    866            
    867              // Our Network Manger Address has been changed -- notify to save info into NV
    868              ZDApp_NwkStateUpdateCB();
   \   00000A   ........     CALLA   #ZDApp_NwkStateUpdateCB
    869            }
    870          }
   \                     ??ZDNwkMgr_SetNwkManagerAddr_0:
   \   00000E   1001         RETA
    871          
    872          /*********************************************************************
    873           * @fn          ZDNwkMgr_ReportChannelInterference
    874           *
    875           * @brief       This function builds a Channel Interference detection
    876           *              message and then forwards it to the Network Manager.
    877           *
    878           * @param       chanInterference
    879           *
    880           * @return      none
    881           */

   \                                 In  segment CODE, align 2
    882          void ZDNwkMgr_ReportChannelInterference(  NLME_ChanInterference_t *chanInterference  )
   \                     ZDNwkMgr_ReportChannelInterference:
    883          {
   \   000000   0A12         PUSH.W  R10
   \   000002   0A4C         MOV.W   R12, R10
    884            ZDNwkMgr_ChanInterference_t *pChanInterference;
    885          
    886            // Send Channel Interference message to the Network Manager task
    887            pChanInterference = (ZDNwkMgr_ChanInterference_t *)osal_msg_allocate( sizeof( ZDNwkMgr_ChanInterference_t ) );
   \   000004   3C400600     MOV.W   #0x6, R12
   \   000008   ........     CALLA   #osal_msg_allocate
    888            if ( pChanInterference )
   \   00000C   0C93         CMP.W   #0x0, R12
   \   00000E   0D24         JEQ     ??ZDNwkMgr_ReportChannelInterference_0
    889            {
    890              pChanInterference->hdr.event = NM_CHANNEL_INTERFERE;
   \   000010   FC4031000000 MOV.B   #0x31, 0(R12)
    891                
    892              // Build the structure
    893              pChanInterference->totalTransmissions = chanInterference->totalTransmissions;
   \   000016   AC4A0200     MOV.W   @R10, 0x2(R12)
    894              pChanInterference->txFailures = chanInterference->txFailures;
   \   00001A   9C4A02000400 MOV.W   0x2(R10), 0x4(R12)
    895                        
    896              osal_msg_send( ZDNwkMgr_TaskID, (uint8 *)pChanInterference );
   \   000020   0D4C         MOV.W   R12, R13
   \   000022   5C42....     MOV.B   &ZDNwkMgr_TaskID, R12
   \   000026   ........     CALLA   #osal_msg_send
    897            }
    898          }
   \                     ??ZDNwkMgr_ReportChannelInterference_0:
   \   00002A   3A41         POP.W   R10
   \   00002C   1001         RETA
    899          
    900          /*********************************************************************
    901           * @fn          ZDNwkMgr_EDScanConfirmCB
    902           *
    903           * @brief       Handle Energy Scan confirm callback
    904           *
    905           * @param       scannedChannels  - scanned channels
    906           * @param       energyDetectList - measured energy for channels
    907           *
    908           * @return      none
    909           */

   \                                 In  segment CODE, align 2
    910          void ZDNwkMgr_EDScanConfirmCB( NLME_EDScanConfirm_t *EDScanConfirm )
   \                     ZDNwkMgr_EDScanConfirmCB:
    911          {
   \   000000   1B15         PUSHM.W #0x2, R11
   \   000002   0A4C         MOV.W   R12, R10
    912            ZDNwkMgr_EDScanConfirm_t *pEDScanConfirm;
    913          
    914            // Send ED Confirm to the Network Manager task
    915            pEDScanConfirm = (ZDNwkMgr_EDScanConfirm_t *)osal_msg_allocate( sizeof( ZDNwkMgr_EDScanConfirm_t ) );
   \   000004   3C402400     MOV.W   #0x24, R12
   \   000008   ........     CALLA   #osal_msg_allocate
   \   00000C   0B4C         MOV.W   R12, R11
    916            if ( pEDScanConfirm )
   \   00000E   0C93         CMP.W   #0x0, R12
   \   000010   1724         JEQ     ??ZDNwkMgr_EDScanConfirmCB_0
    917            {
    918              pEDScanConfirm->hdr.event = NM_ED_SCAN_CONFIRM;
   \   000012   FC4032000000 MOV.B   #0x32, 0(R12)
    919                
    920              // Build the structure
    921              pEDScanConfirm->status = EDScanConfirm->status;
   \   000018   EC4A0200     MOV.B   @R10, 0x2(R12)
    922              pEDScanConfirm->scannedChannels = EDScanConfirm->scannedChannels;
   \   00001C   9C4A02000400 MOV.W   0x2(R10), 0x4(R12)
   \   000022   9C4A04000600 MOV.W   0x4(R10), 0x6(R12)
    923              osal_memcpy( pEDScanConfirm->energyDetectList, EDScanConfirm->energyDetectList, ED_SCAN_MAXCHANNELS );
   \   000028   3E401B00     MOV.W   #0x1b, R14
   \   00002C   1D4A0600     MOV.W   0x6(R10), R13
   \   000030   3C52         ADD.W   #0x8, R12
   \   000032   ........     CALLA   #osal_memcpy
    924                
    925              osal_msg_send( ZDNwkMgr_TaskID, (uint8 *)pEDScanConfirm );
   \   000036   0D4B         MOV.W   R11, R13
   \   000038   5C42....     MOV.B   &ZDNwkMgr_TaskID, R12
   \   00003C   ........     CALLA   #osal_msg_send
    926            }
    927          }
   \                     ??ZDNwkMgr_EDScanConfirmCB_0:
   \   000040   1A17         POPM.W  #0x2, R11
   \   000042   1001         RETA
    928          
    929          /*********************************************************************
    930           * @fn      ZDNwkMgr_ProcessDataConfirm
    931           *
    932           * @brief   Process received Confirmation for Mgmt NWK Update Notify message
    933           *
    934           * @param   none
    935           *
    936           * @return  none
    937           */

   \                                 In  segment CODE, align 2
    938          void ZDNwkMgr_ProcessDataConfirm( afDataConfirm_t *afDataConfirm )
   \                     ZDNwkMgr_ProcessDataConfirm:
    939          {
    940            if (   ZDNwkMgr_WaitingForNotifyConfirm  && 
    941                 ( afDataConfirm->transID == 0 )     && 
    942                 ( afDataConfirm->hdr.status == ZSuccess ) )
   \   000000   C293....     CMP.B   #0x0, &ZDNwkMgr_WaitingForNotifyConfirm
   \   000004   0A24         JEQ     ??ZDNwkMgr_ProcessDataConfirm_0
   \   000006   CC930300     CMP.B   #0x0, 0x3(R12)
   \   00000A   0720         JNE     ??ZDNwkMgr_ProcessDataConfirm_0
   \   00000C   CC930100     CMP.B   #0x0, 0x1(R12)
   \   000010   0420         JNE     ??ZDNwkMgr_ProcessDataConfirm_0
    943            {
    944              // The Mgmt NWK Update Notify was sent as an APS Unicast with  
    945              // acknowledgement and once the acknowledgment is received the 
    946              // total transmit and transmit failure counters are reset to zero.  
    947              _NIB.nwkTotalTransmissions = 0;
   \   000012   ........     CALLA   #?Subroutine2
    948              nwkTransmissionFailures( TRUE );
    949              
    950              ZDNwkMgr_WaitingForNotifyConfirm = FALSE;
   \                     ??CrossCallReturnLabel_3:
   \   000016   C243....     MOV.B   #0x0, &ZDNwkMgr_WaitingForNotifyConfirm
    951            }
    952          }
   \                     ??ZDNwkMgr_ProcessDataConfirm_0:
   \   00001A   1001         RETA

   \                                 In  segment DATA16_C, align 1, align-sorted
   \                     `?<Constant ": ">`:
   \   000000   3A2000       DC8 ": "
    953          
    954          /*********************************************************************
    955           * PAN ID Conflict Routines
    956           */
    957          #if defined ( NWK_MANAGER )
    958          /*********************************************************************
    959           * @fn          ZDNwkMgr_NetworkReportCB
    960           *
    961           * @brief       Handle the Network Report Command
    962           *
    963           * @param       srcAddr     - Source Address of the message.
    964           * @param       status      - ZSuccess.
    965           * @param       serverMask  - Bit mask of services matching the req serverMask.
    966           * @param       securityUse -
    967           *
    968           * @return      none
    969           */
    970          void ZDNwkMgr_NetworkReportCB( ZDNwkMgr_NetworkReport_t *pReport )
    971          { 
    972            // Send Network Report message to the Network Manager task
    973            osal_msg_send( ZDNwkMgr_TaskID, (uint8 *)pReport );
    974          }
    975          
    976          /*********************************************************************
    977           * @fn          ZDNwkMgr_NetworkUpdateCB
    978           *
    979           * @brief       Handle the Network Update Command
    980           *
    981           * @param       srcAddr     - Source Address of the message.
    982           * @param       status      - ZSuccess.
    983           * @param       serverMask  - Bit mask of services matching the req serverMask.
    984           * @param       securityUse -
    985           *
    986           * @return      none
    987           */
    988          void ZDNwkMgr_NetworkUpdateCB( ZDNwkMgr_NetworkUpdate_t *pUpdate )
    989          {
    990            // Send Network Update message to the Network Manager task
    991            osal_msg_send( ZDNwkMgr_TaskID, (uint8 *)pUpdate );
    992          }
    993          
    994          /*********************************************************************
    995           * @fn      ZDNwkMgr_ProcessNetworkReport
    996           *
    997           * @brief   Process the incoming Network Report message
    998           *
    999           * @param   pNetworkReport - Structure containing Network Report message
   1000           *
   1001           * @return  none
   1002           */
   1003          void ZDNwkMgr_ProcessNetworkReport( ZDNwkMgr_NetworkReport_t *pNetworkReport )
   1004          {
   1005            uint8 i;
   1006            uint16 newPID;
   1007            uint8 unique = TRUE;
   1008          
   1009            if ( pNetworkReport->reportType == NWKREPORT_PANID_CONFLICT )
   1010            {
   1011              if ( ZDNwkMgr_PanIdUpdateInProgress == FALSE )
   1012              {
   1013                do
   1014                {
   1015                  // select a new PAN ID
   1016                  newPID = (uint16)osal_rand();
   1017                
   1018                  // Make sure that the chosen PAN ID is not already in use in the
   1019                  // local neighborhood and also not contained within the Report 
   1020                  // Information field of the Network Report Command frame
   1021                  for ( i = 0; i < pNetworkReport->reportInfoCnt; i++ )
   1022                  {
   1023                    if ( pNetworkReport->panIDs[i] == newPID )
   1024                    {
   1025                      unique = FALSE;
   1026                      break;
   1027                    }
   1028                  }
   1029                } while ( !unique );
   1030                   
   1031                // Send out a Network Update command.
   1032                NLME_SendNetworkUpdate( NWK_BROADCAST_SHORTADDR, NWKUPDATE_PANID_UPDATE,
   1033                                        _NIB.extendedPANID, _NIB.nwkUpdateId+1, newPID );
   1034              
   1035                ZDNwkMgr_PanIdUpdateInProgress = TRUE;
   1036              }
   1037            }
   1038          }
   1039          
   1040          /*********************************************************************
   1041           * @fn      ZDNwkMgr_ProcessNetworkUpdate
   1042           *
   1043           * @brief   Process the incoming Network Update message
   1044           *
   1045           * @param   pNetworkReport - Structure containing Network Update message
   1046           *
   1047           * @return  none
   1048           */
   1049          void ZDNwkMgr_ProcessNetworkUpdate( ZDNwkMgr_NetworkUpdate_t *pNetworkUpdate )
   1050          {
   1051            if ( pNetworkUpdate->updateType == NWKUPDATE_PANID_UPDATE )
   1052            { 
   1053              // Our PAN ID has been changed -- notify to save info into NV
   1054              ZDApp_NwkStateUpdateCB();
   1055              
   1056              ZDNwkMgr_PanIdUpdateInProgress = FALSE;
   1057            }
   1058          }
   1059          #endif // NWK_MANAGER
   1060          
   1061          
   1062          /*********************************************************************
   1063          *********************************************************************/

   Maximum stack usage in bytes:

   CSTACK Function
   ------ --------
     36   ZDNwkMgr_BuildAndSendUpdateNotify
       36   -> ZDP_MgmtNwkUpdateNotify
       22   -> osal_mem_alloc
       22   -> osal_mem_free
     12   ZDNwkMgr_CheckForChannelInterference
        8   -> HalLcdWriteString
       12   -> HalLcdWriteStringValueValue
       12   -> ZDNwkMgr_BuildAndSendUpdateNotify
        8   -> osal_start_timerEx
      8   ZDNwkMgr_EDScanConfirmCB
        8   -> osal_memcpy
        8   -> osal_msg_allocate
        8   -> osal_msg_send
      4   ZDNwkMgr_Init
        4   -> ZDO_RegisterForZDOMsg
      4   ZDNwkMgr_ProcessDataConfirm
        4   -> nwkTransmissionFailures
     10   ZDNwkMgr_ProcessEDScanConfirm
       10   -> ZDNwkMgr_BuildAndSendUpdateNotify
        6   -> ZDNwkMgr_CheckForChannelInterference
        6   -> nwkTransmissionFailures
        6   -> osal_start_timerEx
     30   ZDNwkMgr_ProcessMgmtNwkUpdateReq
       16   -> NLME_EDScanRequest
       16   -> NLME_SetUpdateID
       16   -> ZDApp_NwkStateUpdateCB
       16   -> ZDNwkMgr_SetNwkManagerAddr
       16   -> ZDO_ParseMgmtNwkUpdateReq
       30   -> ZDP_MgmtNwkUpdateNotify
       16   -> osal_start_timerEx
     10   ZDNwkMgr_ProcessServerDiscRsp
       10   -> ZDNwkMgr_SetNwkManagerAddr
       10   -> ZDO_ParseServerDiscRsp
      6   ZDNwkMgr_ReportChannelInterference
        6   -> osal_msg_allocate
        6   -> osal_msg_send
      4   ZDNwkMgr_SetNwkManagerAddr
        4   -> ZDApp_NwkStateUpdateCB
      8   ZDNwkMgr_event_loop
        8   -> NLME_EDScanRequest
        8   -> ZDApp_NwkStateUpdateCB
        8   -> ZDNwkMgr_ProcessEDScanConfirm
        8   -> ZDNwkMgr_ProcessMgmtNwkUpdateReq
        8   -> ZDNwkMgr_ProcessServerDiscRsp
        8   -> ZMacSetReq
        8   -> nwkTransmissionFailures
        8   -> osal_msg_deallocate
        8   -> osal_msg_receive
        8   -> osal_start_timerEx


   Segment part sizes:

   Bytes  Function/Label
   -----  --------------
       3  ?<Constant ": ">
       8  ??Subroutine0_0
       6  ?Subroutine0
      18  ?Subroutine1
      10  ?Subroutine2
      14  ?Subroutine3
      15  NwkMgrStr_1
      17  NwkMgrStr_2
      17  NwkMgrStr_3
      17  NwkMgrStr_4
     144  ZDNwkMgr_BuildAndSendUpdateNotify
     152  ZDNwkMgr_CheckForChannelInterference
      68  ZDNwkMgr_EDScanConfirmCB
      72  ZDNwkMgr_Init
      10  ZDNwkMgr_MgmtNwkUpdateNotifyAddr
       1  ZDNwkMgr_MgmtNwkUpdateNotifyTransSeq
      10  ZDNwkMgr_MgmtNwkUpdateReq
       1  ZDNwkMgr_NewChannel
       1  ZDNwkMgr_NumUpdateNotifySent
      28  ZDNwkMgr_ProcessDataConfirm
      70  ZDNwkMgr_ProcessEDScanConfirm
     296  ZDNwkMgr_ProcessMgmtNwkUpdateReq
      42  ZDNwkMgr_ProcessServerDiscRsp
      46  ZDNwkMgr_ReportChannelInterference
      16  ZDNwkMgr_SetNwkManagerAddr
       1  ZDNwkMgr_TaskID
       2  ZDNwkMgr_TotalTransmissions
       2  ZDNwkMgr_TxFailures
       2  ZDNwkMgr_UpdateNotifyTimer
       1  ZDNwkMgr_WaitingForNotifyConfirm
     244  ZDNwkMgr_event_loop
       4  pZDNwkMgr_EDScanConfirmCB
       4  pZDNwkMgr_NetworkReportCB
       4  pZDNwkMgr_NetworkUpdateCB
       4  pZDNwkMgr_ProcessDataConfirm
       4  pZDNwkMgr_ReportChannelInterference

 
 1 234 bytes in segment CODE
    69 bytes in segment DATA16_C
    51 bytes in segment DATA16_Z
 
 1 234 bytes of CODE  memory
    69 bytes of CONST memory
    51 bytes of DATA  memory

Errors: none
Warnings: none
