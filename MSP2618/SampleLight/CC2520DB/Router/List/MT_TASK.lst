###############################################################################
#                                                                             #
# IAR C/C++ Compiler V5.52.1.50724/W32 for MSP430       10/Jun/2013  16:27:23 #
# Copyright 1996-2013 IAR Systems AB.                                         #
#                                                                             #
#    __rt_version  =  3                                                       #
#    __double_size =  32                                                      #
#    __reg_r4      =  free                                                    #
#    __reg_r5      =  free                                                    #
#    __pic         =  no                                                      #
#    __core        =  430X                                                    #
#    __data_model  =  small                                                   #
#    Source file   =  C:\Texas Instruments\ZStack-MSP2618-2.5.1\Components\mt #
#                     \MT_TASK.c                                              #
#    Command line  =  -f "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\ #
#                     zstack\HomeAutomation\SampleLight\CC2520DB\..\..\..\Too #
#                     ls\MSP2618\f8wConfig.cfg" (-DZIGBEEPRO -DSECURE=0       #
#                     -DZG_SECURE_DYNAMIC=0 -DREFLECTOR                       #
#                     -DDEFAULT_CHANLIST=0x00000800                           #
#                     -DZDAPP_CONFIG_PAN_ID=0xFFFF -DNWK_START_DELAY=100      #
#                     -DEXTENDED_JOINING_RANDOM_MASK=0x007F                   #
#                     -DBEACON_REQUEST_DELAY=100                              #
#                     -DBEACON_REQ_DELAY_MASK=0x00FF                          #
#                     -DLINK_STATUS_JITTER_MASK=0x007F                        #
#                     -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_POLLED= #
#                     3000 -DNWK_INDIRECT_MSG_TIMEOUT=7 -DMAX_RREQ_ENTRIES=8  #
#                     -DAPSC_MAX_FRAME_RETRIES=3 -DNWK_MAX_DATA_RETRIES=2     #
#                     -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9              #
#                     -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40                #
#                     -DNWK_MAX_BINDING_ENTRIES=4                             #
#                     -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,       #
#                     0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00, 0x02,   #
#                     0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"                    #
#                     -DMAC_MAX_FRAME_SIZE=116 -DZDNWKMGR_MIN_TRANSMISSIONS=2 #
#                     0 -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=1000           #
#                     -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100         #
#                     -DREJOIN_POLL_RATE=440) -f "C:\Texas                    #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\Tools\MSP2618\f8 #
#                     wRouter.cfg" (-DCPU6MHZ -DMAC_CFG_APP_PENDING_QUEUE=TRU #
#                     E -DMAC_CFG_TX_DATA_MAX=5 -DMAC_CFG_TX_MAX=8            #
#                     -DMAC_CFG_RX_MAX=5 -DRTR_NWK) -f "C:\Texas              #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\Tools\MSP2618\f8 #
#                     wZCL.cfg" (-DZCL_READ -DZCL_WRITE -DZCL_BASIC           #
#                     -DZCL_IDENTIFY -DZCL_ON_OFF -DZCL_KEY_ESTABLISH         #
#                     -DZCL_KEY_ESTABLISHMENT_KEY_GENERATE_TIMEOUT=4          #
#                     -DZCL_KEY_ESTABLISHMENT_MAC_GENERATE_TIMEOUT=10         #
#                     -DZCL_KEY_ESTABLISHMENT_EKEY_GENERATE_TIMEOUT=10        #
#                     -DZCL_LOAD_CONTROL -DZCL_SIMPLE_METERING -DZCL_PRICING  #
#                     -DZCL_MESSAGE -DZCL_TUNNELING -DZCL_TOU)                #
#                     -DZCL_DEVICE_MGMT "C:\Texas                             #
#                     Instruments\ZStack-MSP2618-2.5.1\Components\mt\MT_TASK. #
#                     c" -D MSP430F2618 -D ZTOOL_P1 -D MT_TASK -D             #
#                     MT_SYS_FUNC -D MT_ZDO_FUNC -D LCD_SUPPORTED -lC         #
#                     "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zst #
#                     ack\HomeAutomation\SampleLight\CC2520DB\Router\List\"   #
#                     -lA "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects #
#                     \zstack\HomeAutomation\SampleLight\CC2520DB\Router\List #
#                     \" --remarks --diag_suppress Pe001,Pe193,Pe236,Pe826    #
#                     -o "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\ #
#                     zstack\HomeAutomation\SampleLight\CC2520DB\Router\Obj\" #
#                      --debug -D__MSP430F2618__ -e --double=32 --clib -I     #
#                     "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zst #
#                     ack\HomeAutomation\SampleLight\CC2520DB\" -I "C:\Texas  #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\Source\" -I "C:\Texas  #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\Source\" -I         #
#                     "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zst #
#                     ack\HomeAutomation\SampleLight\CC2520DB\..\..\..\ZMain\ #
#                     MSP2618\" -I "C:\Texas Instruments\ZStack-MSP2618-2.5.1 #
#                     \Projects\zstack\HomeAutomation\SampleLight\CC2520DB\.. #
#                     \..\..\..\..\Components\hal\include\" -I "C:\Texas      #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \hal\target\MSP2618CC2520\" -I "C:\Texas                #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \mac\include\" -I "C:\Texas                             #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \mac\high_level\" -I "C:\Texas                          #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \mac\low_level\srf04\" -I "C:\Texas                     #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \mac\low_level\srf04\dual_chip\" -I "C:\Texas           #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \mt\" -I "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Pro #
#                     jects\zstack\HomeAutomation\SampleLight\CC2520DB\..\..\ #
#                     ..\..\..\Components\osal\include\" -I "C:\Texas         #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \osal\mcu\msp430\" -I "C:\Texas                         #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \services\saddr\" -I "C:\Texas                          #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \services\sdata\" -I "C:\Texas                          #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \stack\af\" -I "C:\Texas Instruments\ZStack-MSP2618-2.5 #
#                     .1\Projects\zstack\HomeAutomation\SampleLight\CC2520DB\ #
#                     ..\..\..\..\..\Components\stack\nwk\" -I "C:\Texas      #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \stack\sec\" -I "C:\Texas Instruments\ZStack-MSP2618-2. #
#                     5.1\Projects\zstack\HomeAutomation\SampleLight\CC2520DB #
#                     \..\..\..\..\..\Components\stack\sapi\" -I "C:\Texas    #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \stack\sys\" -I "C:\Texas Instruments\ZStack-MSP2618-2. #
#                     5.1\Projects\zstack\HomeAutomation\SampleLight\CC2520DB #
#                     \..\..\..\..\..\Components\stack\zcl\" -I "C:\Texas     #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \stack\zdo\" -I "C:\Texas Instruments\ZStack-MSP2618-2. #
#                     5.1\Projects\zstack\HomeAutomation\SampleLight\CC2520DB #
#                     \..\..\..\..\..\Components\zmac\" -I "C:\Texas          #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleLight\CC2520DB\..\..\..\..\..\Components #
#                     \zmac\f8w\" --core=430X --data_model=small -Ohz         #
#                     --multiplier=16s --require_prototypes                   #
#    List file     =  C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zsta #
#                     ck\HomeAutomation\SampleLight\CC2520DB\Router\List\MT_T #
#                     ASK.lst                                                 #
#    Object file   =  C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zsta #
#                     ck\HomeAutomation\SampleLight\CC2520DB\Router\Obj\MT_TA #
#                     SK.r43                                                  #
#                                                                             #
#                                                                             #
###############################################################################

C:\Texas Instruments\ZStack-MSP2618-2.5.1\Components\mt\MT_TASK.c
      1          /***************************************************************************************************
      2            Filename:       MT_TASK.c
      3            Revised:        $Date: 2011-06-07 15:36:01 -0700 (Tue, 07 Jun 2011) $
      4            Revision:       $Revision: 26245 $
      5          
      6            Description:    MonitorTest Task handling routines
      7          
      8            Copyright 2007-2011 Texas Instruments Incorporated. All rights reserved.
      9          
     10            IMPORTANT: Your use of this Software is limited to those specific rights
     11            granted under the terms of a software license agreement between the user
     12            who downloaded the software, his/her employer (which must be your employer)
     13            and Texas Instruments Incorporated (the "License").  You may not use this
     14            Software unless you agree to abide by the terms of the License. The License
     15            limits your use, and you acknowledge, that the Software may not be modified,
     16            copied or distributed unless embedded on a Texas Instruments microcontroller
     17            or used solely and exclusively in conjunction with a Texas Instruments radio
     18            frequency transceiver, which is integrated into your product.  Other than for
     19            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     20            works of, modify, distribute, perform, display or sell this Software and/or
     21            its documentation for any purpose.
     22          
     23            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     24            PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     25            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     26            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     27            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     28            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     29            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     30            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     31            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     32            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     33            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     34          
     35            Should you have any questions regarding your right to use this Software,
     36            contact Texas Instruments Incorporated at www.TI.com.
     37          
     38           ***************************************************************************************************/
     39          
     40          /***************************************************************************************************
     41           * INCLUDES
     42           ***************************************************************************************************/
     43          #include "ZComDef.h"
     44          #include "MT_TASK.h"
     45          #include "MT.h"
     46          #include "MT_DEBUG.h"
     47          #include "MT_UART.h"
     48          #include "MT_UTIL.h"
     49          #include "MT_SYS.h"
     50          
     51          #if !defined( NONWK )
     52          #include "MT_ZDO.h"
     53          #include "MT_AF.h"
     54          #endif  /* NONWK */
     55          
     56          #include "hal_uart.h"
     57          #include "OSAL_Memory.h"
     58          
     59          /***************************************************************************************************
     60           * LOCAL FUNCTIONS
     61           ***************************************************************************************************/
     62          
     63          static void MT_ProcessIncomingCommand( mtOSALSerialData_t *msg );
     64          
     65          /***************************************************************************************************
     66           * GLOBALS
     67           ***************************************************************************************************/
     68          

   \                                 In  segment DATA16_Z, align 1, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
     69          uint8 MT_TaskID;
   \                     MT_TaskID:
   \   000000                DS8 1
     70          
     71          /***************************************************************************************************
     72           * @fn      MT_TaskInit
     73           *
     74           * @brief  MonitorTest Task Initialization.  This function is put into the
     75           *         task table.
     76           *
     77           * @param   task_id - task ID of the MT Task
     78           *
     79           * @return  void
     80           ***************************************************************************************************/

   \                                 In  segment CODE, align 2
     81          void MT_TaskInit(uint8 task_id)
   \                     MT_TaskInit:
     82          {
   \   000000   0A12         PUSH.W  R10
   \   000002   4A4C         MOV.B   R12, R10
     83            MT_TaskID = task_id;
   \   000004   C24C....     MOV.B   R12, &MT_TaskID
     84          
     85            /* Initialize the Serial port */
     86            MT_UartInit();
   \   000008   ........     CALLA   #MT_UartInit
     87          
     88            /* Register taskID - Do this after UartInit() because it will reset the taskID */
     89            MT_UartRegisterTaskID(task_id);
   \   00000C   4C4A         MOV.B   R10, R12
   \   00000E   ........     CALLA   #MT_UartRegisterTaskID
     90          
     91            osal_set_event(task_id, MT_SECONDARY_INIT_EVENT);
   \   000012   3D401000     MOV.W   #0x10, R13
   \   000016   4C4A         MOV.B   R10, R12
   \   000018   ........     CALLA   #osal_set_event
     92          }
   \   00001C   3A41         POP.W   R10
   \   00001E   1001         RETA
     93          
     94          /**************************************************************************************************
     95           * @fn      MT_ProcessEvent
     96           *
     97           * @brief   MonitorTest Task Event Processor.  This task is put into the task table.
     98           *
     99           * @param   task_id - task ID of the MT Task
    100           * @param   events - event(s) for the MT Task
    101           *
    102           * @return  Bit mask of the unprocessed MT Task events.
    103           **************************************************************************************************/

   \                                 In  segment CODE, align 2
    104          UINT16 MT_ProcessEvent(uint8 task_id, uint16 events)
   \                     MT_ProcessEvent:
    105          {
   \   000000   1B15         PUSHM.W #0x2, R11
   \   000002   0A4D         MOV.W   R13, R10
    106            /* Could be multiple events, so switch won't work */
    107            if ( events & SYS_EVENT_MSG )
   \   000004   0D93         CMP.W   #0x0, R13
   \   000006   0D34         JGE     ??MT_ProcessEvent_1
    108            {
    109              uint8 *msg_ptr = osal_msg_receive(task_id);
   \   000008   ........     CALLA   #osal_msg_receive
   \   00000C   0B4C         MOV.W   R12, R11
    110          
    111              if (msg_ptr != NULL)
   \   00000E   0C93         CMP.W   #0x0, R12
   \   000010   0524         JEQ     ??MT_ProcessEvent_2
    112              {
    113                MT_ProcessIncomingCommand((mtOSALSerialData_t *)msg_ptr);
   \   000012   ........     CALLA   #MT_ProcessIncomingCommand
    114          
    115                osal_msg_deallocate(msg_ptr);
   \   000016   0C4B         MOV.W   R11, R12
   \   000018   ........     CALLA   #osal_msg_deallocate
    116              }
    117          
    118              /* Return unproccessed events */
    119              return (events ^ SYS_EVENT_MSG);
   \                     ??MT_ProcessEvent_2:
   \   00001C   3AE00080     XOR.W   #0x8000, R10
   \   000020   363C         JMP     ??MT_ProcessEvent_0
    120            }
    121          
    122            if ( events & MT_SECONDARY_INIT_EVENT )
   \                     ??MT_ProcessEvent_1:
   \   000022   3DB01000     BIT.W   #0x10, R13
   \   000026   0528         JNC     ??MT_ProcessEvent_3
    123            {
    124              MT_Init();
   \   000028   ........     CALLA   #MT_Init
    125              /* Return unproccessed events */
    126              return (events ^ MT_SECONDARY_INIT_EVENT);
   \   00002C   3AE01000     XOR.W   #0x10, R10
   \   000030   2E3C         JMP     ??MT_ProcessEvent_0
    127            }
    128          
    129            if ( events & MT_ZTOOL_SERIAL_RCV_BUFFER_FULL )
   \                     ??MT_ProcessEvent_3:
   \   000032   2DB3         BIT.W   #0x2, R13
   \   000034   0228         JNC     ??MT_ProcessEvent_4
    130            {
    131              /* Return unproccessed events */
    132              return (events ^ MT_ZTOOL_SERIAL_RCV_BUFFER_FULL);
   \   000036   2AE3         XOR.W   #0x2, R10
   \   000038   2A3C         JMP     ??MT_ProcessEvent_0
    133            }
    134          
    135          #if !defined( NONWK )
    136            if ( events & MT_AF_EXEC_EVT )
   \                     ??MT_ProcessEvent_4:
   \   00003A   3DB2         BIT.W   #0x8, R13
   \   00003C   0428         JNC     ??MT_ProcessEvent_5
    137            {
    138              MT_AfExec();
   \   00003E   ........     CALLA   #MT_AfExec
    139              return (events ^ MT_AF_EXEC_EVT);
   \   000042   3AE2         XOR.W   #0x8, R10
   \   000044   243C         JMP     ??MT_ProcessEvent_0
    140            }
    141          #endif  /* NONWK */
    142          
    143            /* Handle MT_SYS_OSAL_START_TIMER callbacks */
    144          #if defined MT_SYS_FUNC
    145            if ( events & (MT_SYS_OSAL_EVENT_MASK))
   \                     ??MT_ProcessEvent_5:
   \   000046   3DB0000F     BIT.W   #0xf00, R13
   \   00004A   2324         JEQ     ??MT_ProcessEvent_6
    146            {
    147              if (events & MT_SYS_OSAL_EVENT_0)
   \   00004C   3DB00008     BIT.W   #0x800, R13
   \   000050   0528         JNC     ??MT_ProcessEvent_7
    148              {
    149                MT_SysOsalTimerExpired(0x00);
   \   000052   4C43         MOV.B   #0x0, R12
   \   000054   ........     CALLA   #MT_SysOsalTimerExpired
    150                events ^= MT_SYS_OSAL_EVENT_0;
   \   000058   3AE00008     XOR.W   #0x800, R10
    151              }
    152          
    153              if (events & MT_SYS_OSAL_EVENT_1)
   \                     ??MT_ProcessEvent_7:
   \   00005C   3AB00004     BIT.W   #0x400, R10
   \   000060   0528         JNC     ??MT_ProcessEvent_8
    154              {
    155                MT_SysOsalTimerExpired(0x01);
   \   000062   5C43         MOV.B   #0x1, R12
   \   000064   ........     CALLA   #MT_SysOsalTimerExpired
    156                events ^= MT_SYS_OSAL_EVENT_1;
   \   000068   3AE00004     XOR.W   #0x400, R10
    157              }
    158          
    159              if (events & MT_SYS_OSAL_EVENT_2)
   \                     ??MT_ProcessEvent_8:
   \   00006C   3AB00002     BIT.W   #0x200, R10
   \   000070   0528         JNC     ??MT_ProcessEvent_9
    160              {
    161                MT_SysOsalTimerExpired(0x02);
   \   000072   6C43         MOV.B   #0x2, R12
   \   000074   ........     CALLA   #MT_SysOsalTimerExpired
    162                events ^= MT_SYS_OSAL_EVENT_2;
   \   000078   3AE00002     XOR.W   #0x200, R10
    163              }
    164          
    165              if (events & MT_SYS_OSAL_EVENT_3)
   \                     ??MT_ProcessEvent_9:
   \   00007C   3AB00001     BIT.W   #0x100, R10
   \   000080   0628         JNC     ??MT_ProcessEvent_0
    166              {
    167                MT_SysOsalTimerExpired(0x03);
   \   000082   7C400300     MOV.B   #0x3, R12
   \   000086   ........     CALLA   #MT_SysOsalTimerExpired
    168                events ^= MT_SYS_OSAL_EVENT_3;
   \   00008A   3AE00001     XOR.W   #0x100, R10
    169              }
    170          
    171              return events;
   \                     ??MT_ProcessEvent_0:
   \   00008E   0C4A         MOV.W   R10, R12
   \   000090   013C         JMP     ??MT_ProcessEvent_10
    172            }
    173          #endif
    174          
    175            /* Discard or make more handlers */
    176            return 0;
   \                     ??MT_ProcessEvent_6:
   \   000092   0C43         MOV.W   #0x0, R12
   \                     ??MT_ProcessEvent_10:
   \   000094   1A17         POPM.W  #0x2, R11
   \   000096   1001         RETA
    177          
    178          } /* MT_ProcessEvent() */
    179          
    180          /***************************************************************************************************
    181           * @fn      MT_ProcessIncomingCommand
    182           *
    183           * @brief
    184           *
    185           *   Process Event Messages.
    186           *
    187           * @param   *msg - pointer to event message
    188           *
    189           * @return
    190           ***************************************************************************************************/

   \                                 In  segment CODE, align 2
    191          static void MT_ProcessIncomingCommand( mtOSALSerialData_t *msg )
   \                     MT_ProcessIncomingCommand:
    192          {
   \   000000   1B15         PUSHM.W #0x2, R11
    193            uint8 len, *msg_ptr = msg->msg;
   \   000002   1B4C0200     MOV.W   0x2(R12), R11
    194          
    195            /* Use the first byte of the message as the command ID */
    196            switch ( msg->hdr.event )
   \   000006   6E4C         MOV.B   @R12, R14
   \   000008   5E83         SUB.B   #0x1, R14
   \   00000A   0A24         JEQ     ??MT_ProcessIncomingCommand_0
   \   00000C   5E83         SUB.B   #0x1, R14
   \   00000E   0C24         JEQ     ??MT_ProcessIncomingCommand_1
   \   000010   6E83         SUB.B   #0x2, R14
   \   000012   0D24         JEQ     ??MT_ProcessIncomingCommand_2
   \   000014   6E83         SUB.B   #0x2, R14
   \   000016   1F24         JEQ     ??MT_ProcessIncomingCommand_3
   \   000018   7E801E00     SUB.B   #0x1e, R14
   \   00001C   1F24         JEQ     ??MT_ProcessIncomingCommand_4
   \   00001E   253C         JMP     ??MT_ProcessIncomingCommand_5
    197            {
    198              case CMD_SERIAL_MSG:
    199                MT_ProcessIncoming(msg_ptr);
   \                     ??MT_ProcessIncomingCommand_0:
   \   000020   0C4B         MOV.W   R11, R12
   \   000022   ........     CALLA   #MT_ProcessIncoming
    200                break;
   \   000026   213C         JMP     ??MT_ProcessIncomingCommand_5
    201          
    202              case CMD_DEBUG_MSG:
    203                MT_ProcessDebugMsg( (mtDebugMsg_t *)msg );
   \                     ??MT_ProcessIncomingCommand_1:
   \   000028   ........     CALLA   #MT_ProcessDebugMsg
    204                break;
   \   00002C   1E3C         JMP     ??MT_ProcessIncomingCommand_5
    205          
    206              case CB_FUNC:
    207                /*
    208                  Build SPI message here instead of redundantly calling MT_BuildSPIMsg
    209                  because we have copied data already in the allocated message
    210                */
    211          
    212                /* msg_ptr is the beginning of the intended SPI message */
    213                len = SPI_0DATA_MSG_LEN + msg_ptr[DATALEN_FIELD];
   \                     ??MT_ProcessIncomingCommand_2:
   \   00002E   5A4B0300     MOV.B   0x3(R11), R10
   \   000032   7A500500     ADD.B   #0x5, R10
    214          
    215                /*
    216                  FCS goes to the last byte in the message and is calculated over all
    217                  the bytes except FCS and SOP
    218                */
    219                msg_ptr[len-1] = MT_UartCalcFCS(msg_ptr + 1, (uint8)(len-2));
   \   000036   4D4A         MOV.B   R10, R13
   \   000038   6D83         SUB.B   #0x2, R13
   \   00003A   0C4B         MOV.W   R11, R12
   \   00003C   1C53         ADD.W   #0x1, R12
   \   00003E   ........     CALLA   #MT_UartCalcFCS
   \   000042   0F4B         MOV.W   R11, R15
   \   000044   0F5A         ADD.W   R10, R15
   \   000046   CF4CFFFF     MOV.B   R12, 0xffff(R15)
    220          
    221          #ifdef MT_UART_DEFAULT_PORT
    222                HalUARTWrite ( MT_UART_DEFAULT_PORT, msg_ptr, len );
   \   00004A   4E4A         MOV.B   R10, R14
   \   00004C   0D4B         MOV.W   R11, R13
   \   00004E   4C43         MOV.B   #0x0, R12
   \   000050   ........     CALLA   #HalUARTWrite
    223          #endif
    224                break;
   \   000054   0A3C         JMP     ??MT_ProcessIncomingCommand_5
    225          
    226              case CMD_DEBUG_STR:
    227                MT_ProcessDebugStr( (mtDebugStr_t *)msg );
   \                     ??MT_ProcessIncomingCommand_3:
   \   000056   ........     CALLA   #MT_ProcessDebugStr
    228                break;
   \   00005A   073C         JMP     ??MT_ProcessIncomingCommand_5
    229          
    230          #if !defined ( NONWK )
    231              case MT_SYS_APP_RSP_MSG:
    232                len = SPI_0DATA_MSG_LEN + msg_ptr[DATALEN_FIELD];
    233                MTProcessAppRspMsg( msg_ptr, len );
   \                     ??MT_ProcessIncomingCommand_4:
   \   00005C   5D4B0300     MOV.B   0x3(R11), R13
   \   000060   7D500500     ADD.B   #0x5, R13
   \   000064   0C4B         MOV.W   R11, R12
   \   000066   ........     CALLA   #MTProcessAppRspMsg
    234                break;
    235          #endif  // NONWK
    236          
    237          #if defined (MT_UTIL_FUNC)
    238          #if defined ZCL_KEY_ESTABLISH
    239              case ZCL_KEY_ESTABLISH_IND:
    240                MT_UtilKeyEstablishInd((keyEstablishmentInd_t *)msg);
    241                break;
    242          #endif
    243          #endif
    244          #ifdef MT_ZDO_CB_FUNC
    245              case ZDO_STATE_CHANGE:
    246                MT_ZdoStateChangeCB((osal_event_hdr_t *)msg);
    247                break;
    248          #endif
    249          
    250              default:
    251                break;
    252            }
    253          }
   \                     ??MT_ProcessIncomingCommand_5:
   \   00006A   1A17         POPM.W  #0x2, R11
   \   00006C   1001         RETA
    254          
    255          #ifdef MT_TASK
    256          /***************************************************************************************************
    257           * @fn      MT_TransportAlloc
    258           *
    259           * @brief   Allocate memory for transport msg
    260           *
    261           * @param   uint8 cmd0 - The first byte of the MT command id containing the command type and subsystem.
    262           *          uint8 len - length
    263           *
    264           * @return  pointer the allocated memory or NULL if fail to allocate the memory
    265           ***************************************************************************************************/

   \                                 In  segment CODE, align 2
    266          uint8 *MT_TransportAlloc(uint8 cmd0, uint8 len)
   \                     MT_TransportAlloc:
    267          {
    268            uint8 *p;
    269          
    270            (void)cmd0;  // Intentionally unreferenced parameter
    271          
    272            /* Allocate a buffer of data length + SOP+CMD+FCS (5 bytes) */
    273            p = osal_msg_allocate(len + SPI_0DATA_MSG_LEN);
   \   000000   4C4D         MOV.B   R13, R12
   \   000002   3C500500     ADD.W   #0x5, R12
   \   000006   ........     CALLA   #osal_msg_allocate
    274          
    275            if (p)
   \   00000A   0C93         CMP.W   #0x0, R12
   \   00000C   0224         JEQ     ??MT_TransportAlloc_0
    276            {
    277              p++; /* Save space for SOP_VALUE, msg structure */
    278              return p;
   \   00000E   1C53         ADD.W   #0x1, R12
   \   000010   1001         RETA
    279            }
    280            else
    281            {
    282              return NULL;
   \                     ??MT_TransportAlloc_0:
   \   000012   0C43         MOV.W   #0x0, R12
   \   000014   1001         RETA
    283            }
    284          }
    285          
    286          /***************************************************************************************************
    287           * @fn      MT_TransportSend
    288           *
    289           * @brief   Fill in SOP and FCS then send out the msg
    290           *
    291           * @param   uint8 *pBuf - pointer to the message that contains CMD, length, data and FCS
    292           *
    293           * @return  None
    294           ***************************************************************************************************/

   \                                 In  segment CODE, align 2
    295          void MT_TransportSend(uint8 *pBuf)
   \                     MT_TransportSend:
    296          {
   \   000000   1B15         PUSHM.W #0x2, R11
    297            uint8 *msgPtr;
    298            uint8 dataLen = pBuf[0]; /* Data length is on byte #1 from the pointer */
   \   000002   6D4C         MOV.B   @R12, R13
    299          
    300            /* Move back to the SOP */
    301            msgPtr = pBuf-1;
   \   000004   0A4C         MOV.W   R12, R10
   \   000006   3A53         ADD.W   #0xffff, R10
    302          
    303            /* Insert SOP */
    304            msgPtr[0] = MT_UART_SOF;
   \   000008   FA40FE000000 MOV.B   #0xfe, 0(R10)
    305          
    306            /* Insert FCS */
    307            msgPtr[SPI_0DATA_MSG_LEN - 1 + dataLen] = MT_UartCalcFCS (pBuf, (3 + dataLen));
   \   00000E   4B4D         MOV.B   R13, R11
   \   000010   7D500300     ADD.B   #0x3, R13
   \   000014   ........     CALLA   #MT_UartCalcFCS
   \   000018   0F4A         MOV.W   R10, R15
   \   00001A   0F5B         ADD.W   R11, R15
   \   00001C   CF4C0400     MOV.B   R12, 0x4(R15)
    308          
    309            /* Send to UART */
    310          #ifdef MT_UART_DEFAULT_PORT
    311            HalUARTWrite(MT_UART_DEFAULT_PORT, msgPtr, dataLen + SPI_0DATA_MSG_LEN);
   \   000020   3B500500     ADD.W   #0x5, R11
   \   000024   0E4B         MOV.W   R11, R14
   \   000026   0D4A         MOV.W   R10, R13
   \   000028   4C43         MOV.B   #0x0, R12
   \   00002A   ........     CALLA   #HalUARTWrite
    312          #endif
    313          
    314            /* Deallocate */
    315            osal_msg_deallocate(msgPtr);
   \   00002E   0C4A         MOV.W   R10, R12
   \   000030   ........     CALLA   #osal_msg_deallocate
    316          }
   \   000034   1A17         POPM.W  #0x2, R11
   \   000036   1001         RETA
    317          #endif /* MT_TASK */
    318          /***************************************************************************************************
    319           ***************************************************************************************************/

   Maximum stack usage in bytes:

   CSTACK Function
   ------ --------
      8   MT_ProcessEvent
        8   -> MT_AfExec
        8   -> MT_Init
        8   -> MT_ProcessIncomingCommand
        8   -> MT_SysOsalTimerExpired
        8   -> osal_msg_deallocate
        8   -> osal_msg_receive
      8   MT_ProcessIncomingCommand
        8   -> HalUARTWrite
        8   -> MTProcessAppRspMsg
        8   -> MT_ProcessDebugMsg
        8   -> MT_ProcessDebugStr
        8   -> MT_ProcessIncoming
        8   -> MT_UartCalcFCS
      6   MT_TaskInit
        6   -> MT_UartInit
        6   -> MT_UartRegisterTaskID
        6   -> osal_set_event
      4   MT_TransportAlloc
        4   -> osal_msg_allocate
      8   MT_TransportSend
        8   -> HalUARTWrite
        8   -> MT_UartCalcFCS
        8   -> osal_msg_deallocate


   Segment part sizes:

   Bytes  Function/Label
   -----  --------------
     152  MT_ProcessEvent
     110  MT_ProcessIncomingCommand
       1  MT_TaskID
      32  MT_TaskInit
      22  MT_TransportAlloc
      56  MT_TransportSend

 
 372 bytes in segment CODE
   1 byte  in segment DATA16_Z
 
 372 bytes of CODE memory
   1 byte  of DATA memory

Errors: none
Warnings: none
