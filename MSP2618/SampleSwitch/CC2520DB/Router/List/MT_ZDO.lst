###############################################################################
#                                                                             #
# IAR C/C++ Compiler V5.52.1.50724/W32 for MSP430       10/Jun/2013  16:30:12 #
# Copyright 1996-2013 IAR Systems AB.                                         #
#                                                                             #
#    __rt_version  =  3                                                       #
#    __double_size =  32                                                      #
#    __reg_r4      =  free                                                    #
#    __reg_r5      =  free                                                    #
#    __pic         =  no                                                      #
#    __core        =  430X                                                    #
#    __data_model  =  small                                                   #
#    Source file   =  C:\Texas Instruments\ZStack-MSP2618-2.5.1\Components\mt #
#                     \MT_ZDO.c                                               #
#    Command line  =  -f "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\ #
#                     zstack\HomeAutomation\SampleSwitch\CC2520DB\..\..\..\To #
#                     ols\MSP2618\f8wConfig.cfg" (-DZIGBEEPRO -DSECURE=0      #
#                     -DZG_SECURE_DYNAMIC=0 -DREFLECTOR                       #
#                     -DDEFAULT_CHANLIST=0x00000800                           #
#                     -DZDAPP_CONFIG_PAN_ID=0xFFFF -DNWK_START_DELAY=100      #
#                     -DEXTENDED_JOINING_RANDOM_MASK=0x007F                   #
#                     -DBEACON_REQUEST_DELAY=100                              #
#                     -DBEACON_REQ_DELAY_MASK=0x00FF                          #
#                     -DLINK_STATUS_JITTER_MASK=0x007F                        #
#                     -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_POLLED= #
#                     3000 -DNWK_INDIRECT_MSG_TIMEOUT=7 -DMAX_RREQ_ENTRIES=8  #
#                     -DAPSC_MAX_FRAME_RETRIES=3 -DNWK_MAX_DATA_RETRIES=2     #
#                     -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9              #
#                     -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40                #
#                     -DNWK_MAX_BINDING_ENTRIES=4                             #
#                     -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,       #
#                     0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00, 0x02,   #
#                     0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"                    #
#                     -DMAC_MAX_FRAME_SIZE=116 -DZDNWKMGR_MIN_TRANSMISSIONS=2 #
#                     0 -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=1000           #
#                     -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100         #
#                     -DREJOIN_POLL_RATE=440) -f "C:\Texas                    #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\Tools\MSP2618\f #
#                     8wRouter.cfg" (-DCPU6MHZ -DMAC_CFG_APP_PENDING_QUEUE=TR #
#                     UE -DMAC_CFG_TX_DATA_MAX=5 -DMAC_CFG_TX_MAX=8           #
#                     -DMAC_CFG_RX_MAX=5 -DRTR_NWK) -f "C:\Texas              #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\Tools\MSP2618\f #
#                     8wZCL.cfg" (-DZCL_READ -DZCL_WRITE -DZCL_BASIC          #
#                     -DZCL_IDENTIFY -DZCL_ON_OFF -DZCL_KEY_ESTABLISH         #
#                     -DZCL_KEY_ESTABLISHMENT_KEY_GENERATE_TIMEOUT=4          #
#                     -DZCL_KEY_ESTABLISHMENT_MAC_GENERATE_TIMEOUT=10         #
#                     -DZCL_KEY_ESTABLISHMENT_EKEY_GENERATE_TIMEOUT=10        #
#                     -DZCL_LOAD_CONTROL -DZCL_SIMPLE_METERING -DZCL_PRICING  #
#                     -DZCL_MESSAGE -DZCL_TUNNELING -DZCL_TOU)                #
#                     -DZCL_DEVICE_MGMT "C:\Texas                             #
#                     Instruments\ZStack-MSP2618-2.5.1\Components\mt\MT_ZDO.c #
#                     " -D MSP430F2618 -D ZTOOL_P1 -D MT_TASK -D MT_SYS_FUNC  #
#                     -D MT_ZDO_FUNC -D LCD_SUPPORTED -lC "C:\Texas           #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\Router\List\" -lA        #
#                     "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zst #
#                     ack\HomeAutomation\SampleSwitch\CC2520DB\Router\List\"  #
#                     --remarks --diag_suppress Pe001,Pe193,Pe236,Pe826 -o    #
#                     "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zst #
#                     ack\HomeAutomation\SampleSwitch\CC2520DB\Router\Obj\"   #
#                     --debug -D__MSP430F2618__ -e --double=32 --clib -I      #
#                     "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zst #
#                     ack\HomeAutomation\SampleSwitch\CC2520DB\" -I           #
#                     "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zst #
#                     ack\HomeAutomation\SampleSwitch\CC2520DB\..\Source\"    #
#                     -I "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\ #
#                     zstack\HomeAutomation\SampleSwitch\CC2520DB\..\..\Sourc #
#                     e\" -I "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Proje #
#                     cts\zstack\HomeAutomation\SampleSwitch\CC2520DB\..\..\. #
#                     .\ZMain\MSP2618\" -I "C:\Texas                          #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\hal\include\" -I "C:\Texas                            #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\hal\target\MSP2618CC2520\" -I "C:\Texas               #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\mac\include\" -I "C:\Texas                            #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\mac\high_level\" -I "C:\Texas                         #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\mac\low_level\srf04\" -I "C:\Texas                    #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\mac\low_level\srf04\dual_chip\" -I "C:\Texas          #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\mt\" -I "C:\Texas Instruments\ZStack-MSP2618-2.5.1\Pr #
#                     ojects\zstack\HomeAutomation\SampleSwitch\CC2520DB\..\. #
#                     .\..\..\..\Components\osal\include\" -I "C:\Texas       #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\osal\mcu\msp430\" -I "C:\Texas                        #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\services\saddr\" -I "C:\Texas                         #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\services\sdata\" -I "C:\Texas                         #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\stack\af\" -I "C:\Texas Instruments\ZStack-MSP2618-2. #
#                     5.1\Projects\zstack\HomeAutomation\SampleSwitch\CC2520D #
#                     B\..\..\..\..\..\Components\stack\nwk\" -I "C:\Texas    #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\stack\sec\" -I "C:\Texas                              #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\stack\sapi\" -I "C:\Texas                             #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\stack\sys\" -I "C:\Texas                              #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\stack\zcl\" -I "C:\Texas                              #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\stack\zdo\" -I "C:\Texas                              #
#                     Instruments\ZStack-MSP2618-2.5.1\Projects\zstack\HomeAu #
#                     tomation\SampleSwitch\CC2520DB\..\..\..\..\..\Component #
#                     s\zmac\" -I "C:\Texas Instruments\ZStack-MSP2618-2.5.1\ #
#                     Projects\zstack\HomeAutomation\SampleSwitch\CC2520DB\.. #
#                     \..\..\..\..\Components\zmac\f8w\" --core=430X          #
#                     --data_model=small -Ohz --multiplier=16s                #
#                     --require_prototypes                                    #
#    List file     =  C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zsta #
#                     ck\HomeAutomation\SampleSwitch\CC2520DB\Router\List\MT_ #
#                     ZDO.lst                                                 #
#    Object file   =  C:\Texas Instruments\ZStack-MSP2618-2.5.1\Projects\zsta #
#                     ck\HomeAutomation\SampleSwitch\CC2520DB\Router\Obj\MT_Z #
#                     DO.r43                                                  #
#                                                                             #
#                                                                             #
###############################################################################

C:\Texas Instruments\ZStack-MSP2618-2.5.1\Components\mt\MT_ZDO.c
      1          /**************************************************************************************************
      2            Filename:       MT_ZDO.c
      3            Revised:        $Date: 2012-02-16 16:04:32 -0800 (Thu, 16 Feb 2012) $
      4            Revision:       $Revision: 29348 $
      5          
      6            Description:    MonitorTest functions for the ZDO layer.
      7          
      8          
      9            Copyright 2004-2012 Texas Instruments Incorporated. All rights reserved.
     10          
     11            IMPORTANT: Your use of this Software is limited to those specific rights
     12            granted under the terms of a software license agreement between the user
     13            who downloaded the software, his/her employer (which must be your employer)
     14            and Texas Instruments Incorporated (the "License"). You may not use this
     15            Software unless you agree to abide by the terms of the License. The License
     16            limits your use, and you acknowledge, that the Software may not be modified,
     17            copied or distributed unless embedded on a Texas Instruments microcontroller
     18            or used solely and exclusively in conjunction with a Texas Instruments radio
     19            frequency transceiver, which is integrated into your product. Other than for
     20            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     21            works of, modify, distribute, perform, display or sell this Software and/or
     22            its documentation for any purpose.
     23          
     24            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     25            PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     26            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     27            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     28            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     29            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     30            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     31            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     32            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     33            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     34            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     35          
     36            Should you have any questions regarding your right to use this Software,
     37            contact Texas Instruments Incorporated at www.TI.com.
     38          **************************************************************************************************/
     39          
     40          #ifdef MT_ZDO_FUNC
     41          
     42          /**************************************************************************************************
     43           * INCLUDES
     44           **************************************************************************************************/
     45          #include "ZComDef.h"
     46          #include "OSAL.h"
     47          #include "OSAL_Nv.h"
     48          #include "MT.h"
     49          #include "MT_ZDO.h"
     50          #include "APSMEDE.h"
     51          #include "ZDConfig.h"
     52          #include "ZDProfile.h"
     53          #include "ZDObject.h"
     54          #include "ZDApp.h"
     55          
     56          #if !defined( WIN32 )
     57            #include "OnBoard.h"
     58          #endif
     59          
     60          #if defined ( MT_SYS_KEY_MANAGEMENT )
     61            #include "ZDSecMgr.h"
     62          #endif
     63          
     64          #include "nwk_util.h"
     65          
     66          /**************************************************************************************************
     67           * CONSTANTS
     68           **************************************************************************************************/
     69          #define MT_ZDO_END_DEVICE_ANNCE_IND_LEN   0x0D
     70          #define MT_ZDO_ADDR_RSP_LEN               0x0D
     71          #define MT_ZDO_BIND_UNBIND_RSP_LEN        0x03
     72          #define MT_ZDO_BEACON_IND_LEN             21
     73          #define MT_ZDO_BEACON_IND_PACK_LEN        (MT_UART_TX_BUFF_MAX - SPI_0DATA_MSG_LEN)
     74          #define MT_ZDO_JOIN_CNF_LEN               5
     75          
     76          // Message must pack nwk addr, entire (not just pointer to) ieee addr, and packet cost, so the
     77          // sizeof(zdoConcentratorInd_t) is not usable.
     78          #define MT_ZDO_CONCENTRATOR_IND_LEN      (2 + Z_EXTADDR_LEN + 1)
     79          
     80          #define MTZDO_RESPONSE_BUFFER_LEN   100
     81          
     82          #define MTZDO_MAX_MATCH_CLUSTERS    16
     83          #define MTZDO_MAX_ED_BIND_CLUSTERS  15
     84          
     85          // Conversion from ZDO Cluster Id to the RPC AREQ Id is direct as follows:
     86          #define MT_ZDO_CID_TO_AREQ_ID(CId)  ((uint8)(CId) | 0x80)
     87          
     88          #define MT_ZDO_STATUS_LEN   1
     89          
     90          /**************************************************************************************************
     91           * GLOBAL VARIABLES
     92           **************************************************************************************************/

   \                                 In  segment DATA16_Z, align 2, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
     93          uint32 _zdoCallbackSub;
   \                     _zdoCallbackSub:
   \   000000                DS8 4

   \                                 In  segment DATA16_Z, align 2, align-sorted
   \   000000                REQUIRE ?cstart_init_zero
     94          uint8 *pBeaconIndBuf = NULL;
   \                     pBeaconIndBuf:
   \   000000                DS8 2
     95          
     96          /**************************************************************************************************
     97           * LOCAL VARIABLES
     98           **************************************************************************************************/
     99          
    100          /**************************************************************************************************
    101           * LOCAL FUNCTIONS
    102           **************************************************************************************************/
    103          #if defined (MT_ZDO_FUNC)
    104          void MT_ZdoNWKAddressRequest(uint8 *pBuf);
    105          void MT_ZdoIEEEAddrRequest(uint8 *pBuf);
    106          void MT_ZdoNodeDescRequest(uint8 *pBuf);
    107          void MT_ZdoPowerDescRequest(uint8 *pBuf);
    108          void MT_ZdoSimpleDescRequest(uint8 *pBuf);
    109          void MT_ZdoActiveEpRequest(uint8 *pBuf);
    110          void MT_ZdoMatchDescRequest(uint8 *pBuf);
    111          void MT_ZdoComplexDescRequest(uint8 *pBuf);
    112          void MT_ZdoUserDescRequest(uint8 *pBuf);
    113          void MT_ZdoEndDevAnnce(uint8 *pBuf);
    114          void MT_ZdoUserDescSet(uint8 *pBuf);
    115          void MT_ZdoServiceDiscRequest(uint8 *pBuf);
    116          void MT_ZdoEndDevBindRequest(uint8 *pBuf);
    117          void MT_ZdoBindRequest(uint8 *pBuf);
    118          void MT_ZdoUnbindRequest(uint8 *pBuf);
    119          void MT_ZdoMgmtNwkDiscRequest(uint8 *pBuf);
    120          #if defined ( MT_SYS_KEY_MANAGEMENT )
    121          void MT_ZdoSetLinkKey(uint8 *pBuf);
    122          void MT_ZdoRemoveLinkKey(uint8 *pBuf);
    123          void MT_ZdoGetLinkKey(uint8 *pBuf);
    124          #endif /* MT_SYS_KEY_MANAGEMENT */
    125          void MT_ZdoNetworkDiscoveryReq(uint8 *pBuf);
    126          void MT_ZdoJoinReq(uint8 *pBuf);
    127          /* Call back function */
    128          void *MT_ZdoNwkDiscoveryCnfCB ( void *pStr );
    129          void *MT_ZdoBeaconIndCB ( void *pStr );
    130          void *MT_ZdoJoinCnfCB ( void *pStr );
    131          #if defined (MT_ZDO_MGMT)
    132          void MT_ZdoMgmtLqiRequest(uint8 *pBuf);
    133          void MT_ZdoMgmtRtgRequest(uint8 *pBuf);
    134          void MT_ZdoMgmtBindRequest(uint8 *pBuf);
    135          void MT_ZdoMgmtLeaveRequest(uint8 *pBuf);
    136          void MT_ZdoMgmtDirectJoinRequest(uint8 *pBuf);
    137          void MT_ZdoMgmtPermitJoinRequest(uint8 *pBuf);
    138          void MT_ZdoMgmtNwkUpdateRequest(uint8 *pBuf);
    139          #endif /* MT_ZDO_MGMT */
    140          void MT_ZdoStartupFromApp(uint8 *pBuf);
    141          void MT_ZdoRegisterForZDOMsg(uint8 *pBuf);
    142          void MT_ZdoRemoveRegisteredCB(uint8 *pBuf);
    143          #endif /* MT_ZDO_FUNC */
    144          
    145          #if defined (MT_ZDO_CB_FUNC)
    146          uint8 MT_ZdoHandleExceptions( afIncomingMSGPacket_t *pData, zdoIncomingMsg_t *inMsg );
    147          void MT_ZdoAddrRspCB( ZDO_NwkIEEEAddrResp_t *pMsg, uint16 clusterID );
    148          void MT_ZdoEndDevAnnceCB( ZDO_DeviceAnnce_t *pMsg, uint16 srcAddr );
    149          void MT_ZdoBindUnbindRspCB( uint16 clusterID, uint16 srcAddr, uint8 status );
    150          void* MT_ZdoSrcRtgCB( void *pStr );
    151          static void *MT_ZdoConcentratorIndCB(void *pStr);
    152          static void *MT_ZdoLeaveInd(void *vPtr);
    153          #endif /* MT_ZDO_CB_FUNC */
    154          
    155          #if defined (MT_ZDO_FUNC)
    156          /***************************************************************************************************
    157           * @fn      MT_ZdoInit
    158           *
    159           * @brief   MT ZDO initialization
    160           *
    161           * @param   none
    162           *
    163           * @return  none
    164           ***************************************************************************************************/

   \                                 In  segment CODE, align 2
    165          void MT_ZdoInit(void)
   \                     MT_ZdoInit:
    166          {
    167          #ifdef MT_ZDO_CB_FUNC
    168            /* Register with ZDO for indication callbacks */
    169            ZDO_RegisterForZdoCB(ZDO_SRC_RTG_IND_CBID, &MT_ZdoSrcRtgCB);
    170            ZDO_RegisterForZdoCB(ZDO_CONCENTRATOR_IND_CBID, &MT_ZdoConcentratorIndCB);
    171            ZDO_RegisterForZdoCB(ZDO_LEAVE_IND_CBID, &MT_ZdoLeaveInd);
    172          #endif
    173          }
   \   000000   1001         RETA
    174          
    175          /***************************************************************************************************
    176           * @fn      MT_ZdoCommandProcessing
    177           *
    178           * @brief
    179           *
    180           *   Process all the ZDO commands that are issued by test tool
    181           *
    182           * @param   pBuf - pointer to the msg buffer
    183           *
    184           *          | LEN  | CMD0  | CMD1  |  DATA  |
    185           *          |  1   |   1   |   1   |  0-255 |
    186           *
    187           * @return  status
    188           ***************************************************************************************************/

   \                                 In  segment CODE, align 2
    189          uint8 MT_ZdoCommandProcessing(uint8* pBuf)
   \                     MT_ZdoCommandProcessing:
    190          {
   \   000000   0A12         PUSH.W  R10
    191            uint8 status = MT_RPC_SUCCESS;
   \   000002   4A43         MOV.B   #0x0, R10
    192          
    193            switch (pBuf[MT_RPC_POS_CMD1])
   \   000004   5E4C0200     MOV.B   0x2(R12), R14
   \   000008   4E83         SUB.B   #0x0, R14
   \   00000A   2924         JEQ     ??MT_ZdoCommandProcessing_0
   \   00000C   5E83         SUB.B   #0x1, R14
   \   00000E   2A24         JEQ     ??MT_ZdoCommandProcessing_1
   \   000010   5E83         SUB.B   #0x1, R14
   \   000012   2B24         JEQ     ??MT_ZdoCommandProcessing_2
   \   000014   5E83         SUB.B   #0x1, R14
   \   000016   2C24         JEQ     ??MT_ZdoCommandProcessing_3
   \   000018   5E83         SUB.B   #0x1, R14
   \   00001A   2D24         JEQ     ??MT_ZdoCommandProcessing_4
   \   00001C   5E83         SUB.B   #0x1, R14
   \   00001E   2E24         JEQ     ??MT_ZdoCommandProcessing_5
   \   000020   5E83         SUB.B   #0x1, R14
   \   000022   2F24         JEQ     ??MT_ZdoCommandProcessing_6
   \   000024   5E83         SUB.B   #0x1, R14
   \   000026   3024         JEQ     ??MT_ZdoCommandProcessing_7
   \   000028   5E83         SUB.B   #0x1, R14
   \   00002A   3124         JEQ     ??MT_ZdoCommandProcessing_8
   \   00002C   6E83         SUB.B   #0x2, R14
   \   00002E   3224         JEQ     ??MT_ZdoCommandProcessing_9
   \   000030   5E83         SUB.B   #0x1, R14
   \   000032   3324         JEQ     ??MT_ZdoCommandProcessing_10
   \   000034   5E83         SUB.B   #0x1, R14
   \   000036   3424         JEQ     ??MT_ZdoCommandProcessing_11
   \   000038   7E801400     SUB.B   #0x14, R14
   \   00003C   3424         JEQ     ??MT_ZdoCommandProcessing_12
   \   00003E   5E83         SUB.B   #0x1, R14
   \   000040   3524         JEQ     ??MT_ZdoCommandProcessing_13
   \   000042   5E83         SUB.B   #0x1, R14
   \   000044   3624         JEQ     ??MT_ZdoCommandProcessing_14
   \   000046   6E82         SUB.B   #0x4, R14
   \   000048   3724         JEQ     ??MT_ZdoCommandProcessing_15
   \   00004A   5E83         SUB.B   #0x1, R14
   \   00004C   3824         JEQ     ??MT_ZdoCommandProcessing_16
   \   00004E   7E801700     SUB.B   #0x17, R14
   \   000052   3B24         JEQ     ??MT_ZdoCommandProcessing_17
   \   000054   5E83         SUB.B   #0x1, R14
   \   000056   3C24         JEQ     ??MT_ZdoCommandProcessing_18
   \   000058   5E83         SUB.B   #0x1, R14
   \   00005A   3424         JEQ     ??MT_ZdoCommandProcessing_19
   \   00005C   3C3C         JMP     ??MT_ZdoCommandProcessing_20
    194            {
    195          #if defined ( ZDO_NWKADDR_REQUEST )
    196              case MT_ZDO_NWK_ADDR_REQ:
    197                MT_ZdoNWKAddressRequest(pBuf);
   \                     ??MT_ZdoCommandProcessing_0:
   \   00005E   ........     CALLA   #MT_ZdoNWKAddressRequest
    198                break;
   \   000062   3A3C         JMP     ??MT_ZdoCommandProcessing_21
    199          #endif
    200          
    201          #if defined ( ZDO_IEEEADDR_REQUEST )
    202              case MT_ZDO_IEEE_ADDR_REQ:
    203                MT_ZdoIEEEAddrRequest(pBuf);
   \                     ??MT_ZdoCommandProcessing_1:
   \   000064   ........     CALLA   #MT_ZdoIEEEAddrRequest
    204                break;
   \   000068   373C         JMP     ??MT_ZdoCommandProcessing_21
    205          #endif
    206          
    207          #if defined ( ZDO_NODEDESC_REQUEST )
    208              case MT_ZDO_NODE_DESC_REQ:
    209                MT_ZdoNodeDescRequest(pBuf);
   \                     ??MT_ZdoCommandProcessing_2:
   \   00006A   ........     CALLA   #MT_ZdoNodeDescRequest
    210                break;
   \   00006E   343C         JMP     ??MT_ZdoCommandProcessing_21
    211          #endif
    212          
    213          #if defined ( ZDO_POWERDESC_REQUEST )
    214              case MT_ZDO_POWER_DESC_REQ:
    215                MT_ZdoPowerDescRequest(pBuf);
   \                     ??MT_ZdoCommandProcessing_3:
   \   000070   ........     CALLA   #MT_ZdoPowerDescRequest
    216                break;
   \   000074   313C         JMP     ??MT_ZdoCommandProcessing_21
    217          #endif
    218          
    219          #if defined ( ZDO_SIMPLEDESC_REQUEST )
    220              case MT_ZDO_SIMPLE_DESC_REQ:
    221                MT_ZdoSimpleDescRequest(pBuf);
   \                     ??MT_ZdoCommandProcessing_4:
   \   000076   ........     CALLA   #MT_ZdoSimpleDescRequest
    222                break;
   \   00007A   2E3C         JMP     ??MT_ZdoCommandProcessing_21
    223          #endif
    224          
    225          #if defined ( ZDO_ACTIVEEP_REQUEST )
    226              case MT_ZDO_ACTIVE_EP_REQ:
    227                MT_ZdoActiveEpRequest(pBuf);
   \                     ??MT_ZdoCommandProcessing_5:
   \   00007C   ........     CALLA   #MT_ZdoActiveEpRequest
    228                break;
   \   000080   2B3C         JMP     ??MT_ZdoCommandProcessing_21
    229          #endif
    230          
    231          #if defined ( ZDO_MATCH_REQUEST )
    232              case MT_ZDO_MATCH_DESC_REQ:
    233                MT_ZdoMatchDescRequest(pBuf);
   \                     ??MT_ZdoCommandProcessing_6:
   \   000082   ........     CALLA   #MT_ZdoMatchDescRequest
    234                break;
   \   000086   283C         JMP     ??MT_ZdoCommandProcessing_21
    235          #endif
    236          
    237          #if defined ( ZDO_COMPLEXDESC_REQUEST )
    238              case MT_ZDO_COMPLEX_DESC_REQ:
    239                MT_ZdoComplexDescRequest(pBuf);
   \                     ??MT_ZdoCommandProcessing_7:
   \   000088   ........     CALLA   #MT_ZdoComplexDescRequest
    240                break;
   \   00008C   253C         JMP     ??MT_ZdoCommandProcessing_21
    241          #endif
    242          
    243          #if defined ( ZDO_USERDESC_REQUEST )
    244              case MT_ZDO_USER_DESC_REQ:
    245                MT_ZdoUserDescRequest(pBuf);
   \                     ??MT_ZdoCommandProcessing_8:
   \   00008E   ........     CALLA   #MT_ZdoUserDescRequest
    246                break;
   \   000092   223C         JMP     ??MT_ZdoCommandProcessing_21
    247          #endif
    248          
    249          #if defined ( ZDO_ENDDEVICE_ANNCE )
    250              case MT_ZDO_END_DEV_ANNCE:
    251                MT_ZdoEndDevAnnce(pBuf);
   \                     ??MT_ZdoCommandProcessing_9:
   \   000094   ........     CALLA   #MT_ZdoEndDevAnnce
    252                break;
   \   000098   1F3C         JMP     ??MT_ZdoCommandProcessing_21
    253          #endif
    254          
    255          #if defined ( ZDO_USERDESCSET_REQUEST )
    256              case MT_ZDO_USER_DESC_SET:
    257                MT_ZdoUserDescSet(pBuf);
   \                     ??MT_ZdoCommandProcessing_10:
   \   00009A   ........     CALLA   #MT_ZdoUserDescSet
    258                break;
   \   00009E   1C3C         JMP     ??MT_ZdoCommandProcessing_21
    259          #endif
    260          
    261          #if defined ( ZDO_SERVERDISC_REQUEST )
    262              case MT_ZDO_SERVICE_DISC_REQ:
    263                MT_ZdoServiceDiscRequest(pBuf);
   \                     ??MT_ZdoCommandProcessing_11:
   \   0000A0   ........     CALLA   #MT_ZdoServiceDiscRequest
    264                break;
   \   0000A4   193C         JMP     ??MT_ZdoCommandProcessing_21
    265          #endif
    266          
    267          #if defined ( ZDO_ENDDEVICEBIND_REQUEST )
    268              case MT_ZDO_END_DEV_BIND_REQ:
    269                MT_ZdoEndDevBindRequest(pBuf);
   \                     ??MT_ZdoCommandProcessing_12:
   \   0000A6   ........     CALLA   #MT_ZdoEndDevBindRequest
    270                break;
   \   0000AA   163C         JMP     ??MT_ZdoCommandProcessing_21
    271          #endif
    272          
    273          #if defined ( ZDO_BIND_UNBIND_REQUEST )
    274              case MT_ZDO_BIND_REQ:
    275                MT_ZdoBindRequest(pBuf);
   \                     ??MT_ZdoCommandProcessing_13:
   \   0000AC   ........     CALLA   #MT_ZdoBindRequest
    276                break;
   \   0000B0   133C         JMP     ??MT_ZdoCommandProcessing_21
    277          #endif
    278          
    279          #if defined ( ZDO_BIND_UNBIND_REQUEST )
    280              case MT_ZDO_UNBIND_REQ:
    281                MT_ZdoUnbindRequest(pBuf);
   \                     ??MT_ZdoCommandProcessing_14:
   \   0000B2   ........     CALLA   #MT_ZdoUnbindRequest
    282                break;
   \   0000B6   103C         JMP     ??MT_ZdoCommandProcessing_21
    283          #endif
    284          
    285          #if defined ( MT_SYS_KEY_MANAGEMENT )
    286              case MT_ZDO_SET_LINK_KEY:
    287                MT_ZdoSetLinkKey(pBuf);
    288                break;
    289          
    290              case MT_ZDO_REMOVE_LINK_KEY:
    291                MT_ZdoRemoveLinkKey(pBuf);
    292                break;
    293          
    294              case MT_ZDO_GET_LINK_KEY:
    295                MT_ZdoGetLinkKey(pBuf);
    296                break;
    297          #endif // MT_SYS_KEY_MANAGEMENT
    298          
    299          #if defined ( ZDO_MANUAL_JOIN )
    300              case MT_ZDO_NWK_DISCOVERY_REQ:
    301                MT_ZdoNetworkDiscoveryReq(pBuf);
   \                     ??MT_ZdoCommandProcessing_15:
   \   0000B8   ........     CALLA   #MT_ZdoNetworkDiscoveryReq
    302                break;
   \   0000BC   0D3C         JMP     ??MT_ZdoCommandProcessing_21
    303          
    304              case MT_ZDO_JOIN_REQ:
    305                MT_ZdoJoinReq(pBuf);
   \                     ??MT_ZdoCommandProcessing_16:
   \   0000BE   ........     CALLA   #MT_ZdoJoinReq
    306                break;
   \   0000C2   0A3C         JMP     ??MT_ZdoCommandProcessing_21
    307          #endif
    308          
    309          #if defined ( ZDO_MGMT_NWKDISC_REQUEST )
    310              case MT_ZDO_MGMT_NWKDISC_REQ:
    311                MT_ZdoMgmtNwkDiscRequest(pBuf);
    312                break;
    313          #endif
    314          
    315          #if defined ( ZDO_MGMT_LQI_REQUEST )
    316              case MT_ZDO_MGMT_LQI_REQ:
    317                MT_ZdoMgmtLqiRequest(pBuf);
    318                break;
    319          #endif
    320          
    321          #if defined ( ZDO_MGMT_RTG_REQUEST )
    322              case MT_ZDO_MGMT_RTG_REQ:
    323                MT_ZdoMgmtRtgRequest(pBuf);
    324                break;
    325          #endif
    326          
    327          #if defined ( ZDO_MGMT_BIND_REQUEST )
    328              case MT_ZDO_MGMT_BIND_REQ:
    329                MT_ZdoMgmtBindRequest(pBuf);
    330                break;
    331          #endif
    332          
    333          #if defined ( ZDO_MGMT_LEAVE_REQUEST )
    334              case MT_ZDO_MGMT_LEAVE_REQ:
    335                MT_ZdoMgmtLeaveRequest(pBuf);
    336                break;
    337          #endif
    338          
    339          #if defined ( ZDO_MGMT_JOINDIRECT_REQUEST )
    340              case MT_ZDO_MGMT_DIRECT_JOIN_REQ:
    341                MT_ZdoMgmtDirectJoinRequest(pBuf);
    342                break;
    343          #endif
    344          
    345          #if defined ( ZDO_MGMT_PERMIT_JOIN_REQUEST )
    346              case MT_ZDO_MGMT_PERMIT_JOIN_REQ:
    347                MT_ZdoMgmtPermitJoinRequest(pBuf);
    348                break;
    349          #endif
    350          
    351          #if defined ( ZDO_MGMT_NWKUPDATE_REQUEST )
    352              case MT_ZDO_MGMT_NWK_UPDATE_REQ:
    353                MT_ZdoMgmtNwkUpdateRequest(pBuf);
    354                break;
    355          #endif
    356          
    357          #if defined ( ZDO_NETWORKSTART_REQUEST )
    358              case MT_ZDO_STARTUP_FROM_APP:
    359                MT_ZdoStartupFromApp(pBuf);
   \                     ??MT_ZdoCommandProcessing_19:
   \   0000C4   ........     CALLA   #MT_ZdoStartupFromApp
    360                break;
   \   0000C8   073C         JMP     ??MT_ZdoCommandProcessing_21
    361          #endif
    362          
    363              case MT_ZDO_MSG_CB_REGISTER:
    364                MT_ZdoRegisterForZDOMsg(pBuf);
   \                     ??MT_ZdoCommandProcessing_17:
   \   0000CA   ........     CALLA   #MT_ZdoRegisterForZDOMsg
    365                break;
   \   0000CE   043C         JMP     ??MT_ZdoCommandProcessing_21
    366          
    367              case MT_ZDO_MSG_CB_REMOVE:
    368                MT_ZdoRemoveRegisteredCB(pBuf);
   \                     ??MT_ZdoCommandProcessing_18:
   \   0000D0   ........     CALLA   #MT_ZdoRemoveRegisteredCB
    369                break;
   \   0000D4   013C         JMP     ??MT_ZdoCommandProcessing_21
    370          
    371              default:
    372                status = MT_RPC_ERR_COMMAND_ID;
   \                     ??MT_ZdoCommandProcessing_20:
   \   0000D6   6A43         MOV.B   #0x2, R10
    373                break;
    374            }
    375          
    376            return status;
   \                     ??MT_ZdoCommandProcessing_21:
   \   0000D8   4C4A         MOV.B   R10, R12
   \   0000DA   3A41         POP.W   R10
   \   0000DC   1001         RETA
    377          }
    378          
    379          /***************************************************************************************************
    380           * @fn      MT_ZdoNwkAddrReq
    381           *
    382           * @brief   Handle a nwk address request.
    383           *
    384           * @param   pData  - MT message data
    385           *
    386           * @return  void
    387           ***************************************************************************************************/

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine7:
   \   000000   C14C0400     MOV.B   R12, 0x4(SP)
   \   000004                REQUIRE ??Subroutine7_0
   \   000004                // Fall through to label ??Subroutine7_0

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ??Subroutine7_0:
   \   000000   0F41         MOV.W   SP, R15
   \   000002   2F52         ADD.W   #0x4, R15
   \   000004                REQUIRE ??Subroutine7_1
   \   000004                // Fall through to label ??Subroutine7_1

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ??Subroutine7_1:
   \   000000   5E43         MOV.B   #0x1, R14
   \   000002   4D4A         MOV.B   R10, R13
   \   000004                REQUIRE ??Subroutine21_0
   \   000004                // Fall through to label ??Subroutine21_0

   \                                 In  segment CODE, align 2
   \                     ??Subroutine21_0:
   \   000000   7C406500     MOV.B   #0x65, R12
   \   000004   ........     BRA     #MT_BuildAndSendZToolResponse

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine3:
   \   000000   ........     CALLA   #?Subroutine7
   \                     ??CrossCallReturnLabel_43:
   \   000004   2153         ADD.W   #0x2, SP
   \   000006   3A41         POP.W   R10
   \   000008   1001         RETA

   \                                 In  segment CODE, align 2
    388          void MT_ZdoNWKAddressRequest(uint8 *pBuf)
   \                     MT_ZdoNWKAddressRequest:
    389          {
   \   000000   0A12         PUSH.W  R10
   \   000002   2183         SUB.W   #0x2, SP
   \   000004   0E4C         MOV.W   R12, R14
    390            uint8 cmdId;
    391            uint8 retValue;
    392            uint8 reqType;
    393            uint8 startIndex;
    394            uint8 *pExtAddr;
    395          
    396            /* parse header */
    397            cmdId = pBuf[MT_RPC_POS_CMD1];
   \   000006   5A4C0200     MOV.B   0x2(R12), R10
    398            pBuf += MT_RPC_FRAME_HDR_SZ;
    399          
    400            /* parse parameters */
    401            pExtAddr = pBuf;
   \   00000A   3E500300     ADD.W   #0x3, R14
   \   00000E   0C4E         MOV.W   R14, R12
    402            pBuf += Z_EXTADDR_LEN;
   \   000010   3E52         ADD.W   #0x8, R14
    403          
    404            /* Request type */
    405            reqType = *pBuf++;
   \   000012   7D4E         MOV.B   @R14+, R13
    406          
    407            /* Start index */
    408            startIndex = *pBuf;
    409          
    410            retValue = (uint8)ZDP_NwkAddrReq(pExtAddr, reqType, startIndex, 0);
   \   000014   4F43         MOV.B   #0x0, R15
   \   000016   6E4E         MOV.B   @R14, R14
   \   000018   ........     CALLA   #ZDP_NwkAddrReq
   \   00001C   ....         JMP     ?Subroutine3
    411          
    412            /* Build and send back the response */
    413            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    414          }
    415          
    416          /***************************************************************************************************
    417           * @fn      MT_ZdoIEEEAddrRequest
    418           *
    419           * @brief   Handle a IEEE address request.
    420           *
    421           * @param   pData  - MT message data
    422           *
    423           * @return  void
    424           ***************************************************************************************************/

   \                                 In  segment CODE, align 2, keep-with-next
    425          void MT_ZdoIEEEAddrRequest (uint8 *pBuf)
   \                     MT_ZdoIEEEAddrRequest:
    426          {
   \   000000   0A12         PUSH.W  R10
   \   000002   2183         SUB.W   #0x2, SP
   \   000004   0E4C         MOV.W   R12, R14
    427            uint8 cmdId;
    428            uint8 retValue;
    429            uint16 shortAddr;
    430            uint8 reqType;
    431            uint8 startIndex;
    432          
    433            /* parse header */
    434            cmdId = pBuf[MT_RPC_POS_CMD1];
   \   000006   5A4C0200     MOV.B   0x2(R12), R10
    435            pBuf += MT_RPC_FRAME_HDR_SZ;
   \   00000A   3E500300     ADD.W   #0x3, R14
    436          
    437            /* Dev address */
    438            shortAddr = BUILD_UINT16(pBuf[0], pBuf[1]);
   \   00000E   6C4E         MOV.B   @R14, R12
   \   000010   5F4E0100     MOV.B   0x1(R14), R15
   \   000014                RPT     #0x8
   \   000014   47180F5F     RLAX.W  R15
   \   000018   0C5F         ADD.W   R15, R12
    439            pBuf += 2;
   \   00001A   2E53         ADD.W   #0x2, R14
    440          
    441            /* request type */
    442            reqType = *pBuf++;
   \   00001C   7D4E         MOV.B   @R14+, R13
    443          
    444            /* start index */
    445            startIndex = *pBuf;
    446          
    447            retValue = (uint8)ZDP_IEEEAddrReq(shortAddr, reqType, startIndex, 0);
   \   00001E   6E4E         MOV.B   @R14, R14
   \   000020   ........     CALLA   #ZDP_IEEEAddrReq
   \   000024                REQUIRE ?Subroutine3
   \   000024                // Fall through to label ?Subroutine3
    448          
    449            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    450          }
    451          
    452          /***************************************************************************************************
    453           * @fn      MT_ZdoNodeDescRequest
    454           *
    455           * @brief   Handle a Node Descriptor request.
    456           *
    457           * @param   pData  - MT message data
    458           *
    459           * @return  void
    460           ***************************************************************************************************/

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine15:
   \   000000   5A4C0200     MOV.B   0x2(R12), R10
   \   000004   3C500300     ADD.W   #0x3, R12
   \   000008   1001         RETA

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine16:
   \   000000   5F4C0100     MOV.B   0x1(R12), R15
   \   000004                RPT     #0x8
   \   000004   47180F5F     RLAX.W  R15
   \   000008   1001         RETA

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine8:
   \   000000   ........     CALLA   #?Subroutine15
   \                     ??CrossCallReturnLabel_23:
   \   000004   E1430E00     MOV.B   #0x2, 0xe(SP)
   \   000008   6E4C         MOV.B   @R12, R14
   \   00000A   ........     CALLA   #?Subroutine16
   \                     ??CrossCallReturnLabel_25:
   \   00000E   0E5F         ADD.W   R15, R14
   \   000010   814E0600     MOV.W   R14, 0x6(SP)
   \   000014   2C53         ADD.W   #0x2, R12
   \   000016   1001         RETA

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine0:
   \   000000   ........     CALLA   #?Subroutine10
   \                     ??CrossCallReturnLabel_13:
   \   000004   ........     CALLA   #ZDP_NWKAddrOfInterestReq
   \   000008                REQUIRE ??Subroutine23_0
   \   000008                // Fall through to label ??Subroutine23_0

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ??Subroutine23_0:
   \   000000   ........     CALLA   #?Subroutine7
   \                     ??CrossCallReturnLabel_44:
   \   000004   31500C00     ADD.W   #0xc, SP
   \   000008   3A41         POP.W   R10
   \   00000A   1001         RETA

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine10:
   \   000000   6D4C         MOV.B   @R12, R13
   \   000002   5C4C0100     MOV.B   0x1(R12), R12
   \   000006                RPT     #0x8
   \   000006   47180C5C     RLAX.W  R12
   \   00000A   0D5C         ADD.W   R12, R13
   \   00000C   0C41         MOV.W   SP, R12
   \   00000E   3C500600     ADD.W   #0x6, R12
   \   000012   1001         RETA

   \                                 In  segment CODE, align 2, keep-with-next
    461          void MT_ZdoNodeDescRequest (uint8 *pBuf)
   \                     MT_ZdoNodeDescRequest:
    462          {
   \   000000   0A12         PUSH.W  R10
   \   000002   31800C00     SUB.W   #0xc, SP
    463            uint8 cmdId;
    464            uint8 retValue;
    465            zAddrType_t destAddr;
    466            uint16 shortAddr;
    467          
    468            /* parse header */
    469            cmdId = pBuf[MT_RPC_POS_CMD1];
   \   000006   ........     CALLA   #?Subroutine8
    470            pBuf += MT_RPC_FRAME_HDR_SZ;
    471          
    472            /* Destination address */
    473            destAddr.addrMode = Addr16Bit;
    474            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    475            pBuf += 2;
    476          
    477            /* Network address of interest */
    478            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    479            pBuf += 2;
    480          
    481            retValue = (uint8)ZDP_NodeDescReq( &destAddr, shortAddr, 0);
   \                     ??CrossCallReturnLabel_9:
   \   00000A   6E43         MOV.B   #0x2, R14
   \   00000C   ....         JMP     ?Subroutine0
    482          
    483            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    484          }
    485          
    486          /***************************************************************************************************
    487           * @fn      MT_ZdoPowerDescRequest
    488           *
    489           * @brief   Handle a Power Descriptor request.
    490           *
    491           * @param   pData  - MT message data
    492           *
    493           * @return  void
    494           ***************************************************************************************************/

   \                                 In  segment CODE, align 2, keep-with-next
    495          void MT_ZdoPowerDescRequest(uint8 *pBuf)
   \                     MT_ZdoPowerDescRequest:
    496          {
   \   000000   0A12         PUSH.W  R10
   \   000002   31800C00     SUB.W   #0xc, SP
    497            uint8 cmdId;
    498            uint8 retValue;
    499            zAddrType_t destAddr;
    500            uint16 shortAddr;
    501          
    502            /* parse header */
    503            cmdId = pBuf[MT_RPC_POS_CMD1];
   \   000006   ........     CALLA   #?Subroutine8
    504            pBuf += MT_RPC_FRAME_HDR_SZ;
    505          
    506            /* Dev address */
    507            destAddr.addrMode = Addr16Bit;
    508            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    509            pBuf += 2;
    510          
    511            /* Network address of interest */
    512            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    513            pBuf += 2;
    514          
    515            retValue = (uint8)ZDP_PowerDescReq( &destAddr, shortAddr, 0);
   \                     ??CrossCallReturnLabel_8:
   \   00000A   7E400300     MOV.B   #0x3, R14
   \   00000E                REQUIRE ?Subroutine0
   \   00000E                // Fall through to label ?Subroutine0
    516          
    517            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    518          }
    519          
    520          /***************************************************************************************************
    521           * @fn      MT_ZdoSimpleDescRequest
    522           *
    523           * @brief   Handle a Simple Descriptor request.
    524           *
    525           * @param   pBuf  - MT message data
    526           *
    527           * @return  void
    528           ***************************************************************************************************/

   \                                 In  segment CODE, align 2, keep-with-next
    529          void MT_ZdoSimpleDescRequest(uint8 *pBuf)
   \                     MT_ZdoSimpleDescRequest:
    530          {
   \   000000   0A12         PUSH.W  R10
   \   000002   31800C00     SUB.W   #0xc, SP
    531            uint8 cmdId;
    532            uint8 retValue;
    533            uint8 epInt;
    534            zAddrType_t destAddr;
    535            uint16 shortAddr;
    536          
    537            /* parse header */
    538            cmdId = pBuf[MT_RPC_POS_CMD1];
   \   000006   ........     CALLA   #?Subroutine8
    539            pBuf += MT_RPC_FRAME_HDR_SZ;
    540          
    541            /* Dev address */
    542            destAddr.addrMode = Addr16Bit;
    543            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    544            pBuf += 2;
    545          
    546            /* Network address of interest */
    547            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    548            pBuf += 2;
    549          
    550            /* endpoint/interface */
    551            epInt = *pBuf++;
    552          
    553            retValue = (uint8)ZDP_SimpleDescReq( &destAddr, shortAddr, epInt, 0);
   \                     ??CrossCallReturnLabel_7:
   \   00000A   5E4C0200     MOV.B   0x2(R12), R14
   \   00000E   ........     CALLA   #?Subroutine10
   \                     ??CrossCallReturnLabel_12:
   \   000012   ........     CALLA   #ZDP_SimpleDescReq
   \   000016   ....         JMP     ??Subroutine23_0
    554          
    555            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    556          }
    557          
    558          /***************************************************************************************************
    559           * @fn      MT_ZdoActiveEpRequest
    560           *
    561           * @brief   Handle a Active EP request.
    562           *
    563           * @param   pBuf  - MT message data
    564           *
    565           * @return  void
    566           ***************************************************************************************************/

   \                                 In  segment CODE, align 2, keep-with-next
    567          void MT_ZdoActiveEpRequest(uint8 *pBuf)
   \                     MT_ZdoActiveEpRequest:
    568          {
   \   000000   0A12         PUSH.W  R10
   \   000002   31800C00     SUB.W   #0xc, SP
    569            uint8 cmdId;
    570            uint8 retValue;
    571            zAddrType_t destAddr;
    572            uint16 shortAddr;
    573          
    574            /* parse header */
    575            cmdId = pBuf[MT_RPC_POS_CMD1];
   \   000006   ........     CALLA   #?Subroutine8
    576            pBuf += MT_RPC_FRAME_HDR_SZ;
    577          
    578            /* Dev address */
    579            destAddr.addrMode = Addr16Bit;
    580            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    581            pBuf += 2;
    582          
    583            /* Network address of interest */
    584            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    585            pBuf += 2;
    586          
    587            retValue = (uint8)ZDP_ActiveEPReq( &destAddr, shortAddr, 0);
   \                     ??CrossCallReturnLabel_6:
   \   00000A   7E400500     MOV.B   #0x5, R14
   \   00000E   ....         JMP     ?Subroutine0
    588          
    589            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    590          }
    591          
    592          /***************************************************************************************************
    593           * @fn      MT_ZdoMatchDescRequest
    594           *
    595           * @brief   Handle a Match Descriptor request.
    596           *
    597           * @param   pBuf  - MT message data
    598           *
    599           * @return  void
    600           ***************************************************************************************************/

   \                                 In  segment CODE, align 2, keep-with-next
    601          void MT_ZdoMatchDescRequest(uint8 *pBuf)
   \                     MT_ZdoMatchDescRequest:
    602          {
   \   000000   5B15         PUSHM.W #0x6, R11
   \   000002   31804C00     SUB.W   #0x4c, SP
   \   000006   0F4C         MOV.W   R12, R15
    603            uint8 cmdId;
    604            uint8 retValue = 0;
   \   000008   C1430000     MOV.B   #0x0, 0(SP)
    605            uint8 i, numInClusters, numOutClusters;
    606            uint16 profileId;
    607            zAddrType_t destAddr;
    608            uint16 shortAddr;
    609            uint16 inClusters[MTZDO_MAX_MATCH_CLUSTERS], outClusters[MTZDO_MAX_MATCH_CLUSTERS];
    610          
    611            /* parse header */
    612            cmdId = pBuf[MT_RPC_POS_CMD1];
   \   00000C   5A4C0200     MOV.B   0x2(R12), R10
    613            pBuf += MT_RPC_FRAME_HDR_SZ;
   \   000010   3F500300     ADD.W   #0x3, R15
    614          
    615            /* Dev address */
    616            destAddr.addrMode = Addr16Bit;
   \   000014   E1430A00     MOV.B   #0x2, 0xa(SP)
    617            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   \   000018   6E4F         MOV.B   @R15, R14
   \   00001A   ........     CALLA   #?Subroutine14
   \                     ??CrossCallReturnLabel_16:
   \   00001E   0E5B         ADD.W   R11, R14
   \   000020   814E0200     MOV.W   R14, 0x2(SP)
    618            pBuf += 2;
   \   000024   2F53         ADD.W   #0x2, R15
    619          
    620            /* Network address of interest */
    621            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   \   000026   6D4F         MOV.B   @R15, R13
   \   000028   ........     CALLA   #?Subroutine14
   \                     ??CrossCallReturnLabel_17:
   \   00002C   0D5B         ADD.W   R11, R13
    622            pBuf += 2;
   \   00002E   2F53         ADD.W   #0x2, R15
    623          
    624            /* Profile ID */
    625            profileId = BUILD_UINT16( pBuf[0], pBuf[1] );
   \   000030   6C4F         MOV.B   @R15, R12
   \   000032   ........     CALLA   #?Subroutine14
   \                     ??CrossCallReturnLabel_18:
   \   000036   0C5B         ADD.W   R11, R12
    626            pBuf += 2;
   \   000038   2F53         ADD.W   #0x2, R15
    627          
    628            /* NumInClusters */
    629            numInClusters = *pBuf++;
   \   00003A   7B4F         MOV.B   @R15+, R11
    630            if ( numInClusters <= MTZDO_MAX_MATCH_CLUSTERS )
   \   00003C   7B901100     CMP.B   #0x11, R11
   \   000040   0B2C         JC      ??MT_ZdoMatchDescRequest_2
    631            {
    632              /* IN clusters */
    633              for ( i = 0; i < numInClusters; i++ )
   \   000042   4E43         MOV.B   #0x0, R14
   \                     ??MT_ZdoMatchDescRequest_0:
   \   000044   4E9B         CMP.B   R11, R14
   \   000046   0B2C         JC      ??MT_ZdoMatchDescRequest_3
    634              {
    635                inClusters[i] = BUILD_UINT16( pBuf[0], pBuf[1]);
   \   000048   ........     CALLA   #?Subroutine12
   \                     ??CrossCallReturnLabel_35:
   \   00004C   0851         ADD.W   SP, R8
   \   00004E   88492C00     MOV.W   R9, 0x2c(R8)
    636                pBuf += 2;
   \   000052   2F53         ADD.W   #0x2, R15
    637              }
   \   000054   5E53         ADD.B   #0x1, R14
   \   000056   F63F         JMP     ??MT_ZdoMatchDescRequest_0
    638            }
    639            else
    640            {
    641              retValue = ZDP_INVALID_REQTYPE;
   \                     ??MT_ZdoMatchDescRequest_2:
   \   000058   F14080000000 MOV.B   #0x80, 0(SP)
    642            }
    643          
    644            /* NumOutClusters */
    645            numOutClusters = *pBuf++;
   \                     ??MT_ZdoMatchDescRequest_3:
   \   00005E   764F         MOV.B   @R15+, R6
    646            if ( numOutClusters <= MTZDO_MAX_MATCH_CLUSTERS )
   \   000060   76901100     CMP.B   #0x11, R6
   \   000064   0B2C         JC      ??MT_ZdoMatchDescRequest_4
    647            {
    648              /* OUT Clusters */
    649              for ( i = 0; i < numOutClusters; i++ )
   \   000066   4E43         MOV.B   #0x0, R14
   \                     ??MT_ZdoMatchDescRequest_1:
   \   000068   4E96         CMP.B   R6, R14
   \   00006A   0C2C         JC      ??MT_ZdoMatchDescRequest_5
    650              {
    651                outClusters[i] = BUILD_UINT16( pBuf[0], pBuf[1]);
   \   00006C   ........     CALLA   #?Subroutine12
   \                     ??CrossCallReturnLabel_36:
   \   000070   0851         ADD.W   SP, R8
   \   000072   88490C00     MOV.W   R9, 0xc(R8)
    652                pBuf += 2;
   \   000076   2F53         ADD.W   #0x2, R15
    653              }
   \   000078   5E53         ADD.B   #0x1, R14
   \   00007A   F63F         JMP     ??MT_ZdoMatchDescRequest_1
    654            }
    655            else
    656            {
    657              retValue = ZDP_INVALID_REQTYPE;
   \                     ??MT_ZdoMatchDescRequest_4:
   \   00007C   F14080000000 MOV.B   #0x80, 0(SP)
   \   000082   163C         JMP     ??MT_ZdoMatchDescRequest_6
    658            }
    659          
    660            if ( retValue == 0 )
   \                     ??MT_ZdoMatchDescRequest_5:
   \   000084   C1930000     CMP.B   #0x0, 0(SP)
   \   000088   1320         JNE     ??MT_ZdoMatchDescRequest_6
    661            {
    662              retValue = (uint8)ZDP_MatchDescReq( &destAddr, shortAddr, profileId, numInClusters,
    663                                                 inClusters, numOutClusters, outClusters, 0);
   \   00008A   4312         PUSH.B  #0x0
   \   00008C   0F41         MOV.W   SP, R15
   \   00008E   3F500E00     ADD.W   #0xe, R15
   \   000092   0F12         PUSH.W  R15
   \   000094   4612         PUSH.B  R6
   \   000096   3F502000     ADD.W   #0x20, R15
   \   00009A   0F12         PUSH.W  R15
   \   00009C   4F4B         MOV.B   R11, R15
   \   00009E   0E4C         MOV.W   R12, R14
   \   0000A0   0C41         MOV.W   SP, R12
   \   0000A2   3C500A00     ADD.W   #0xa, R12
   \   0000A6   ........     CALLA   #ZDP_MatchDescReq
   \   0000AA   C14C0800     MOV.B   R12, 0x8(SP)
   \   0000AE   3152         ADD.W   #0x8, SP
    664            }
    665          
    666            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   \                     ??MT_ZdoMatchDescRequest_6:
   \   0000B0   ........     CALLA   #??Subroutine7_0
    667          }
   \                     ??CrossCallReturnLabel_40:
   \   0000B4   31504C00     ADD.W   #0x4c, SP
   \   0000B8   5617         POPM.W  #0x6, R11
   \   0000BA   1001         RETA

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine14:
   \   000000   5B4F0100     MOV.B   0x1(R15), R11
   \   000004                RPT     #0x8
   \   000004   47180B5B     RLAX.W  R11
   \   000008   1001         RETA

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine12:
   \   000000   694F         MOV.B   @R15, R9
   \   000002   584F0100     MOV.B   0x1(R15), R8
   \   000006                REQUIRE ??Subroutine22_0
   \   000006                // Fall through to label ??Subroutine22_0

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ??Subroutine22_0:
   \   000000                RPT     #0x8
   \   000000   47180858     RLAX.W  R8
   \   000004   0958         ADD.W   R8, R9
   \   000006   484E         MOV.B   R14, R8
   \   000008   0858         RLA.W   R8
   \   00000A   1001         RETA
    668          
    669          /***************************************************************************************************
    670           * @fn      MT_ZdoComplexDescRequest
    671           *
    672           * @brief   Handle a Complex Descriptor request.
    673           *
    674           * @param   pBuf  - MT message data
    675           *
    676           * @return  void
    677           ***************************************************************************************************/

   \                                 In  segment CODE, align 2, keep-with-next
    678          void MT_ZdoComplexDescRequest(uint8 *pBuf)
   \                     MT_ZdoComplexDescRequest:
    679          {
   \   000000   0A12         PUSH.W  R10
   \   000002   31800C00     SUB.W   #0xc, SP
    680            uint8 cmdId;
    681            uint8 retValue;
    682            zAddrType_t destAddr;
    683            uint16 shortAddr;
    684          
    685            /* parse header */
    686            cmdId = pBuf[MT_RPC_POS_CMD1];
   \   000006   ........     CALLA   #?Subroutine8
    687            pBuf += MT_RPC_FRAME_HDR_SZ;
    688          
    689            /* Dev address */
    690            destAddr.addrMode = Addr16Bit;
    691            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    692            pBuf += 2;
    693          
    694            /* Network address of interest */
    695            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    696            pBuf += 2;
    697          
    698            retValue = (uint8)ZDP_ComplexDescReq( &destAddr, shortAddr, 0);
   \                     ??CrossCallReturnLabel_5:
   \   00000A   7E401000     MOV.B   #0x10, R14
   \   00000E   ....         JMP     ?Subroutine0
    699          
    700            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    701          }
    702          
    703          /***************************************************************************************************
    704           * @fn      MT_ZdoUserDescRequest
    705           *
    706           * @brief   Handle a User Descriptor request.
    707           *
    708           * @param   pBuf  - MT message data
    709           *
    710           * @return  void
    711           ***************************************************************************************************/

   \                                 In  segment CODE, align 2, keep-with-next
    712          void MT_ZdoUserDescRequest(uint8 *pBuf)
   \                     MT_ZdoUserDescRequest:
    713          {
   \   000000   0A12         PUSH.W  R10
   \   000002   31800C00     SUB.W   #0xc, SP
    714            uint8 cmdId;
    715            uint8 retValue;
    716            zAddrType_t destAddr;
    717            uint16 shortAddr;
    718          
    719            /* parse header */
    720            cmdId = pBuf[MT_RPC_POS_CMD1];
   \   000006   ........     CALLA   #?Subroutine8
    721            pBuf += MT_RPC_FRAME_HDR_SZ;
    722          
    723            /* Dev address */
    724            destAddr.addrMode = Addr16Bit;
    725            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1]);
    726            pBuf += 2;
    727          
    728            /* Network address of interest */
    729            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1]);
    730            pBuf += 2;
    731          
    732            retValue = (uint8)ZDP_UserDescReq( &destAddr, shortAddr, 0);
   \                     ??CrossCallReturnLabel_4:
   \   00000A   7E401100     MOV.B   #0x11, R14
   \   00000E   ....         JMP     ?Subroutine0
    733          
    734            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    735          }
    736          
    737          /***************************************************************************************************
    738           * @fn      MT_ZdoEndDevAnnce
    739           *
    740           * @brief   Handle a End Device Announce Descriptor request.
    741           *
    742           * @param   pBuf  - MT message data
    743           *
    744           * @return  void
    745           ***************************************************************************************************/

   \                                 In  segment CODE, align 2, keep-with-next
    746          void MT_ZdoEndDevAnnce(uint8 *pBuf)
   \                     MT_ZdoEndDevAnnce:
    747          {
   \   000000   0A12         PUSH.W  R10
   \   000002   2183         SUB.W   #0x2, SP
   \   000004   0D4C         MOV.W   R12, R13
    748            uint8 cmdId;
    749            uint8 retValue;
    750            uint16 shortAddr;
    751            uint8 *pIEEEAddr;
    752          
    753            /* parse header */
    754            cmdId = pBuf[MT_RPC_POS_CMD1];
   \   000006   5A4C0200     MOV.B   0x2(R12), R10
    755            pBuf += MT_RPC_FRAME_HDR_SZ;
   \   00000A   3D500300     ADD.W   #0x3, R13
    756          
    757            /* network address */
    758            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   \   00000E   6C4D         MOV.B   @R13, R12
   \   000010   5F4D0100     MOV.B   0x1(R13), R15
   \   000014                RPT     #0x8
   \   000014   47180F5F     RLAX.W  R15
   \   000018   0C5F         ADD.W   R15, R12
    759            pBuf += 2;
   \   00001A   2D53         ADD.W   #0x2, R13
    760          
    761            /* extended address */
    762            pIEEEAddr = pBuf;
    763            pBuf += Z_EXTADDR_LEN;
    764          
    765            retValue = (uint8)ZDP_DeviceAnnce( shortAddr, pIEEEAddr, *pBuf, 0);
   \   00001C   5E4D0800     MOV.B   0x8(R13), R14
   \   000020   ........     CALLA   #ZDP_DeviceAnnce
   \   000024   ....         JMP     ?Subroutine3
    766          
    767            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    768          }
    769          
    770          /***************************************************************************************************
    771           * @fn      MT_ZdoUserDescSet
    772           *
    773           * @brief   Handle a User Descriptor Set.
    774           *
    775           * @param   pBuf  - MT message data
    776           *
    777           * @return  void
    778           ***************************************************************************************************/

   \                                 In  segment CODE, align 2, keep-with-next
    779          void MT_ZdoUserDescSet(uint8 *pBuf)
   \                     MT_ZdoUserDescSet:
    780          {
   \   000000   1B15         PUSHM.W #0x2, R11
   \   000002   31801C00     SUB.W   #0x1c, SP
    781            uint8 cmdId;
    782            uint8 retValue;
    783            zAddrType_t destAddr;
    784            uint16 shortAddr;
    785            UserDescriptorFormat_t userDesc;
    786          
    787            /* parse header */
    788            cmdId = pBuf[MT_RPC_POS_CMD1];
   \   000006   ........     CALLA   #?Subroutine15
    789            pBuf += MT_RPC_FRAME_HDR_SZ;
    790          
    791            /* Dev address */
    792            destAddr.addrMode = Addr16Bit;
   \                     ??CrossCallReturnLabel_22:
   \   00000A   E1430800     MOV.B   #0x2, 0x8(SP)
    793            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   \   00000E   ........     CALLA   #?Subroutine13
   \                     ??CrossCallReturnLabel_14:
   \   000012   814B0000     MOV.W   R11, 0(SP)
    794            pBuf += 2;
   \   000016   2C53         ADD.W   #0x2, R12
    795          
    796            /* Network address of interest */
    797            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   \   000018   ........     CALLA   #?Subroutine13
    798            pBuf += 2;
   \                     ??CrossCallReturnLabel_15:
   \   00001C   2C53         ADD.W   #0x2, R12
    799          
    800            /* User descriptor */
    801            userDesc.len = *pBuf++;
   \   00001E   F14C0B00     MOV.B   @R12+, 0xb(SP)
    802            osal_memcpy( userDesc.desc, pBuf, userDesc.len );
   \   000022   5E410B00     MOV.B   0xb(SP), R14
   \   000026   0D4C         MOV.W   R12, R13
   \   000028   0C41         MOV.W   SP, R12
   \   00002A   3C500C00     ADD.W   #0xc, R12
   \   00002E   ........     CALLA   #osal_memcpy
    803            pBuf += 16;
    804          
    805            retValue = (uint8)ZDP_UserDescSet( &destAddr, shortAddr, &userDesc, 0);
   \   000032   4F43         MOV.B   #0x0, R15
   \   000034   0E41         MOV.W   SP, R14
   \   000036   3E500B00     ADD.W   #0xb, R14
   \   00003A   0D4B         MOV.W   R11, R13
   \   00003C   0C41         MOV.W   SP, R12
   \   00003E   0C53         ADD.W   #0x0, R12
   \   000040   ........     CALLA   #ZDP_UserDescSet
   \   000044   C14C0A00     MOV.B   R12, 0xa(SP)
    806          
    807            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   \   000048   0F41         MOV.W   SP, R15
   \   00004A   3F500A00     ADD.W   #0xa, R15
   \   00004E   ........     CALLA   #??Subroutine7_1
    808          }
   \                     ??CrossCallReturnLabel_38:
   \   000052   31501C00     ADD.W   #0x1c, SP
   \   000056   1A17         POPM.W  #0x2, R11
   \   000058   1001         RETA

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine13:
   \   000000   6B4C         MOV.B   @R12, R11
   \   000002   ........     CALLA   #?Subroutine16
   \                     ??CrossCallReturnLabel_26:
   \   000006   0B5F         ADD.W   R15, R11
   \   000008   1001         RETA
    809          
    810          /***************************************************************************************************
    811           * @fn      MT_ZdoServiceDiscRequest
    812           *
    813           * @brief   Handle a Server Discovery request.
    814           *
    815           * @param   pBuf  - MT message data
    816           *
    817           * @return  void
    818           ***************************************************************************************************/

   \                                 In  segment CODE, align 2, keep-with-next
    819          void MT_ZdoServiceDiscRequest(uint8 *pBuf)
   \                     MT_ZdoServiceDiscRequest:
    820          {
   \   000000   0A12         PUSH.W  R10
   \   000002   2183         SUB.W   #0x2, SP
    821            uint8 cmdId;
    822            uint8 retValue;
    823            uint16 serviceMask;
    824          
    825            /* parse header */
    826            cmdId = pBuf[MT_RPC_POS_CMD1];
   \   000004   ........     CALLA   #?Subroutine15
    827            pBuf += MT_RPC_FRAME_HDR_SZ;
    828          
    829            /* Service Mask */
    830            serviceMask = BUILD_UINT16( pBuf[0], pBuf[1]);
    831            pBuf += 2;
    832          
    833            retValue = (uint8)ZDP_ServerDiscReq( serviceMask, 0);
   \                     ??CrossCallReturnLabel_21:
   \   000008   4D43         MOV.B   #0x0, R13
   \   00000A   6F4C         MOV.B   @R12, R15
   \   00000C   5E4C0100     MOV.B   0x1(R12), R14
   \   000010                RPT     #0x8
   \   000010   47180E5E     RLAX.W  R14
   \   000014   0F5E         ADD.W   R14, R15
   \   000016   0C4F         MOV.W   R15, R12
   \   000018   ........     CALLA   #ZDP_ServerDiscReq
   \   00001C   ....         JMP     ?Subroutine3
    834          
    835            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    836          }
    837          
    838          /***************************************************************************************************
    839           * @fn      MT_ZdoEndDevBindRequest
    840           *
    841           * @brief   Handle a End Device Bind request.
    842           *
    843           * @param   pBuf  - MT message data
    844           *
    845           * @return  void
    846           ***************************************************************************************************/

   \                                 In  segment CODE, align 2
    847          void MT_ZdoEndDevBindRequest(uint8 *pBuf)
   \                     MT_ZdoEndDevBindRequest:
    848          {
   \   000000   5B15         PUSHM.W #0x6, R11
   \   000002   31804800     SUB.W   #0x48, SP
   \   000006   0B4C         MOV.W   R12, R11
    849            uint8 cmdId;
    850            uint8 retValue = 0;
   \   000008   C1430000     MOV.B   #0x0, 0(SP)
    851            uint8 i, epInt, numInClusters, numOutClusters;
    852            zAddrType_t destAddr;
    853            uint16 shortAddr;
    854            uint16 profileID, inClusters[MTZDO_MAX_ED_BIND_CLUSTERS], outClusters[MTZDO_MAX_ED_BIND_CLUSTERS];
    855          
    856            /* parse header */
    857            cmdId = pBuf[MT_RPC_POS_CMD1];
   \   00000C   5A4C0200     MOV.B   0x2(R12), R10
    858            pBuf += MT_RPC_FRAME_HDR_SZ;
   \   000010   3B500300     ADD.W   #0x3, R11
    859          
    860            /* Dev address */
    861            destAddr.addrMode = Addr16Bit;
   \   000014   E1430A00     MOV.B   #0x2, 0xa(SP)
    862            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   \   000018   6E4B         MOV.B   @R11, R14
   \   00001A   5F4B0100     MOV.B   0x1(R11), R15
   \   00001E                RPT     #0x8
   \   00001E   47180F5F     RLAX.W  R15
   \   000022   0E5F         ADD.W   R15, R14
   \   000024   814E0200     MOV.W   R14, 0x2(SP)
    863            pBuf += 2;
   \   000028   2B53         ADD.W   #0x2, R11
    864          
    865            /* Local coordinator of the binding */
    866            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   \   00002A   6D4B         MOV.B   @R11, R13
   \   00002C   5F4B0100     MOV.B   0x1(R11), R15
   \   000030                RPT     #0x8
   \   000030   47180F5F     RLAX.W  R15
   \   000034   0D5F         ADD.W   R15, R13
    867            pBuf += 2;
    868          
    869            /* For now, skip past the extended address */
    870            pBuf += Z_EXTADDR_LEN;
   \   000036   3B500A00     ADD.W   #0xa, R11
    871          
    872            /* Endpoint */
    873            epInt = *pBuf++;
   \   00003A   7C4B         MOV.B   @R11+, R12
    874          
    875            /* Profile ID */
    876            profileID = BUILD_UINT16( pBuf[0], pBuf[1] );
   \   00003C   6F4B         MOV.B   @R11, R15
   \   00003E   5E4B0100     MOV.B   0x1(R11), R14
   \   000042                RPT     #0x8
   \   000042   47180E5E     RLAX.W  R14
   \   000046   0F5E         ADD.W   R14, R15
    877            pBuf += 2;
   \   000048   2B53         ADD.W   #0x2, R11
    878          
    879            /* NumInClusters */
    880            numInClusters = *pBuf++;
   \   00004A   764B         MOV.B   @R11+, R6
    881            if ( numInClusters <= MTZDO_MAX_ED_BIND_CLUSTERS )
   \   00004C   76901000     CMP.B   #0x10, R6
   \   000050   102C         JC      ??MT_ZdoEndDevBindRequest_2
    882            {
    883              for ( i = 0; i < numInClusters; i++ )
   \                     ??MT_ZdoEndDevBindRequest_0:
   \   000052   4E96         CMP.B   R6, R14
   \   000054   112C         JC      ??MT_ZdoEndDevBindRequest_3
    884              {
    885                inClusters[i] = BUILD_UINT16(pBuf[0], pBuf[1]);
   \   000056   694B         MOV.B   @R11, R9
   \   000058   584B0100     MOV.B   0x1(R11), R8
   \   00005C                RPT     #0x8
   \   00005C   47180858     RLAX.W  R8
   \   000060   0958         ADD.W   R8, R9
   \   000062   474E         MOV.B   R14, R7
   \   000064   0757         RLA.W   R7
   \   000066   0751         ADD.W   SP, R7
   \   000068   87492A00     MOV.W   R9, 0x2a(R7)
    886                pBuf += 2;
   \   00006C   2B53         ADD.W   #0x2, R11
    887              }
   \   00006E   5E53         ADD.B   #0x1, R14
   \   000070   F03F         JMP     ??MT_ZdoEndDevBindRequest_0
    888            }
    889            else
    890            {
    891              retValue = ZDP_INVALID_REQTYPE;
   \                     ??MT_ZdoEndDevBindRequest_2:
   \   000072   F14080000000 MOV.B   #0x80, 0(SP)
    892            }
    893          
    894            /* NumOutClusters */
    895            numOutClusters = *pBuf++;
   \                     ??MT_ZdoEndDevBindRequest_3:
   \   000078   774B         MOV.B   @R11+, R7
    896            if ( numOutClusters <= MTZDO_MAX_ED_BIND_CLUSTERS )
   \   00007A   77901000     CMP.B   #0x10, R7
   \   00007E   0E2C         JC      ??MT_ZdoEndDevBindRequest_4
    897            {
    898              for ( i = 0; i < numOutClusters; i++ )
   \   000080   4E43         MOV.B   #0x0, R14
   \                     ??MT_ZdoEndDevBindRequest_1:
   \   000082   4E97         CMP.B   R7, R14
   \   000084   0F2C         JC      ??MT_ZdoEndDevBindRequest_5
    899              {
    900                outClusters[i] = BUILD_UINT16(pBuf[0], pBuf[1]);
   \   000086   694B         MOV.B   @R11, R9
   \   000088   584B0100     MOV.B   0x1(R11), R8
   \   00008C   ........     CALLA   #??Subroutine22_0
   \                     ??CrossCallReturnLabel_34:
   \   000090   0851         ADD.W   SP, R8
   \   000092   88490C00     MOV.W   R9, 0xc(R8)
    901                pBuf += 2;
   \   000096   2B53         ADD.W   #0x2, R11
    902              }
   \   000098   5E53         ADD.B   #0x1, R14
   \   00009A   F33F         JMP     ??MT_ZdoEndDevBindRequest_1
    903            }
    904            else
    905            {
    906              retValue = ZDP_INVALID_REQTYPE;
   \                     ??MT_ZdoEndDevBindRequest_4:
   \   00009C   F14080000000 MOV.B   #0x80, 0(SP)
   \   0000A2   173C         JMP     ??MT_ZdoEndDevBindRequest_6
    907            }
    908          
    909            if ( retValue == 0 )
   \                     ??MT_ZdoEndDevBindRequest_5:
   \   0000A4   C1930000     CMP.B   #0x0, 0(SP)
   \   0000A8   1420         JNE     ??MT_ZdoEndDevBindRequest_6
    910            {
    911              retValue = (uint8)ZDP_EndDeviceBindReq( &destAddr, shortAddr, epInt, profileID,
    912                                                    numInClusters, inClusters, numOutClusters, outClusters, 0);
   \   0000AA   4312         PUSH.B  #0x0
   \   0000AC   0B41         MOV.W   SP, R11
   \   0000AE   3B500E00     ADD.W   #0xe, R11
   \   0000B2   0B12         PUSH.W  R11
   \   0000B4   4712         PUSH.B  R7
   \   0000B6   3B501E00     ADD.W   #0x1e, R11
   \   0000BA   0B12         PUSH.W  R11
   \   0000BC   4612         PUSH.B  R6
   \   0000BE   4E4C         MOV.B   R12, R14
   \   0000C0   0C41         MOV.W   SP, R12
   \   0000C2   3C500C00     ADD.W   #0xc, R12
   \   0000C6   ........     CALLA   #ZDP_EndDeviceBindReq
   \   0000CA   C14C0A00     MOV.B   R12, 0xa(SP)
   \   0000CE   31500A00     ADD.W   #0xa, SP
    913            }
    914          
    915            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   \                     ??MT_ZdoEndDevBindRequest_6:
   \   0000D2   ........     CALLA   #??Subroutine7_0
    916          }
   \                     ??CrossCallReturnLabel_41:
   \   0000D6   31504800     ADD.W   #0x48, SP
   \   0000DA   5617         POPM.W  #0x6, R11
   \   0000DC   1001         RETA
    917          
    918          /***************************************************************************************************
    919           * @fn      MT_ZdoBindRequest
    920           *
    921           * @brief   Handle a Bind request.
    922           *
    923           * @param   pBuf  - MT message data
    924           *
    925           * @return  void
    926           ***************************************************************************************************/

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine2:
   \   000000   ........     CALLA   #ZDP_BindUnbindReq
   \   000004   C14C0800     MOV.B   R12, 0x8(SP)
   \   000008   0F41         MOV.W   SP, R15
   \   00000A   3F52         ADD.W   #0x8, R15
   \   00000C   5E43         MOV.B   #0x1, R14
   \   00000E   4D4B         MOV.B   R11, R13
   \   000010   ........     CALLA   #??Subroutine21_0
   \                     ??CrossCallReturnLabel_37:
   \   000014   31501E00     ADD.W   #0x1e, SP
   \   000018   5617         POPM.W  #0x6, R11
   \   00001A   1001         RETA

   \                                 In  segment CODE, align 2
    927          void MT_ZdoBindRequest(uint8 *pBuf)
   \                     MT_ZdoBindRequest:
    928          {
   \   000000   5B15         PUSHM.W #0x6, R11
   \   000002   31801600     SUB.W   #0x16, SP
   \   000006   ........     CALLA   #?Subroutine9
    929            uint8 cmdId;
    930            uint8 retValue;
    931            zAddrType_t destAddr, devAddr;
    932            uint8 *pSrcAddr, *ptr;
    933            uint8 srcEPInt, dstEPInt;
    934            uint16 clusterID;
    935          
    936            /* parse header */
    937            cmdId = pBuf[MT_RPC_POS_CMD1];
    938            pBuf += MT_RPC_FRAME_HDR_SZ;
    939          
    940            /* Dev address */
    941            destAddr.addrMode = Addr16Bit;
    942            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    943            pBuf += 2;
    944          
    945            /* SrcAddress */
    946            pSrcAddr = pBuf;
    947            pBuf += Z_EXTADDR_LEN;
    948          
    949            /* SrcEPInt */
    950            srcEPInt = *pBuf++;
    951          
    952            /* ClusterID */
    953            clusterID = BUILD_UINT16( pBuf[0], pBuf[1]);
    954            pBuf += 2;
    955          
    956            /* Destination Address mode */
    957            devAddr.addrMode = *pBuf++;
    958          
    959            /* Destination Address */
    960            if ( devAddr.addrMode == Addr64Bit )
    961            {
    962              ptr = pBuf;
    963              osal_cpyExtAddr( devAddr.addr.extAddr, ptr );
    964            }
    965            else
    966            {
    967              devAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
    968            }
    969            /* The short address occupies LSB two bytes */
    970            pBuf += Z_EXTADDR_LEN;
    971          
    972            /* DstEPInt */
    973            dstEPInt = *pBuf;
    974          
    975            retValue = (uint8)ZDP_BindReq( &destAddr, pSrcAddr, srcEPInt, clusterID, &devAddr, dstEPInt, 0);
   \                     ??CrossCallReturnLabel_11:
   \   00000A   4312         PUSH.B  #0x0
   \   00000C   56120800     PUSH.B  0x8(R6)
   \   000010   0F41         MOV.W   SP, R15
   \   000012   3F500600     ADD.W   #0x6, R15
   \   000016   0F12         PUSH.W  R15
   \   000018   0912         PUSH.W  R9
   \   00001A   4F48         MOV.B   R8, R15
   \   00001C   0E4A         MOV.W   R10, R14
   \   00001E   0D41         MOV.W   SP, R13
   \   000020   3D501400     ADD.W   #0x14, R13
   \   000024   3C402100     MOV.W   #0x21, R12
   \   000028   ....         JMP     ?Subroutine2
    976          
    977            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
    978          }

   \                                 In  segment CODE, align 2
   \                     ?Subroutine9:
   \   000000   064C         MOV.W   R12, R6
   \   000002   5B4C0200     MOV.B   0x2(R12), R11
   \   000006   36500300     ADD.W   #0x3, R6
   \   00000A   E1431800     MOV.B   #0x2, 0x18(SP)
   \   00000E   ........     CALLA   #?Subroutine17
   \                     ??CrossCallReturnLabel_27:
   \   000012   814E1000     MOV.W   R14, 0x10(SP)
   \   000016   2653         ADD.W   #0x2, R6
   \   000018   0A46         MOV.W   R6, R10
   \   00001A   3652         ADD.W   #0x8, R6
   \   00001C   7846         MOV.B   @R6+, R8
   \   00001E   6946         MOV.B   @R6, R9
   \   000020   5F460100     MOV.B   0x1(R6), R15
   \   000024                RPT     #0x8
   \   000024   47180F5F     RLAX.W  R15
   \   000028   095F         ADD.W   R15, R9
   \   00002A   2653         ADD.W   #0x2, R6
   \   00002C   F1460E00     MOV.B   @R6+, 0xe(SP)
   \   000030   F19003000E00 CMP.B   #0x3, 0xe(SP)
   \   000036   0620         JNE     ??MT_ZdoUnbindRequest_0
   \   000038   0D46         MOV.W   R6, R13
   \   00003A   0C41         MOV.W   SP, R12
   \   00003C   3C500600     ADD.W   #0x6, R12
   \   000040   ........     BRA     #sAddrExtCpy
   \                     ??MT_ZdoUnbindRequest_0:
   \   000044   ........     CALLA   #?Subroutine17
   \                     ??CrossCallReturnLabel_28:
   \   000048   814E0600     MOV.W   R14, 0x6(SP)
   \   00004C   1001         RETA

   \                                 In  segment CODE, align 2
   \                     ?Subroutine17:
   \   000000   6E46         MOV.B   @R6, R14
   \   000002   5F460100     MOV.B   0x1(R6), R15
   \   000006                RPT     #0x8
   \   000006   47180F5F     RLAX.W  R15
   \   00000A   0E5F         ADD.W   R15, R14
   \   00000C   1001         RETA
    979          
    980          /***************************************************************************************************
    981           * @fn      MT_ZdoUnbindRequest
    982           *
    983           * @brief   Handle a Unbind request.
    984           *
    985           * @param   pBuf  - MT message data
    986           *
    987           * @return  void
    988           ***************************************************************************************************/

   \                                 In  segment CODE, align 2, keep-with-next
    989          void MT_ZdoUnbindRequest(uint8 *pBuf)
   \                     MT_ZdoUnbindRequest:
    990          {
   \   000000   5B15         PUSHM.W #0x6, R11
   \   000002   31801600     SUB.W   #0x16, SP
   \   000006   ........     CALLA   #?Subroutine9
    991            uint8 cmdId;
    992            uint8 retValue;
    993            zAddrType_t destAddr, devAddr;
    994            uint8 *pSrcAddr, *ptr;
    995            uint8 srcEPInt, dstEPInt;
    996            uint16 clusterID;
    997          
    998            /* parse header */
    999            cmdId = pBuf[MT_RPC_POS_CMD1];
   1000            pBuf += MT_RPC_FRAME_HDR_SZ;
   1001          
   1002            /* dev address */
   1003            destAddr.addrMode = Addr16Bit;
   1004            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1005            pBuf += 2;
   1006          
   1007            /* SrcAddress */
   1008            pSrcAddr = pBuf;
   1009            pBuf += Z_EXTADDR_LEN;
   1010          
   1011            /* SrcEPInt */
   1012            srcEPInt = *pBuf++;
   1013          
   1014            /* ClusterID */
   1015            clusterID = BUILD_UINT16( pBuf[0], pBuf[1]);
   1016            pBuf += 2;
   1017          
   1018            /* Destination Address mode */
   1019            devAddr.addrMode = *pBuf++;
   1020          
   1021            /* Destination Address */
   1022            if ( devAddr.addrMode == Addr64Bit )
   1023            {
   1024              ptr = pBuf;
   1025              osal_cpyExtAddr( devAddr.addr.extAddr, ptr );
   1026            }
   1027            else
   1028            {
   1029              devAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1030            }
   1031            /* The short address occupies LSB two bytes */
   1032            pBuf += Z_EXTADDR_LEN;
   1033          
   1034            /* dstEPInt */
   1035            dstEPInt = *pBuf;
   1036          
   1037            retValue = (uint8)ZDP_UnbindReq( &destAddr, pSrcAddr, srcEPInt, clusterID, &devAddr, dstEPInt, 0);
   \                     ??CrossCallReturnLabel_10:
   \   00000A   4312         PUSH.B  #0x0
   \   00000C   56120800     PUSH.B  0x8(R6)
   \   000010   0F41         MOV.W   SP, R15
   \   000012   3F500600     ADD.W   #0x6, R15
   \   000016   0F12         PUSH.W  R15
   \   000018   0912         PUSH.W  R9
   \   00001A   4F48         MOV.B   R8, R15
   \   00001C   0E4A         MOV.W   R10, R14
   \   00001E   0D41         MOV.W   SP, R13
   \   000020   3D501400     ADD.W   #0x14, R13
   \   000024   3C402200     MOV.W   #0x22, R12
   \   000028                REQUIRE ?Subroutine2
   \   000028                // Fall through to label ?Subroutine2
   1038          
   1039            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1040          }
   1041          
   1042          #if defined (MT_SYS_KEY_MANAGEMENT)
   1043          /***************************************************************************************************
   1044           * @fn      MT_ZdoSetLinkKey
   1045           *
   1046           * @brief   Set an application or trust center link key.
   1047           *
   1048           * @param   pBuf  - MT message data
   1049           *
   1050           * @return  void
   1051           ***************************************************************************************************/
   1052          void MT_ZdoSetLinkKey(uint8 *pBuf)
   1053          {
   1054            uint8 cmdId;
   1055            uint8 retValue;
   1056            uint8 *pExtAddr;
   1057            uint8 *pKey;
   1058            uint16 shortAddr;
   1059          
   1060            /* parse header */
   1061            cmdId = pBuf[MT_RPC_POS_CMD1];
   1062            pBuf += MT_RPC_FRAME_HDR_SZ;
   1063          
   1064            /* ShortAddr */
   1065            shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1066            pBuf += 2;
   1067          
   1068            /* Extended Addr */
   1069            pExtAddr = pBuf;
   1070            pBuf += Z_EXTADDR_LEN;
   1071          
   1072            /* Key data */
   1073            pKey = pBuf;
   1074          
   1075            retValue = (uint8)ZDSecMgrAddLinkKey( shortAddr, pExtAddr, pKey);
   1076          
   1077            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1078          }
   1079          
   1080          /***************************************************************************************************
   1081           * @fn      MT_ZdoRemoveLinkKey
   1082           *
   1083           * @brief   Remove an application or trust center link key.
   1084           *
   1085           * @param   pBuf  - MT message data
   1086           *
   1087           * @return  void
   1088           ***************************************************************************************************/
   1089          void MT_ZdoRemoveLinkKey(uint8 *pBuf)
   1090          {
   1091            uint8 cmdId;
   1092            uint8 retValue;
   1093            uint8 *pExtAddr;
   1094          
   1095            /* parse header */
   1096            cmdId = pBuf[MT_RPC_POS_CMD1];
   1097            pBuf += MT_RPC_FRAME_HDR_SZ;
   1098          
   1099            /* ShortAddr */
   1100            pExtAddr = pBuf;
   1101          
   1102            retValue = ZDSecMgrDeviceRemoveByExtAddr( pExtAddr );
   1103          
   1104            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1105          }
   1106          
   1107          /***************************************************************************************************
   1108           * @fn      MT_ZdoGetLinkKey
   1109           *
   1110           * @brief   Get the application link key.
   1111           *
   1112           * @param   pBuf  - MT message data
   1113           *
   1114           * @return  void
   1115           ***************************************************************************************************/
   1116          void MT_ZdoGetLinkKey(uint8 *pBuf)
   1117          {
   1118            uint8 cmdId;
   1119            uint8 retValue;
   1120            uint8 *pExtAddr;
   1121            uint8 *retBuf = NULL;
   1122            uint8 len;
   1123            APSME_LinkKeyData_t *pApsLinkKey = NULL;
   1124            uint16 apsLinkKeyNvId;
   1125          
   1126            // parse header
   1127            cmdId = pBuf[MT_RPC_POS_CMD1];
   1128            pBuf += MT_RPC_FRAME_HDR_SZ;
   1129          
   1130            // Extended Address
   1131            pExtAddr = pBuf;
   1132          
   1133            // Fetch the key NV ID
   1134            retValue = APSME_LinkKeyNVIdGet( pExtAddr, &apsLinkKeyNvId );
   1135          
   1136            if (retValue == ZSuccess)
   1137            {
   1138              if ((pApsLinkKey = (APSME_LinkKeyData_t *)osal_mem_alloc(sizeof(APSME_LinkKeyData_t))) != NULL)
   1139              {
   1140                // retrieve key from NV
   1141                if (osal_nv_read( apsLinkKeyNvId, 0,
   1142                                 sizeof(APSME_LinkKeyData_t), pApsLinkKey) != SUCCESS)
   1143                {
   1144                  retValue = ZNwkUnknownDevice;
   1145                }
   1146              }
   1147              else
   1148              {
   1149                retValue = ZNwkUnknownDevice;
   1150              }
   1151            }
   1152          
   1153            // Construct the response message
   1154            len = MT_ZDO_STATUS_LEN + Z_EXTADDR_LEN + SEC_KEY_LEN; // status + extAddr + key
   1155            if ((retBuf = (uint8 *)osal_mem_alloc(len)) != NULL)
   1156            {
   1157              if (retValue == ZSuccess)
   1158              {
   1159                // Extended Address
   1160                osal_memcpy( &(retBuf[1]), pExtAddr, Z_EXTADDR_LEN );
   1161          
   1162                // Key data
   1163                osal_memcpy( &(retBuf[1 + Z_EXTADDR_LEN]), pApsLinkKey->key, SEC_KEY_LEN );
   1164              }
   1165              else
   1166              {
   1167                // Failed case - set the rest fields to all FF
   1168                osal_memset( &(retBuf[1]), 0xFF, Z_EXTADDR_LEN + SEC_KEY_LEN );
   1169              }
   1170          
   1171              retBuf[0] = retValue;  // Status
   1172          
   1173              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, len, retBuf);
   1174          
   1175              // clear retBuf because it contains key data and free allocated memory
   1176              osal_memset(retBuf, 0x00, len);
   1177          
   1178              osal_mem_free(retBuf);
   1179            }
   1180          
   1181            // clear copy of key in RAM
   1182            if (pApsLinkKey != NULL)
   1183            {
   1184              osal_memset(pApsLinkKey, 0x00, sizeof(APSME_LinkKeyData_t));
   1185          
   1186              osal_mem_free(pApsLinkKey);
   1187            }
   1188          
   1189            return;
   1190          }
   1191          #endif // MT_SYS_KEY_MANAGEMENT
   1192          
   1193          #if defined (MT_ZDO_MGMT)
   1194          /***************************************************************************************************
   1195           * @fn      MT_ZdoMgmtNwkDiscRequest
   1196           *
   1197           * @brief   Handle a Mgmt Nwk Discovery request.
   1198           *
   1199           * @param   pBuf  - MT message data
   1200           *
   1201           * @return  void
   1202           ***************************************************************************************************/
   1203          void MT_ZdoMgmtNwkDiscRequest(uint8 *pBuf)
   1204          {
   1205            uint8 cmdId;
   1206            uint8 retValue;
   1207            zAddrType_t destAddr;
   1208            uint32 scanChannels;
   1209            uint8 scanDuration, startIndex;
   1210          
   1211            /* parse header */
   1212            cmdId = pBuf[MT_RPC_POS_CMD1];
   1213            pBuf += MT_RPC_FRAME_HDR_SZ;
   1214          
   1215            /* Dev address */
   1216            destAddr.addrMode = Addr16Bit;
   1217            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1218            pBuf += 2;
   1219          
   1220            /* Scan Channels */
   1221            scanChannels = BUILD_UINT32( pBuf[0], pBuf[1], pBuf[2], pBuf[3] );
   1222            pBuf += 4;
   1223          
   1224            /* Scan Duration */
   1225            scanDuration = *pBuf++;
   1226          
   1227            /* Start Index */
   1228            startIndex = *pBuf;
   1229          
   1230            retValue = (uint8)ZDP_MgmtNwkDiscReq( &destAddr, scanChannels, scanDuration, startIndex, 0);
   1231          
   1232            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1233          }
   1234          
   1235          /***************************************************************************************************
   1236           * @fn      MT_ZdoMgmtLqiRequest
   1237           *
   1238           * @brief   Handle a Mgmt Lqi request.
   1239           *
   1240           * @param   pBuf  - MT message data
   1241           *
   1242           * @return  void
   1243           ***************************************************************************************************/
   1244          void MT_ZdoMgmtLqiRequest(uint8 *pBuf)
   1245          {
   1246            uint8 cmdId;
   1247            uint8 retValue;
   1248            zAddrType_t destAddr;
   1249            uint8 startIndex;
   1250          
   1251            /* parse header */
   1252            cmdId = pBuf[MT_RPC_POS_CMD1];
   1253            pBuf += MT_RPC_FRAME_HDR_SZ;
   1254          
   1255            /* Dev address */
   1256            destAddr.addrMode = Addr16Bit;
   1257            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1258            pBuf += 2;
   1259          
   1260            /* Start Index */
   1261            startIndex = *pBuf;
   1262          
   1263            retValue = (uint8)ZDP_MgmtLqiReq( &destAddr, startIndex, 0);
   1264          
   1265            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1266          }
   1267          
   1268          /***************************************************************************************************
   1269           * @fn      MT_ZdoMgmtRtgRequest
   1270           *
   1271           * @brief   Handle a Mgmt Rtg request.
   1272           *
   1273           * @param   pBuf  - MT message data
   1274           *
   1275           * @return  void
   1276           ***************************************************************************************************/
   1277          void MT_ZdoMgmtRtgRequest(uint8 *pBuf)
   1278          {
   1279            uint8 cmdId;
   1280            uint8 retValue;
   1281            zAddrType_t destAddr;
   1282            uint8 startIndex;
   1283          
   1284            /* parse header */
   1285            cmdId = pBuf[MT_RPC_POS_CMD1];
   1286            pBuf += MT_RPC_FRAME_HDR_SZ;
   1287          
   1288            /* Dev Address */
   1289            destAddr.addrMode = Addr16Bit;
   1290            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1]);
   1291            pBuf += 2;
   1292          
   1293            /* Start Index */
   1294            startIndex = *pBuf;
   1295          
   1296            retValue = (byte)ZDP_MgmtRtgReq( &destAddr, startIndex, 0);
   1297          
   1298            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1299          }
   1300          
   1301          /***************************************************************************************************
   1302           * @fn      MT_ZdoMgmtBindRequest
   1303           *
   1304           * @brief   Handle a Mgmt Bind request.
   1305           *
   1306           * @param   pBuf  - MT message data
   1307           *
   1308           * @return  void
   1309           ***************************************************************************************************/
   1310          void MT_ZdoMgmtBindRequest(uint8 *pBuf)
   1311          {
   1312            uint8 cmdId;
   1313            uint8 retValue;
   1314            zAddrType_t destAddr;
   1315            uint8 startIndex;
   1316          
   1317            /* parse header */
   1318            cmdId = pBuf[MT_RPC_POS_CMD1];
   1319            pBuf += MT_RPC_FRAME_HDR_SZ;
   1320          
   1321            /* Dev Address */
   1322            destAddr.addrMode = Addr16Bit;
   1323            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1324            pBuf += 2;
   1325          
   1326            /* Start Index */
   1327            startIndex = *pBuf;
   1328          
   1329            retValue = (uint8)ZDP_MgmtBindReq( &destAddr, startIndex, 0);
   1330          
   1331            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1332          }
   1333          
   1334          /***************************************************************************************************
   1335           * @fn      MT_ZdoMgmtLeaveRequest
   1336           *
   1337           * @brief   Handle a Mgmt Leave request.
   1338           *
   1339           * @param   pBuf  - MT message data
   1340           *
   1341           * @return  void
   1342           ***************************************************************************************************/
   1343          void MT_ZdoMgmtLeaveRequest(uint8 *pBuf)
   1344          {
   1345            uint8 cmdId;
   1346            uint8 retValue;
   1347            zAddrType_t destAddr;
   1348            uint8 *pIEEEAddr;
   1349            uint8 removeChildren, rejoin;
   1350          
   1351            /* parse header */
   1352            cmdId = pBuf[MT_RPC_POS_CMD1];
   1353            pBuf += MT_RPC_FRAME_HDR_SZ;
   1354          
   1355            /* Destination Address */
   1356            destAddr.addrMode = Addr16Bit;
   1357            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1358            pBuf += 2;
   1359          
   1360            /* IEEE address */
   1361            pIEEEAddr = pBuf;
   1362            pBuf += Z_EXTADDR_LEN;
   1363          
   1364            /* Remove Children */
   1365            removeChildren = *pBuf++;
   1366          
   1367            /* Rejoin */
   1368            rejoin = *pBuf;
   1369          
   1370            retValue = (byte)ZDP_MgmtLeaveReq( &destAddr, pIEEEAddr, removeChildren, rejoin, 0);
   1371          
   1372            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1373          }
   1374          
   1375          
   1376          /***************************************************************************************************
   1377           * @fn      MT_ZdoMgmtDirectJoinRequest
   1378           *
   1379           * @brief   Handle a Mgmt Direct Join request.
   1380           *
   1381           * @param   pBuf  - MT message data
   1382           *
   1383           * @return  void
   1384           ***************************************************************************************************/
   1385          void MT_ZdoMgmtDirectJoinRequest(uint8 *pBuf)
   1386          {
   1387            uint8 cmdId;
   1388            uint8 retValue;
   1389            zAddrType_t destAddr;
   1390            uint8 *deviceAddr;
   1391            uint8 capInfo;
   1392          
   1393            /* parse header */
   1394            cmdId = pBuf[MT_RPC_POS_CMD1];
   1395            pBuf += MT_RPC_FRAME_HDR_SZ;
   1396          
   1397            /* Destination Address */
   1398            destAddr.addrMode = Addr16Bit;
   1399            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1400            pBuf += 2;
   1401          
   1402            /* Device Address */
   1403            deviceAddr = pBuf;
   1404            pBuf += Z_EXTADDR_LEN;
   1405          
   1406            /* Capability information */
   1407            capInfo = *pBuf;
   1408          
   1409            retValue = (uint8)ZDP_MgmtDirectJoinReq( &destAddr, deviceAddr, capInfo, 0);
   1410          
   1411            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1412          }
   1413          
   1414          /***************************************************************************************************
   1415           * @fn      MT_ZdoMgmtPermitJoinRequest
   1416           *
   1417           * @brief   Handle a Mgmt Permit Join request.
   1418           *
   1419           * @param   pBuf  - MT message data
   1420           *
   1421           * @return  void
   1422           ***************************************************************************************************/
   1423          void MT_ZdoMgmtPermitJoinRequest(uint8 *pBuf)
   1424          {
   1425            uint8 cmdId;
   1426            uint8 retValue;
   1427            zAddrType_t destAddr;
   1428            uint8 duration, tcSignificance;
   1429          
   1430            /* parse header */
   1431            cmdId = pBuf[MT_RPC_POS_CMD1];
   1432            pBuf += MT_RPC_FRAME_HDR_SZ;
   1433          
   1434            /* Destination Address */
   1435            destAddr.addrMode = Addr16Bit;
   1436            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1437            pBuf += 2;
   1438          
   1439            /* Duration */
   1440            duration = *pBuf++;
   1441          
   1442            /* Trust center significance */
   1443            tcSignificance = *pBuf;
   1444          
   1445            retValue = (byte)ZDP_MgmtPermitJoinReq( &destAddr, duration, tcSignificance, 0);
   1446          
   1447            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1448          }
   1449          
   1450          /***************************************************************************************************
   1451           * @fn      MT_ZdoMgmtNwkUpdateRequest
   1452           *
   1453           * @brief   Handle a Mgmt Nwk Update request.
   1454           *
   1455           * @param   pBuf  - MT message data
   1456           *
   1457           * @return  void
   1458           ***************************************************************************************************/
   1459          void MT_ZdoMgmtNwkUpdateRequest(uint8 *pBuf)
   1460          {
   1461            uint8 cmdId;
   1462            uint8 retValue;
   1463            zAddrType_t destAddr;
   1464            uint32 channelMask;
   1465            uint8 scanDuration, scanCount;
   1466            uint16 nwkManagerAddr;
   1467          
   1468              /* parse header */
   1469            cmdId = pBuf[MT_RPC_POS_CMD1];
   1470            pBuf += MT_RPC_FRAME_HDR_SZ;
   1471          
   1472            /* Destination address */
   1473            destAddr.addr.shortAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1474            pBuf += 2;
   1475          
   1476            /* Destination address mode */
   1477            destAddr.addrMode = *pBuf++;
   1478          
   1479            channelMask = BUILD_UINT32( pBuf[0], pBuf[1], pBuf[2], pBuf[3]);
   1480            pBuf += 4;
   1481          
   1482            /* Scan duration */
   1483            scanDuration = *pBuf++;
   1484          
   1485            /* Scan count */
   1486            scanCount = *pBuf++;
   1487          
   1488            /* NWK manager address */
   1489            nwkManagerAddr = BUILD_UINT16( pBuf[0], pBuf[1] );
   1490          
   1491            /* Send the Management Network Update request */
   1492            retValue = (uint8)ZDP_MgmtNwkUpdateReq( &destAddr, channelMask, scanDuration,
   1493                                                    scanCount, _NIB.nwkUpdateId+1, nwkManagerAddr );
   1494          
   1495            /*
   1496              Since we don't recevied our own broadcast messages, we should
   1497              send a unicast copy of the message to ourself.
   1498            */
   1499            if ( destAddr.addrMode == AddrBroadcast )
   1500            {
   1501              destAddr.addrMode = Addr16Bit;
   1502              destAddr.addr.shortAddr = _NIB.nwkDevAddress;
   1503              retValue = (uint8) ZDP_MgmtNwkUpdateReq( &destAddr, channelMask, scanDuration,
   1504                                                       scanCount, _NIB.nwkUpdateId+1, nwkManagerAddr );
   1505            }
   1506          
   1507            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue);
   1508          }
   1509          #endif /* MT_ZDO_MGMT */
   1510          
   1511          /***************************************************************************************************
   1512           * @fn      MT_ZdoStartupFromApp
   1513           *
   1514           * @brief   Handle a Startup from App request.
   1515           *
   1516           * @param   pBuf  - MT message data
   1517           *
   1518           * @return  void
   1519           ***************************************************************************************************/

   \                                 In  segment CODE, align 2, keep-with-next
   1520          void MT_ZdoStartupFromApp(uint8 *pBuf)
   \                     MT_ZdoStartupFromApp:
   1521          {
   \   000000   1B15         PUSHM.W #0x2, R11
   \   000002   2183         SUB.W   #0x2, SP
   1522            uint8 cmd0, cmd1, retValue;
   1523          
   1524            /* parse header */
   1525            cmd0 = pBuf[MT_RPC_POS_CMD0];
   \   000004   5B4C0100     MOV.B   0x1(R12), R11
   1526            cmd1 = pBuf[MT_RPC_POS_CMD1];
   \   000008   5A4C0200     MOV.B   0x2(R12), R10
   1527            pBuf += MT_RPC_FRAME_HDR_SZ;
   1528          
   1529            retValue = ZDOInitDevice(100);
   \   00000C   3C406400     MOV.W   #0x64, R12
   \   000010   ........     CALLA   #ZDOInitDevice
   \   000014                REQUIRE ?Subroutine1
   \   000014                // Fall through to label ?Subroutine1
   1530          
   1531            if (MT_RPC_CMD_SREQ == (cmd0 & MT_RPC_CMD_TYPE_MASK))
   1532            {
   1533              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP|(uint8)MT_RPC_SYS_ZDO), cmd1,1, &retValue);
   1534            }
   1535          }

   \                                 In  segment CODE, align 2
   \                     ?Subroutine1:
   \   000000   C14C0000     MOV.B   R12, 0(SP)
   \   000004   7BF0E000     AND.B   #0xe0, R11
   \   000008   7B902000     CMP.B   #0x20, R11
   \   00000C   0220         JNE     ??Subroutine1_0
   \   00000E   ........     CALLA   #??Subroutine7_0
   \                     ??Subroutine1_0:
   \   000012   2153         ADD.W   #0x2, SP
   \   000014   1A17         POPM.W  #0x2, R11
   \   000016   1001         RETA
   1536          
   1537          
   1538          /***************************************************************************************************
   1539           * @fn      MT_ZdoNetworkDiscoveryReq
   1540           *
   1541           * @brief   Handle a ZDO Network Discovery request.
   1542           *
   1543           * @param   pBuf  - MT message data
   1544           *
   1545           * @return  void
   1546           ***************************************************************************************************/

   \                                 In  segment CODE, align 2, keep-with-next
   1547          void MT_ZdoNetworkDiscoveryReq(uint8 *pBuf)
   \                     MT_ZdoNetworkDiscoveryReq:
   1548          {
   \   000000   1B15         PUSHM.W #0x2, R11
   \   000002   2183         SUB.W   #0x2, SP
   \   000004   0B4C         MOV.W   R12, R11
   1549            uint8  retValue = ZFailure;
   \   000006   D1430000     MOV.B   #0x1, 0(SP)
   1550            uint8  cmdId;
   1551            uint32 scanChannels;
   1552          
   1553            /* parse header */
   1554            cmdId = pBuf[MT_RPC_POS_CMD1];
   \   00000A   5A4C0200     MOV.B   0x2(R12), R10
   1555            pBuf += MT_RPC_FRAME_HDR_SZ;
   \   00000E   3B500300     ADD.W   #0x3, R11
   1556          
   1557            /* Packet format */
   1558            /* scan channels (4) | scan duration (1) */
   1559          
   1560            /* Scan channels */
   1561            scanChannels = osal_build_uint32(pBuf, 4);
   \   000012   6D42         MOV.B   #0x4, R13
   \   000014   0C4B         MOV.W   R11, R12
   \   000016   ........     CALLA   #osal_build_uint32
   1562            pBuf += 4;
   1563          
   1564            retValue = ZDApp_NetworkDiscoveryReq(scanChannels, *pBuf);
   \   00001A   5E4B0400     MOV.B   0x4(R11), R14
   \   00001E   ........     CALLA   #ZDApp_NetworkDiscoveryReq
   \   000022   C14C0000     MOV.B   R12, 0(SP)
   1565          
   1566            // Register ZDO callback for MT to handle the network discovery confirm
   1567            // and beacon notification confirm
   1568            ZDO_RegisterForZdoCB( ZDO_NWK_DISCOVERY_CNF_CBID, &MT_ZdoNwkDiscoveryCnfCB );
   \   000026   3E40....     MOV.W   #LWRD(MT_ZdoNwkDiscoveryCnfCB), R14
   \   00002A   3F40....     MOV.W   #HWRD(MT_ZdoNwkDiscoveryCnfCB), R15
   \   00002E   6C43         MOV.B   #0x2, R12
   \   000030   ........     CALLA   #ZDO_RegisterForZdoCB
   1569            ZDO_RegisterForZdoCB( ZDO_BEACON_NOTIFY_IND_CBID, &MT_ZdoBeaconIndCB );
   \   000034   3E40....     MOV.W   #LWRD(MT_ZdoBeaconIndCB), R14
   \   000038   3F40....     MOV.W   #HWRD(MT_ZdoBeaconIndCB), R15
   \   00003C   7C400300     MOV.B   #0x3, R12
   \   000040   ........     CALLA   #ZDO_RegisterForZdoCB
   1570          
   1571            /* Build and send back the response */
   1572            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue );
   \   000044   ........     CALLA   #??Subroutine7_0
   1573          }
   \                     ??CrossCallReturnLabel_42:
   \   000048   ....         JMP     ??Subroutine1_0
   1574          
   1575          
   1576          /***************************************************************************************************
   1577           * @fn      MT_ZdoJoinReq
   1578           *
   1579           * @brief   Handle a ZDO Join request.
   1580           *
   1581           * @param   pBuf  - MT message data
   1582           *
   1583           * @return  void
   1584           ***************************************************************************************************/

   \                                 In  segment CODE, align 2, keep-with-next
   1585          void MT_ZdoJoinReq(uint8 *pBuf)
   \                     MT_ZdoJoinReq:
   1586          {
   \   000000   1B15         PUSHM.W #0x2, R11
   \   000002   2183         SUB.W   #0x2, SP
   1587            uint8  retValue = ZFailure;
   \   000004   D1430000     MOV.B   #0x1, 0(SP)
   1588            uint8  cmdId;
   1589            uint16 panId;
   1590            uint16 chosenParent;
   1591          
   1592            /* parse header */
   1593            cmdId = pBuf[MT_RPC_POS_CMD1];
   \   000008   ........     CALLA   #?Subroutine15
   1594            pBuf += MT_RPC_FRAME_HDR_SZ;
   1595          
   1596            /* Packet format */
   1597            /* channel     (1) | panID (2) | extendedPanID (8) | chosenParent (2) |
   1598             * parentDepth (1) | stackProfile  (1)
   1599             */
   1600          
   1601            panId        = BUILD_UINT16(pBuf[1], pBuf[2]);
   1602            chosenParent = BUILD_UINT16(pBuf[11], pBuf[12]);
   1603          
   1604            retValue = ZDApp_JoinReq(pBuf[0], panId, &(pBuf[3]), chosenParent, pBuf[13], pBuf[14]);
   \                     ??CrossCallReturnLabel_20:
   \   00000C   5C120E00     PUSH.B  0xe(R12)
   \   000010   5C120D00     PUSH.B  0xd(R12)
   \   000014   5F4C0B00     MOV.B   0xb(R12), R15
   \   000018   5B4C0C00     MOV.B   0xc(R12), R11
   \   00001C                RPT     #0x8
   \   00001C   47180B5B     RLAX.W  R11
   \   000020   0F5B         ADD.W   R11, R15
   \   000022   0E4C         MOV.W   R12, R14
   \   000024   3E500300     ADD.W   #0x3, R14
   \   000028   5D4C0100     MOV.B   0x1(R12), R13
   \   00002C   5B4C0200     MOV.B   0x2(R12), R11
   \   000030                RPT     #0x8
   \   000030   47180B5B     RLAX.W  R11
   \   000034   0D5B         ADD.W   R11, R13
   \   000036   6C4C         MOV.B   @R12, R12
   \   000038   ........     CALLA   #ZDApp_JoinReq
   \   00003C   C14C0400     MOV.B   R12, 0x4(SP)
   1605          
   1606            /* Register for MT to receive Join Confirm */
   1607            ZDO_RegisterForZdoCB( ZDO_JOIN_CNF_CBID, &MT_ZdoJoinCnfCB );
   \   000040   3E40....     MOV.W   #LWRD(MT_ZdoJoinCnfCB), R14
   \   000044   3F40....     MOV.W   #HWRD(MT_ZdoJoinCnfCB), R15
   \   000048   6C42         MOV.B   #0x4, R12
   \   00004A   ........     CALLA   #ZDO_RegisterForZdoCB
   1608          
   1609            /* Build and send back the response */
   1610            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP | (uint8)MT_RPC_SYS_ZDO), cmdId, 1, &retValue );
   \   00004E   0F41         MOV.W   SP, R15
   \   000050   2F52         ADD.W   #0x4, R15
   \   000052   ........     CALLA   #??Subroutine7_1
   1611          
   1612          }
   \                     ??CrossCallReturnLabel_39:
   \   000056   31500600     ADD.W   #0x6, SP
   \   00005A   1A17         POPM.W  #0x2, R11
   \   00005C   1001         RETA
   1613          
   1614          /***************************************************************************************************
   1615           * @fn          MT_ZdoNwkDiscoveryCnfCB
   1616           *
   1617           * @brief       Send an indication to inform host device the completion of
   1618           *              network discovery scan
   1619           *
   1620           * @param       pStr - pointer to a parameter and a structure of parameters
   1621           *
   1622           * @return      void
   1623           ***************************************************************************************************/

   \                                 In  segment CODE, align 2, keep-with-next
   1624          void *MT_ZdoNwkDiscoveryCnfCB ( void *pStr )
   \                     MT_ZdoNwkDiscoveryCnfCB:
   1625          {
   \   000000   0A12         PUSH.W  R10
   \   000002   0A4C         MOV.W   R12, R10
   1626            /* pStr: status (uint8) */
   1627            /* Packet Format */
   1628            /* Status (1) */
   1629          
   1630            // Scan completed. De-register the callback with ZDO
   1631            ZDO_DeregisterForZdoCB( ZDO_NWK_DISCOVERY_CNF_CBID );
   \   000004   6C43         MOV.B   #0x2, R12
   \   000006   ........     CALLA   #ZDO_DeregisterForZdoCB
   1632            ZDO_DeregisterForZdoCB( ZDO_BEACON_NOTIFY_IND_CBID );
   \   00000A   7C400300     MOV.B   #0x3, R12
   \   00000E   ........     CALLA   #ZDO_DeregisterForZdoCB
   1633          
   1634            // Send the buffered beacon indication
   1635            MT_ZdoBeaconIndCB ( NULL );
   \   000012   0C43         MOV.W   #0x0, R12
   \   000014   ........     CALLA   #MT_ZdoBeaconIndCB
   1636          
   1637            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO),
   1638                                                   MT_ZDO_NWK_DISCOVERY_CNF, 1, pStr);
   \   000018   0F4A         MOV.W   R10, R15
   \   00001A   5E43         MOV.B   #0x1, R14
   \   00001C   7D40C700     MOV.B   #0xc7, R13
   \   000020   ........     CALLA   #??Subroutine5_0
   1639            return NULL;
   \                     ??CrossCallReturnLabel_29:
   \   000024   0C43         MOV.W   #0x0, R12
   \   000026   3A41         POP.W   R10
   \   000028   1001         RETA
   1640          }

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ??Subroutine5_0:
   \   000000   7C404500     MOV.B   #0x45, R12
   \   000004   ........     BRA     #MT_BuildAndSendZToolResponse
   1641          
   1642          
   1643          
   1644          /***************************************************************************************************
   1645           * @fn          MT_ZdoBeaconIndCB
   1646           *
   1647           * @brief       Send an indication to host device of a beacon notification
   1648           *
   1649           * @param       pStr -  pointer to a parameter and a structure of parameters
   1650           *
   1651           * @return      void
   1652           ***************************************************************************************************/

   \                                 In  segment CODE, align 2, keep-with-next
   1653          void *MT_ZdoBeaconIndCB ( void *pStr )
   \                     MT_ZdoBeaconIndCB:
   1654          {
   \   000000   1B15         PUSHM.W #0x2, R11
   \   000002   0B4C         MOV.W   R12, R11
   1655            zdoBeaconInd_t *pBeacon = pStr;
   1656            uint8 *pTmp;
   1657          
   1658            /* Packet Format */
   1659            /* devCnt (1) | device #1 (21) | device #2 (21) |... | device #n (21) */
   1660          
   1661            if( pStr != NULL)
   \   000004   1F42....     MOV.W   &pBeaconIndBuf, R15
   \   000008   3A40....     MOV.W   #pBeaconIndBuf, R10
   \   00000C   0C93         CMP.W   #0x0, R12
   \   00000E   5F24         JEQ     ??MT_ZdoBeaconIndCB_0
   1662            {
   1663              if( pBeaconIndBuf == NULL )
   \   000010   0F93         CMP.W   #0x0, R15
   \   000012   0A20         JNE     ??MT_ZdoBeaconIndCB_1
   1664              {
   1665                // If pBeaconIndBuf has not been allocated yet
   1666                // allocate memory now with MAX_UART_TX_BUFF
   1667                if( NULL == (pBeaconIndBuf = (uint8 *)osal_mem_alloc(MT_ZDO_BEACON_IND_PACK_LEN)))
   \   000014   3C407B00     MOV.W   #0x7b, R12
   \   000018   ........     CALLA   #osal_mem_alloc
   \   00001C   824C....     MOV.W   R12, &pBeaconIndBuf
   \   000020   0C93         CMP.W   #0x0, R12
   \   000022   6424         JEQ     ??MT_ZdoBeaconIndCB_2
   1668                {
   1669                  // Memory failure
   1670                  return NULL;
   1671                }
   1672                pBeaconIndBuf[0] = 0; // First byte is devCnt. Initialize to 0.
   \   000024   CC430000     MOV.B   #0x0, 0(R12)
   1673              }
   1674          
   1675              // Fill in the buffer with the beacon indication
   1676              pTmp = pBeaconIndBuf + (1 + pBeaconIndBuf[0] * MT_ZDO_BEACON_IND_LEN);
   \                     ??MT_ZdoBeaconIndCB_1:
   \   000028   2C4A         MOV.W   @R10, R12
   \   00002A   6F4C         MOV.B   @R12, R15
   \   00002C   0E4F         MOV.W   R15, R14
   \   00002E   5F06         RLAM.W  #0x2, R15
   \   000030   0E5F         ADD.W   R15, R14
   \   000032   5F06         RLAM.W  #0x2, R15
   \   000034   0F5E         ADD.W   R14, R15
   \   000036   0C5F         ADD.W   R15, R12
   \   000038   1C53         ADD.W   #0x1, R12
   1677              *pTmp++ = LO_UINT16(pBeacon->sourceAddr);
   \   00003A   EC4B0000     MOV.B   @R11, 0(R12)
   \   00003E   1C53         ADD.W   #0x1, R12
   1678              *pTmp++ = HI_UINT16(pBeacon->sourceAddr);
   \   000040   DC4B01000000 MOV.B   0x1(R11), 0(R12)
   \   000046   1C53         ADD.W   #0x1, R12
   1679              *pTmp++ = LO_UINT16(pBeacon->panID);
   \   000048   ........     CALLA   #?Subroutine6
   1680              *pTmp++ = HI_UINT16(pBeacon->panID);
   1681              *pTmp++ = pBeacon->logicalChannel;
   \                     ??CrossCallReturnLabel_3:
   \   00004C   DC4B04000000 MOV.B   0x4(R11), 0(R12)
   \   000052   1C53         ADD.W   #0x1, R12
   1682              *pTmp++ = pBeacon->permitJoining;
   \   000054   DC4B05000000 MOV.B   0x5(R11), 0(R12)
   \   00005A   1C53         ADD.W   #0x1, R12
   1683              *pTmp++ = pBeacon->routerCapacity;
   \   00005C   DC4B06000000 MOV.B   0x6(R11), 0(R12)
   \   000062   1C53         ADD.W   #0x1, R12
   1684              *pTmp++ = pBeacon->deviceCapacity;
   \   000064   DC4B07000000 MOV.B   0x7(R11), 0(R12)
   \   00006A   1C53         ADD.W   #0x1, R12
   1685              *pTmp++ = pBeacon->protocolVersion;
   \   00006C   DC4B08000000 MOV.B   0x8(R11), 0(R12)
   \   000072   1C53         ADD.W   #0x1, R12
   1686              *pTmp++ = pBeacon->stackProfile;
   \   000074   DC4B09000000 MOV.B   0x9(R11), 0(R12)
   \   00007A   1C53         ADD.W   #0x1, R12
   1687              *pTmp++ = pBeacon->LQI;
   \   00007C   DC4B0A000000 MOV.B   0xa(R11), 0(R12)
   \   000082   1C53         ADD.W   #0x1, R12
   1688              *pTmp++ = pBeacon->depth;
   \   000084   DC4B0B000000 MOV.B   0xb(R11), 0(R12)
   \   00008A   1C53         ADD.W   #0x1, R12
   1689              *pTmp++ = pBeacon->updateID;
   \   00008C   DC4B0C000000 MOV.B   0xc(R11), 0(R12)
   \   000092   1C53         ADD.W   #0x1, R12
   1690              osal_memcpy( pTmp, pBeacon->extendedPanID, Z_EXTADDR_LEN);
   \   000094   3E42         MOV.W   #0x8, R14
   \   000096   3B500D00     ADD.W   #0xd, R11
   \   00009A   0D4B         MOV.W   R11, R13
   \   00009C   ........     CALLA   #osal_memcpy
   1691          
   1692              pBeaconIndBuf[0] += 1; // Increment the devCnt
   \   0000A0   2F4A         MOV.W   @R10, R15
   \   0000A2   DF530000     ADD.B   #0x1, 0(R15)
   \   0000A6   2F4A         MOV.W   @R10, R15
   \   0000A8   6E4F         MOV.B   @R15, R14
   \   0000AA   4F4E         MOV.B   R14, R15
   \   0000AC   0B4F         MOV.W   R15, R11
   \   0000AE   5F06         RLAM.W  #0x2, R15
   \   0000B0   0B5F         ADD.W   R15, R11
   \   0000B2   5F06         RLAM.W  #0x2, R15
   \   0000B4   0F5B         ADD.W   R11, R15
   \   0000B6   3F501600     ADD.W   #0x16, R15
   \   0000BA   3F907C00     CMP.W   #0x7c, R15
   \   0000BE   1638         JL      ??MT_ZdoBeaconIndCB_2
   1693          
   1694              // Check if the buffer can fit in another beacon
   1695              if( ((pBeaconIndBuf[0] + 1) * MT_ZDO_BEACON_IND_LEN + 1) > MT_ZDO_BEACON_IND_PACK_LEN )
   1696              {
   1697                // Packet full, send the packet over MT
   1698                MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO),
   1699                                             MT_ZDO_BEACON_NOTIFY_IND,
   1700                                             (pBeaconIndBuf[0] * MT_ZDO_BEACON_IND_LEN + 1), pBeaconIndBuf);
   \   0000C0   2F4A         MOV.W   @R10, R15
   \   0000C2   ........     CALLA   #?Subroutine5
   1701                pBeaconIndBuf[0] = 0; // Reset the devCnt back to zero
   \                     ??CrossCallReturnLabel_33:
   \   0000C6   2F4A         MOV.W   @R10, R15
   \   0000C8   CF430000     MOV.B   #0x0, 0(R15)
   \   0000CC   0F3C         JMP     ??MT_ZdoBeaconIndCB_2
   1702              }
   1703            }
   1704            else
   1705            {
   1706              if( (pBeaconIndBuf != NULL) && (pBeaconIndBuf[0] != 0) )
   \                     ??MT_ZdoBeaconIndCB_0:
   \   0000CE   0F93         CMP.W   #0x0, R15
   \   0000D0   0D24         JEQ     ??MT_ZdoBeaconIndCB_2
   \   0000D2   6E4F         MOV.B   @R15, R14
   \   0000D4   4E93         CMP.B   #0x0, R14
   \   0000D6   0524         JEQ     ??MT_ZdoBeaconIndCB_3
   1707              {
   1708                // End of beacon indication, send the packet over MT
   1709                MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO),
   1710                                             MT_ZDO_BEACON_NOTIFY_IND,
   1711                                             (pBeaconIndBuf[0] * MT_ZDO_BEACON_IND_LEN + 1), pBeaconIndBuf);
   \   0000D8   ........     CALLA   #?Subroutine5
   1712              }
   1713              // Free the allocated memory
   1714              if(pBeaconIndBuf != NULL)
   \                     ??CrossCallReturnLabel_32:
   \   0000DC   8293....     CMP.W   #0x0, &pBeaconIndBuf
   \   0000E0   0524         JEQ     ??MT_ZdoBeaconIndCB_2
   1715              {
   1716                osal_mem_free(pBeaconIndBuf);
   \                     ??MT_ZdoBeaconIndCB_3:
   \   0000E2   2C4A         MOV.W   @R10, R12
   \   0000E4   ........     CALLA   #osal_mem_free
   1717                pBeaconIndBuf = NULL;
   \   0000E8   8243....     MOV.W   #0x0, &pBeaconIndBuf
   1718              }
   1719            }
   1720          
   1721            return NULL;
   \                     ??MT_ZdoBeaconIndCB_2:
   \   0000EC   0C43         MOV.W   #0x0, R12
   \   0000EE   1A17         POPM.W  #0x2, R11
   \   0000F0   1001         RETA
   1722          }

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine6:
   \   000000   DC4B02000000 MOV.B   0x2(R11), 0(R12)
   \   000006   1C53         ADD.W   #0x1, R12
   \   000008   DC4B03000000 MOV.B   0x3(R11), 0(R12)
   \   00000E   1C53         ADD.W   #0x1, R12
   \   000010   1001         RETA

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine5:
   \   000000   4D4E         MOV.B   R14, R13
   \   000002                RPT     #0x2
   \   000002   41184E5E     RLAX.B  R14
   \   000006   4D5E         ADD.B   R14, R13
   \   000008                RPT     #0x2
   \   000008   41184E5E     RLAX.B  R14
   \   00000C   4E5D         ADD.B   R13, R14
   \   00000E   5E53         ADD.B   #0x1, R14
   \   000010   7D40C500     MOV.B   #0xc5, R13
   \   000014                REQUIRE ??Subroutine5_0
   \   000014                // Fall through to label ??Subroutine5_0
   1723          
   1724          
   1725          
   1726          /***************************************************************************************************
   1727           * @fn          MT_ZdoJoinCnfCB
   1728           *
   1729           * @brief       Handle the ZDO Join Confirm from ZDO
   1730           *
   1731           * @param       pStr - pointer to a parameter and a structure of parameters
   1732           *
   1733           * @return      void
   1734           ***************************************************************************************************/

   \                                 In  segment CODE, align 2, keep-with-next
   1735          void *MT_ZdoJoinCnfCB ( void *pStr )
   \                     MT_ZdoJoinCnfCB:
   1736          {
   \   000000   0A12         PUSH.W  R10
   \   000002   31800600     SUB.W   #0x6, SP
   \   000006   0A4C         MOV.W   R12, R10
   1737            /* pStr: zdoJoinCnf_t* */
   1738            /* Packet Format */
   1739            /* Status (1) | device addr (2) | parent addr (2) */
   1740          
   1741            uint8 buf[MT_ZDO_JOIN_CNF_LEN];
   1742            zdoJoinCnf_t *joinCnf = pStr;
   1743          
   1744            /* Join Complete. De-register the callback with ZDO */
   1745            ZDO_DeregisterForZdoCB( ZDO_JOIN_CNF_CBID );
   \   000008   6C42         MOV.B   #0x4, R12
   \   00000A   ........     CALLA   #ZDO_DeregisterForZdoCB
   1746          
   1747            buf[0] = joinCnf->status;
   \   00000E   E14A0000     MOV.B   @R10, 0(SP)
   1748            buf[1] = LO_UINT16( joinCnf->deviceAddr );
   \   000012   D14A02000100 MOV.B   0x2(R10), 0x1(SP)
   1749            buf[2] = HI_UINT16( joinCnf->deviceAddr );
   \   000018   D14A03000200 MOV.B   0x3(R10), 0x2(SP)
   1750            buf[3] = LO_UINT16( joinCnf->parentAddr );
   \   00001E   D14A04000300 MOV.B   0x4(R10), 0x3(SP)
   1751            buf[4] = HI_UINT16( joinCnf->parentAddr );
   \   000024   D14A05000400 MOV.B   0x5(R10), 0x4(SP)
   1752          
   1753            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO),
   1754                                         MT_ZDO_JOIN_CNF, MT_ZDO_JOIN_CNF_LEN, buf);
   \   00002A   0F41         MOV.W   SP, R15
   \   00002C   0F53         ADD.W   #0x0, R15
   \   00002E   7E400500     MOV.B   #0x5, R14
   \   000032   7D40C600     MOV.B   #0xc6, R13
   \   000036   ........     CALLA   #??Subroutine5_0
   1755          
   1756            return NULL;
   \                     ??CrossCallReturnLabel_30:
   \   00003A   0C43         MOV.W   #0x0, R12
   \   00003C   31500600     ADD.W   #0x6, SP
   \   000040   3A41         POP.W   R10
   \   000042   1001         RETA
   1757          }
   1758          
   1759          /*************************************************************************************************
   1760           * @fn      MT_ZdoRegisterForZDOMsg(pBuf);
   1761           *
   1762           * @brief   MT proxy for ZDO_RegisterForZDOMsg.
   1763           *
   1764           * @param   pBuf  - MT message data
   1765           *
   1766           * @return  void
   1767           *************************************************************************************************/

   \                                 In  segment CODE, align 2, keep-with-next
   1768          void MT_ZdoRegisterForZDOMsg(uint8 *pBuf)
   \                     MT_ZdoRegisterForZDOMsg:
   1769          {
   \   000000   1B15         PUSHM.W #0x2, R11
   \   000002   2183         SUB.W   #0x2, SP
   1770            uint8 cmd0, cmd1, tmp;
   1771            uint16 cId;
   1772          
   1773            /* parse header */
   1774            cmd0 = pBuf[MT_RPC_POS_CMD0];
   \   000004   ........     CALLA   #?Subroutine4
   1775            cmd1 = pBuf[MT_RPC_POS_CMD1];
   1776            pBuf += MT_RPC_FRAME_HDR_SZ;
   1777          
   1778            cId = BUILD_UINT16(pBuf[0], pBuf[1]);
   1779            tmp = ZDO_RegisterForZDOMsg(MT_TaskID, cId);
   \                     ??CrossCallReturnLabel_1:
   \   000008   ........     CALLA   #ZDO_RegisterForZDOMsg
   \   00000C   ....         JMP     ?Subroutine1
   1780          
   1781            if (MT_RPC_CMD_SREQ == (cmd0 & MT_RPC_CMD_TYPE_MASK))
   1782            {
   1783              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP|(uint8)MT_RPC_SYS_ZDO), cmd1, 1, &tmp);
   1784            }
   1785          }

   \                                 In  segment CODE, align 2, keep-with-next
   \                     ?Subroutine4:
   \   000000   5B4C0100     MOV.B   0x1(R12), R11
   \   000004   ........     CALLA   #?Subroutine15
   \                     ??CrossCallReturnLabel_19:
   \   000008   6D4C         MOV.B   @R12, R13
   \   00000A   ........     CALLA   #?Subroutine16
   \                     ??CrossCallReturnLabel_24:
   \   00000E   0D5F         ADD.W   R15, R13
   \   000010   5C42....     MOV.B   &MT_TaskID, R12
   \   000014   1001         RETA
   1786          
   1787          /*************************************************************************************************
   1788           * @fn      MT_ZdoRemoveRegisteredCB(pBuf);
   1789           *
   1790           * @brief   MT proxy for ZDO_RemoveRegisteredCB.
   1791           *
   1792           * @param   pBuf  - MT message data
   1793           *
   1794           * @return  void
   1795           *************************************************************************************************/

   \                                 In  segment CODE, align 2, keep-with-next
   1796          void MT_ZdoRemoveRegisteredCB(uint8 *pBuf)
   \                     MT_ZdoRemoveRegisteredCB:
   1797          {
   \   000000   1B15         PUSHM.W #0x2, R11
   \   000002   2183         SUB.W   #0x2, SP
   1798            uint8 cmd0, cmd1, tmp;
   1799            uint16 cId;
   1800          
   1801            /* parse header */
   1802            cmd0 = pBuf[MT_RPC_POS_CMD0];
   \   000004   ........     CALLA   #?Subroutine4
   1803            cmd1 = pBuf[MT_RPC_POS_CMD1];
   1804            pBuf += MT_RPC_FRAME_HDR_SZ;
   1805          
   1806            cId = BUILD_UINT16(pBuf[0], pBuf[1]);
   1807            tmp = ZDO_RemoveRegisteredCB(MT_TaskID, cId);
   \                     ??CrossCallReturnLabel_0:
   \   000008   ........     CALLA   #ZDO_RemoveRegisteredCB
   \   00000C   ....         JMP     ?Subroutine1
   1808          
   1809            if (MT_RPC_CMD_SREQ == (cmd0 & MT_RPC_CMD_TYPE_MASK))
   1810            {
   1811              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_SRSP|(uint8)MT_RPC_SYS_ZDO), cmd1, 1, &tmp);
   1812            }
   1813          }
   1814          
   1815          #endif /* MT_ZDO_FUNC */
   1816          
   1817          
   1818          /***************************************************************************************************
   1819           * Callback handling function
   1820           ***************************************************************************************************/
   1821          
   1822          #if defined (MT_ZDO_CB_FUNC)
   1823          
   1824          /***************************************************************************************************
   1825           * @fn      MT_ZdoStateChangeCB
   1826           *
   1827           * @brief   Handle state change OSAL message from ZDO.
   1828           *
   1829           * @param   pMsg  - Message data
   1830           *
   1831           * @return  void
   1832           */
   1833          void MT_ZdoStateChangeCB(osal_event_hdr_t *pMsg)
   1834          {
   1835            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO),
   1836                                                 MT_ZDO_STATE_CHANGE_IND, 1, &pMsg->status);
   1837          }
   1838          
   1839          /***************************************************************************************************
   1840           * @fn     MT_ZdoDirectCB()
   1841           *
   1842           * @brief  ZDO direct callback.  Build an MT message directly from the
   1843           *         over-the-air ZDO message.
   1844           *
   1845           * @param  pData - Incoming AF frame.
   1846           *
   1847           * @return  none
   1848           ***************************************************************************************************/
   1849          void MT_ZdoDirectCB( afIncomingMSGPacket_t *pData, zdoIncomingMsg_t *inMsg )
   1850          {
   1851            uint8 len, *pBuf;
   1852            uint16 origClusterId;
   1853          
   1854            // save original value because MT_ZdoHandleExceptions() function could modify pData->clusterId
   1855            origClusterId = pData->clusterId;
   1856          
   1857            // Is the message an exception or not a response?
   1858            if ( MT_ZdoHandleExceptions( pData, inMsg ) || ( (origClusterId & ZDO_RESPONSE_BIT) == 0 ) )
   1859            {
   1860              return;  // Handled somewhere else or not needed.
   1861            }
   1862          
   1863            /* ZDO data starts after one-byte sequence number and the msg buffer length includes
   1864             * two bytes for srcAddr.
   1865             */
   1866            len = pData->cmd.DataLength - 1 + sizeof(uint16);
   1867          
   1868            if (NULL != (pBuf = (uint8 *)osal_mem_alloc(len)))
   1869            {
   1870              uint8 id = MT_ZDO_CID_TO_AREQ_ID(pData->clusterId);
   1871          
   1872              pBuf[0] = LO_UINT16(pData->srcAddr.addr.shortAddr);
   1873              pBuf[1] = HI_UINT16(pData->srcAddr.addr.shortAddr);
   1874          
   1875              /* copy ZDO data, skipping one-byte sequence number */
   1876              osal_memcpy(pBuf+2, (pData->cmd.Data + 1), pData->cmd.DataLength-1);
   1877          
   1878              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO), id, len, pBuf);
   1879              osal_mem_free(pBuf);
   1880            }
   1881          }
   1882          
   1883          /***************************************************************************************************
   1884           * @fn     MT_ZdoHandleExceptions()
   1885           *
   1886           * @brief  Handles all messages that are an exception to the generic MT ZDO Response.
   1887           *
   1888           * @param  pData - Incoming AF frame.
   1889           *
   1890           * @return  TRUE if handled by this function, FALSE if not
   1891           ***************************************************************************************************/
   1892          uint8 MT_ZdoHandleExceptions( afIncomingMSGPacket_t *pData, zdoIncomingMsg_t *inMsg )
   1893          {
   1894            uint8 ret = TRUE;
   1895            ZDO_NwkIEEEAddrResp_t *nwkRsp;
   1896            ZDO_DeviceAnnce_t devAnnce;
   1897            uint8 doDefault = FALSE;
   1898          
   1899            switch ( inMsg->clusterID )
   1900            {
   1901              case NWK_addr_rsp:
   1902              case IEEE_addr_rsp:
   1903                if ( NULL != (nwkRsp = ZDO_ParseAddrRsp(inMsg)) )
   1904                {
   1905                  if ( nwkRsp->status == ZDO_SUCCESS )
   1906                  {
   1907                    MT_ZdoAddrRspCB( nwkRsp, inMsg->clusterID );
   1908                  }
   1909                  osal_mem_free( nwkRsp );
   1910                }
   1911                break;
   1912          
   1913              case Device_annce:
   1914                ZDO_ParseDeviceAnnce( inMsg, &devAnnce );
   1915                MT_ZdoEndDevAnnceCB( &devAnnce, inMsg->srcAddr.addr.shortAddr );
   1916                break;
   1917          
   1918              case Simple_Desc_rsp:
   1919                if ( pData->cmd.DataLength > 5 )
   1920                {
   1921                  ret = FALSE;
   1922                }
   1923                else
   1924                {
   1925                  doDefault = TRUE;
   1926                }
   1927                break;
   1928          
   1929              default:
   1930                ret = FALSE;
   1931                break;
   1932            }
   1933          
   1934            if ( doDefault )
   1935            {
   1936              ret = FALSE;
   1937              pData->clusterId = MtZdoDef_rsp;
   1938              pData->cmd.DataLength = 2;
   1939            }
   1940          
   1941            return ( ret );
   1942          }
   1943          
   1944          /***************************************************************************************************
   1945           * @fn      MT_ZdoAddrRspCB
   1946           *
   1947           * @brief   Handle IEEE or nwk address response OSAL message from ZDO.
   1948           *
   1949           * @param   pMsg  - Message data
   1950           *
   1951           * @return  void
   1952           */
   1953          void MT_ZdoAddrRspCB( ZDO_NwkIEEEAddrResp_t *pMsg, uint16 clusterID )
   1954          {
   1955            uint8   listLen, len, *pBuf;
   1956          
   1957            /* both ZDO_NwkAddrResp_t and ZDO_IEEEAddrResp_t must be the same */
   1958          
   1959            /* get length, sanity check length */
   1960            listLen = pMsg->numAssocDevs;
   1961          
   1962            /* calculate msg length */
   1963            len = MT_ZDO_ADDR_RSP_LEN + (listLen * sizeof(uint16));
   1964          
   1965            /* get buffer */
   1966            if (NULL != (pBuf = (uint8 *)osal_mem_alloc(len)))
   1967            {
   1968              uint8 id = MT_ZDO_CID_TO_AREQ_ID(clusterID);
   1969              uint8 *pTmp = pBuf;
   1970          
   1971              *pTmp++ = pMsg->status;
   1972          
   1973              osal_cpyExtAddr(pTmp, pMsg->extAddr);
   1974              pTmp += Z_EXTADDR_LEN;
   1975          
   1976              *pTmp++ = LO_UINT16(pMsg->nwkAddr);
   1977              *pTmp++ = HI_UINT16(pMsg->nwkAddr);
   1978          
   1979              *pTmp++ = pMsg->startIndex;
   1980              *pTmp++ = listLen;
   1981          
   1982              MT_Word2Buf(pTmp, pMsg->devList, listLen);
   1983          
   1984              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO), id, len, pBuf);
   1985              osal_mem_free(pBuf);
   1986            }
   1987          }
   1988          
   1989          /***************************************************************************************************
   1990           * @fn      MT_ZdoEndDevAnnceCB
   1991           *
   1992           * @brief   Handle end device announce OSAL message from ZDO.
   1993           *
   1994           * @param   pMsg  - Message data
   1995           *
   1996           * @return  void
   1997           */
   1998          void MT_ZdoEndDevAnnceCB( ZDO_DeviceAnnce_t *pMsg, uint16 srcAddr )
   1999          {
   2000            uint8 *pBuf;
   2001          
   2002            if (NULL != (pBuf = (uint8 *)osal_mem_alloc(MT_ZDO_END_DEVICE_ANNCE_IND_LEN)))
   2003            {
   2004              uint8 *pTmp = pBuf;
   2005          
   2006              *pTmp++ = LO_UINT16(srcAddr);
   2007              *pTmp++ = HI_UINT16(srcAddr);
   2008          
   2009              *pTmp++ = LO_UINT16(pMsg->nwkAddr);
   2010              *pTmp++ = HI_UINT16(pMsg->nwkAddr);
   2011          
   2012              osal_cpyExtAddr(pTmp, pMsg->extAddr);
   2013              pTmp += Z_EXTADDR_LEN;
   2014          
   2015              *pTmp = pMsg->capabilities;
   2016          
   2017              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO),
   2018                                                   MT_ZDO_END_DEVICE_ANNCE_IND,
   2019                                                   MT_ZDO_END_DEVICE_ANNCE_IND_LEN, pBuf);
   2020              osal_mem_free(pBuf);
   2021            }
   2022          }
   2023          
   2024          /***************************************************************************************************
   2025           * @fn      MT_ZdoSrcRtgCB
   2026           *
   2027           * @brief   Handle Src Route from ZDO.
   2028           *
   2029           * @param   pStr  - pointer to the data structure for the src route
   2030           *
   2031           * @return  void*
   2032           */
   2033          void* MT_ZdoSrcRtgCB( void *pStr )
   2034          {
   2035            uint8 len, *pBuf;
   2036            zdoSrcRtg_t *pSrcRtg = pStr;
   2037          
   2038            // srcAddr (2) + relayCnt (1) + relayList( relaycnt * 2 )
   2039            len = 2 + 1 + pSrcRtg->relayCnt * sizeof(uint16);
   2040          
   2041            if (NULL != (pBuf = (uint8 *)osal_mem_alloc(len)))
   2042            {
   2043              uint8 idx, *pTmp = pBuf;
   2044              uint16 *pRelay;
   2045          
   2046              // Packet payload
   2047              *pTmp++ = LO_UINT16(pSrcRtg->srcAddr);
   2048              *pTmp++ = HI_UINT16(pSrcRtg->srcAddr);
   2049              *pTmp++ = pSrcRtg->relayCnt;
   2050          
   2051              // Relay List
   2052              if( ( pRelay = pSrcRtg->pRelayList ) != NULL )
   2053              {
   2054                for( idx = 0; idx < pSrcRtg->relayCnt; idx ++ )
   2055                {
   2056                  *pTmp++ = LO_UINT16(*pRelay);
   2057                  *pTmp++ = HI_UINT16(*pRelay);
   2058                  pRelay++;
   2059                }
   2060              }
   2061              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO),
   2062                                                   MT_ZDO_SRC_RTG_IND, len, pBuf);
   2063              osal_mem_free(pBuf);
   2064            }
   2065          
   2066            return NULL;
   2067          }
   2068          
   2069          /***************************************************************************************************
   2070           * @fn          MT_ZdoConcentratorIndCB
   2071           *
   2072           * @brief       Handle the ZDO Concentrator Indication callback from the ZDO.
   2073           *
   2074           * @param       pStr - pointer to a parameter and a structure of parameters
   2075           *
   2076           * @return      NULL
   2077           ***************************************************************************************************/
   2078          static void *MT_ZdoConcentratorIndCB(void *pStr)
   2079          {
   2080            uint8 buf[MT_ZDO_CONCENTRATOR_IND_LEN], *pTmp = buf;
   2081            zdoConcentratorInd_t *pInd = (zdoConcentratorInd_t *)pStr;
   2082          
   2083            *pTmp++ = LO_UINT16(pInd->nwkAddr);
   2084            *pTmp++ = HI_UINT16(pInd->nwkAddr);
   2085            pTmp = osal_memcpy(pTmp, pInd->extAddr, Z_EXTADDR_LEN);
   2086            *pTmp = pInd->pktCost;
   2087          
   2088            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO),
   2089                                              MT_ZDO_CONCENTRATOR_IND_CB, MT_ZDO_CONCENTRATOR_IND_LEN, buf);
   2090            return NULL;
   2091          }
   2092          
   2093          /***************************************************************************************************
   2094           * @fn          MT_ZdoLeaveInd
   2095           *
   2096           * @brief       Handle the ZDO Leave Indication callback from the ZDO.
   2097           *
   2098           * @param       vPtr - Pointer to the received Leave Indication message.
   2099           *
   2100           * @return      NULL
   2101           ***************************************************************************************************/
   2102          static void *MT_ZdoLeaveInd(void *vPtr)
   2103          {
   2104            NLME_LeaveInd_t *pInd = (NLME_LeaveInd_t *)vPtr;
   2105            uint8 buf[sizeof(NLME_LeaveInd_t)];
   2106          
   2107            buf[0] = LO_UINT16(pInd->srcAddr);
   2108            buf[1] = HI_UINT16(pInd->srcAddr);
   2109            (void)osal_memcpy(buf+2, pInd->extAddr, Z_EXTADDR_LEN);
   2110            buf[2+Z_EXTADDR_LEN] = pInd->request;
   2111            buf[3+Z_EXTADDR_LEN] = pInd->removeChildren;
   2112            buf[4+Z_EXTADDR_LEN] = pInd->rejoin;
   2113          
   2114            MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO),
   2115                                                 MT_ZDO_LEAVE_IND, 5+Z_EXTADDR_LEN, buf);
   2116            return NULL;
   2117          }
   2118          #endif // MT_ZDO_CB_FUNC
   2119          
   2120          /***************************************************************************************************
   2121           * @fn      MT_ZdoSendMsgCB
   2122           *
   2123           * @brief   Proxy the ZDO_SendMsgCBs one message at a time.
   2124           *
   2125           * @param   pMsg  - Message data
   2126           *
   2127           * @return  void
   2128           */

   \                                 In  segment CODE, align 2
   2129          void MT_ZdoSendMsgCB(zdoIncomingMsg_t *pMsg)
   \                     MT_ZdoSendMsgCB:
   2130          {
   \   000000   3B15         PUSHM.W #0x4, R11
   \   000002   0B4C         MOV.W   R12, R11
   2131            uint8 len = pMsg->asduLen + 9;
   \   000004   5A4C1200     MOV.B   0x12(R12), R10
   \   000008   7A500900     ADD.B   #0x9, R10
   2132            uint8 *pBuf = (uint8 *)osal_mem_alloc(len);
   \   00000C   4C4A         MOV.B   R10, R12
   \   00000E   ........     CALLA   #osal_mem_alloc
   \   000012   084C         MOV.W   R12, R8
   2133          
   2134            if (pBuf != NULL)
   \   000014   0C93         CMP.W   #0x0, R12
   \   000016   2C24         JEQ     ??MT_ZdoSendMsgCB_0
   2135            {
   2136              uint8 *pTmp = pBuf;
   2137          
   2138              // Assuming exclusive use of network short addresses.
   2139              *pTmp++ = LO_UINT16(pMsg->srcAddr.addr.shortAddr);
   \   000018   ........     CALLA   #?Subroutine6
   2140              *pTmp++ = HI_UINT16(pMsg->srcAddr.addr.shortAddr);
   2141              *pTmp++ = pMsg->wasBroadcast;
   \                     ??CrossCallReturnLabel_2:
   \   00001C   DC4B0C000000 MOV.B   0xc(R11), 0(R12)
   \   000022   1C53         ADD.W   #0x1, R12
   2142              *pTmp++ = LO_UINT16(pMsg->clusterID);
   \   000024   DC4B0E000000 MOV.B   0xe(R11), 0(R12)
   \   00002A   1C53         ADD.W   #0x1, R12
   2143              *pTmp++ = HI_UINT16(pMsg->clusterID);
   \   00002C   DC4B0F000000 MOV.B   0xf(R11), 0(R12)
   \   000032   1C53         ADD.W   #0x1, R12
   2144              *pTmp++ = pMsg->SecurityUse;
   \   000034   DC4B10000000 MOV.B   0x10(R11), 0(R12)
   \   00003A   1C53         ADD.W   #0x1, R12
   2145              *pTmp++ = pMsg->TransSeq;
   \   00003C   DC4B11000000 MOV.B   0x11(R11), 0(R12)
   \   000042   1C53         ADD.W   #0x1, R12
   2146              // Skipping asduLen since it can be deduced from the RPC packet length.
   2147              *pTmp++ = LO_UINT16(pMsg->macDestAddr);
   \   000044   DC4B14000000 MOV.B   0x14(R11), 0(R12)
   \   00004A   1C53         ADD.W   #0x1, R12
   2148              *pTmp++ = HI_UINT16(pMsg->macDestAddr);
   \   00004C   DC4B15000000 MOV.B   0x15(R11), 0(R12)
   \   000052   1C53         ADD.W   #0x1, R12
   2149              (void)osal_memcpy(pTmp, pMsg->asdu, pMsg->asduLen);
   \   000054   5E4B1200     MOV.B   0x12(R11), R14
   \   000058   1D4B1600     MOV.W   0x16(R11), R13
   \   00005C   ........     CALLA   #osal_memcpy
   2150          
   2151              MT_BuildAndSendZToolResponse(((uint8)MT_RPC_CMD_AREQ | (uint8)MT_RPC_SYS_ZDO),
   2152                                                   MT_ZDO_MSG_CB_INCOMING, len, pBuf);
   \   000060   0F48         MOV.W   R8, R15
   \   000062   4E4A         MOV.B   R10, R14
   \   000064   7D43         MOV.B   #0xff, R13
   \   000066   ........     CALLA   #??Subroutine5_0
   2153          
   2154              osal_mem_free(pBuf);
   \                     ??CrossCallReturnLabel_31:
   \   00006A   0C48         MOV.W   R8, R12
   \   00006C   ........     CALLA   #osal_mem_free
   2155            }
   2156          }
   \                     ??MT_ZdoSendMsgCB_0:
   \   000070   3817         POPM.W  #0x4, R11
   \   000072   1001         RETA
   2157          
   2158          #endif   /*ZDO Command Processing in MT*/
   2159          /***************************************************************************************************
   2160          ***************************************************************************************************/

   Maximum stack usage in bytes:

   CSTACK Function
   ------ --------
     18   MT_ZdoActiveEpRequest
       18   -> MT_BuildAndSendZToolResponse
       18   -> ZDP_NWKAddrOfInterestReq
      8   MT_ZdoBeaconIndCB
        8   -> MT_BuildAndSendZToolResponse
        8   -> osal_mem_alloc
        8   -> osal_mem_free
        8   -> osal_memcpy
     46   MT_ZdoBindRequest
       46   -> MT_BuildAndSendZToolResponse
       46   -> ZDP_BindUnbindReq
       38   -> sAddrExtCpy
      6   MT_ZdoCommandProcessing
        6   -> MT_ZdoActiveEpRequest
        6   -> MT_ZdoBindRequest
        6   -> MT_ZdoComplexDescRequest
        6   -> MT_ZdoEndDevAnnce
        6   -> MT_ZdoEndDevBindRequest
        6   -> MT_ZdoIEEEAddrRequest
        6   -> MT_ZdoJoinReq
        6   -> MT_ZdoMatchDescRequest
        6   -> MT_ZdoNWKAddressRequest
        6   -> MT_ZdoNetworkDiscoveryReq
        6   -> MT_ZdoNodeDescRequest
        6   -> MT_ZdoPowerDescRequest
        6   -> MT_ZdoRegisterForZDOMsg
        6   -> MT_ZdoRemoveRegisteredCB
        6   -> MT_ZdoServiceDiscRequest
        6   -> MT_ZdoSimpleDescRequest
        6   -> MT_ZdoStartupFromApp
        6   -> MT_ZdoUnbindRequest
        6   -> MT_ZdoUserDescRequest
        6   -> MT_ZdoUserDescSet
     18   MT_ZdoComplexDescRequest
       18   -> MT_BuildAndSendZToolResponse
       18   -> ZDP_NWKAddrOfInterestReq
      8   MT_ZdoEndDevAnnce
        8   -> MT_BuildAndSendZToolResponse
        8   -> ZDP_DeviceAnnce
     98   MT_ZdoEndDevBindRequest
       88   -> MT_BuildAndSendZToolResponse
       98   -> ZDP_EndDeviceBindReq
      8   MT_ZdoIEEEAddrRequest
        8   -> MT_BuildAndSendZToolResponse
        8   -> ZDP_IEEEAddrReq
      4   MT_ZdoInit
     12   MT_ZdoJoinCnfCB
       12   -> MT_BuildAndSendZToolResponse
       12   -> ZDO_DeregisterForZdoCB
     14   MT_ZdoJoinReq
       14   -> MT_BuildAndSendZToolResponse
       14   -> ZDApp_JoinReq
       14   -> ZDO_RegisterForZdoCB
    100   MT_ZdoMatchDescRequest
       92   -> MT_BuildAndSendZToolResponse
      100   -> ZDP_MatchDescReq
      8   MT_ZdoNWKAddressRequest
        8   -> MT_BuildAndSendZToolResponse
        8   -> ZDP_NwkAddrReq
     10   MT_ZdoNetworkDiscoveryReq
       10   -> MT_BuildAndSendZToolResponse
       10   -> ZDApp_NetworkDiscoveryReq
       10   -> ZDO_RegisterForZdoCB
       10   -> osal_build_uint32
     18   MT_ZdoNodeDescRequest
       18   -> MT_BuildAndSendZToolResponse
       18   -> ZDP_NWKAddrOfInterestReq
      6   MT_ZdoNwkDiscoveryCnfCB
        6   -> MT_BuildAndSendZToolResponse
        6   -> MT_ZdoBeaconIndCB
        6   -> ZDO_DeregisterForZdoCB
     18   MT_ZdoPowerDescRequest
       18   -> MT_BuildAndSendZToolResponse
       18   -> ZDP_NWKAddrOfInterestReq
     10   MT_ZdoRegisterForZDOMsg
       10   -> MT_BuildAndSendZToolResponse
       10   -> ZDO_RegisterForZDOMsg
     10   MT_ZdoRemoveRegisteredCB
       10   -> MT_BuildAndSendZToolResponse
       10   -> ZDO_RemoveRegisteredCB
     12   MT_ZdoSendMsgCB
       12   -> MT_BuildAndSendZToolResponse
       12   -> osal_mem_alloc
       12   -> osal_mem_free
       12   -> osal_memcpy
      8   MT_ZdoServiceDiscRequest
        8   -> MT_BuildAndSendZToolResponse
        8   -> ZDP_ServerDiscReq
     18   MT_ZdoSimpleDescRequest
       18   -> MT_BuildAndSendZToolResponse
       18   -> ZDP_SimpleDescReq
     10   MT_ZdoStartupFromApp
       10   -> MT_BuildAndSendZToolResponse
       10   -> ZDOInitDevice
     46   MT_ZdoUnbindRequest
       46   -> MT_BuildAndSendZToolResponse
       46   -> ZDP_BindUnbindReq
       38   -> sAddrExtCpy
     18   MT_ZdoUserDescRequest
       18   -> MT_BuildAndSendZToolResponse
       18   -> ZDP_NWKAddrOfInterestReq
     36   MT_ZdoUserDescSet
       36   -> MT_BuildAndSendZToolResponse
       36   -> ZDP_UserDescSet
       36   -> osal_memcpy


   Segment part sizes:

   Bytes  Function/Label
   -----  --------------
       8  ??Subroutine21_0
      12  ??Subroutine22_0
      12  ??Subroutine23_0
       8  ??Subroutine5_0
       4  ??Subroutine7_0
       4  ??Subroutine7_1
       8  ?Subroutine0
      24  ?Subroutine1
      20  ?Subroutine10
       6  ?Subroutine12
      10  ?Subroutine13
      10  ?Subroutine14
      10  ?Subroutine15
      10  ?Subroutine16
      14  ?Subroutine17
      28  ?Subroutine2
      10  ?Subroutine3
      22  ?Subroutine4
      20  ?Subroutine5
      18  ?Subroutine6
       4  ?Subroutine7
      24  ?Subroutine8
      78  ?Subroutine9
      16  MT_ZdoActiveEpRequest
     242  MT_ZdoBeaconIndCB
      42  MT_ZdoBindRequest
     222  MT_ZdoCommandProcessing
      16  MT_ZdoComplexDescRequest
      38  MT_ZdoEndDevAnnce
     222  MT_ZdoEndDevBindRequest
      36  MT_ZdoIEEEAddrRequest
       2  MT_ZdoInit
      68  MT_ZdoJoinCnfCB
      94  MT_ZdoJoinReq
     188  MT_ZdoMatchDescRequest
      30  MT_ZdoNWKAddressRequest
      74  MT_ZdoNetworkDiscoveryReq
      14  MT_ZdoNodeDescRequest
      42  MT_ZdoNwkDiscoveryCnfCB
      14  MT_ZdoPowerDescRequest
      14  MT_ZdoRegisterForZDOMsg
      14  MT_ZdoRemoveRegisteredCB
     116  MT_ZdoSendMsgCB
      30  MT_ZdoServiceDiscRequest
      24  MT_ZdoSimpleDescRequest
      20  MT_ZdoStartupFromApp
      40  MT_ZdoUnbindRequest
      16  MT_ZdoUserDescRequest
      90  MT_ZdoUserDescSet
       4  _zdoCallbackSub
       2  pBeaconIndBuf

 
 2 088 bytes in segment CODE
     6 bytes in segment DATA16_Z
 
 2 088 bytes of CODE memory
     6 bytes of DATA memory

Errors: none
Warnings: none
